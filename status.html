<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UltraWatch Status</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background: rgba(255,255,255,0.07); border-radius: 16px; padding: 16px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .label { font-size: 12px; opacity: 0.8; }
    .value { font-size: 22px; font-weight: 700; margin-top: 4px; }
    .status { margin-top: 14px; padding: 14px; border-radius: 14px; text-align:center; font-size: 20px; font-weight: 800; }
    .good { background:#0f7a3a; }
    .check { background:#b8860b; }
    .emergency { background:#b42318; }
    textarea { width:100%; min-height: 90px; border-radius: 12px; padding: 10px; }
    button, select { border-radius: 12px; padding: 10px 12px; font-weight: 700; }
    @media (max-width: 560px) { .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="label">Person</div>
      <select id="personSelect">
        <option value="Grammie">Grammie</option>
        <option value="GRANDPA">GRANDPA</option>
      </select>

      <div class="row">
        <div>
          <div class="label">Name</div>
          <div class="value" id="nameVal">—</div>
        </div>
        <div>
          <div class="label">Current Time</div>
          <div class="value" id="nowVal">—</div>
        </div>
        <div>
          <div class="label">Current Room</div>
          <div class="value" id="roomVal">—</div>
        </div>
        <div>
          <div class="label">Time in Room</div>
          <div class="value" id="timeInRoomVal">—</div>
        </div>
      </div>

      <div id="statusBox" class="status good">GOOD</div>

      <div style="margin-top:14px;">
        <div class="label">Notes</div>
        <textarea id="notesBox"></textarea>
        <div style="margin-top:10px; display:flex; gap:10px;">
          <button id="saveNotesBtn">Save Notes</button>
          <button id="clearNotesBtn">Clear Notes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      databaseURL: "https://ultrawatch-home-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Seconds before we show CHECK (yellow) for staying too long in a room
    const CHECK_THRESHOLDS = {
      "Bathroom": 60 * 60,        // 60 minutes
      "Kitchen": 4 * 60 * 60,     // 4 hours
      "Living Room": 4 * 60 * 60,
      "Bedroom": 10 * 60 * 60,
      "FrontDoor": 10 * 60        // 10 minutes
      // Pool is handled as Emergency via /alerts/GRANDPA/pool
    };

    const els = {
      person: document.getElementById("personSelect"),
      nameVal: document.getElementById("nameVal"),
      nowVal: document.getElementById("nowVal"),
      roomVal: document.getElementById("roomVal"),
      timeInRoomVal: document.getElementById("timeInRoomVal"),
      statusBox: document.getElementById("statusBox"),
      notesBox: document.getElementById("notesBox"),
      saveNotes: document.getElementById("saveNotesBtn"),
      clearNotes: document.getElementById("clearNotesBtn")
    };

    // Remember last selected person (optional polish)
    const savedPerson = localStorage.getItem("uw_person");
    if (savedPerson && [...els.person.options].some(o => o.value === savedPerson)) {
      els.person.value = savedPerson;
    }

    let current = { name: els.person.value, room:"", enteredAt:null, alerts:{} };

    function setStatus(cls, text) {
      els.statusBox.className = "status " + cls;
      els.statusBox.textContent = text;
    }

    function refresh() {
      els.nameVal.textContent = current.name;
      els.roomVal.textContent = current.room || "—";
      els.nowVal.textContent = new Date().toLocaleTimeString();

      if (current.enteredAt) {
        const sec = Math.floor(Date.now()/1000) - current.enteredAt;
        els.timeInRoomVal.textContent = sec + "s";
      } else {
        els.timeInRoomVal.textContent = "—";
      }

      // 1) EMERGENCY rules (red)
      if (current.alerts?.sos === true) {
        setStatus("emergency", "EMERGENCY (SOS)");
        return;
      }
      if (current.alerts?.pool === true) {
        setStatus("emergency", "EMERGENCY (POOL)");
        return;
      }

      // 2) CHECK rules (yellow) based on time-in-room thresholds
      const threshold = CHECK_THRESHOLDS[current.room];
      if (threshold && current.enteredAt) {
        const dwellSec = Math.floor(Date.now() / 1000) - current.enteredAt;
        if (dwellSec >= threshold) {
          setStatus("check", "CHECK");
          return;
        }
      }

      // 3) Otherwise GOOD (green)
      setStatus("good", "GOOD");
    }

    // Track active Firebase refs so we can unsubscribe when switching people
    let beaconsRef = null;
    let alertsRef = null;
    let notesRef = null;

    function subscribe(name) {
      // Unsubscribe old listeners
      if (beaconsRef) beaconsRef.off();
      if (alertsRef) alertsRef.off();
      if (notesRef) notesRef.off();

      current = { name, room:"", enteredAt:null, alerts:{} };
      refresh(); // update UI immediately when switching

      beaconsRef = db.ref("/beacons/" + name);
      alertsRef  = db.ref("/alerts/" + name);
      notesRef   = db.ref("/status/" + name + "/notes");

      beaconsRef.on("value", s => {
        const v = s.val() || {};
        current.room = v.room || "";
        current.enteredAt = v.entered_at || null;
        refresh();
      });

      alertsRef.on("value", s => {
        current.alerts = s.val() || {};
        refresh();
      });

      notesRef.on("value", s => {
        els.notesBox.value = s.val() || "";
      });
    }

    els.saveNotes.onclick = () =>
      db.ref("/status/" + current.name + "/notes").set(els.notesBox.value || "");

    els.clearNotes.onclick = () =>
      db.ref("/status/" + current.name + "/notes").set("");

    els.person.onchange = () => {
      localStorage.setItem("uw_person", els.person.value);
      subscribe(els.person.value);
    };

    setInterval(refresh, 1000);
    subscribe(current.name);
  </script>
</body>
</html>
