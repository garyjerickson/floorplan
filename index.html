<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UltraWatch Floorplan</title>
  <!-- Styles and layout unchanged for brevity -->
</head>
<body>
  <!-- Floorplan layout and toggle button -->
  <div id="linger-popup">
    ⚠️ Grammie has been in <span id="linger-room"></span> for <span id="linger-duration"></span> — please check on her!
    <br><br>
    <button onclick="dismissLingerAlert()">Dismiss</button>
  </div>

  <!-- Scripts -->
  <script>
    const timers = {
      "Grammie": { el: dotGrammie.querySelector(".timer"), start: 0 }
    };

    function getRoomLimit(room) {
      const hour = new Date().getHours();
      const isNight = hour >= 22 || hour < 7;
      const limits = {
        "Bedroom": isNight ? 10 : 4,
        "Bathroom": 2,
        "Kitchen": 4,
        "Living Room": 4,
        "FrontDoor": 1
      };
      return (limits[room] || 4) * 3600 * 1000; // default to 4 hours if undefined
    }

    function checkLinger(room, since) {
      const now = Date.now();
      const limit = getRoomLimit(room);
      if (now - since > limit) {
        const duration = now - since;
        const h = Math.floor(duration / 3600000);
        const m = Math.floor((duration % 3600000) / 60000);
        document.getElementById("linger-room").textContent = room;
        document.getElementById("linger-duration").textContent = `${h}h ${m}m`;
        document.getElementById("linger-popup").style.display = "block";
      } else {
        document.getElementById("linger-popup").style.display = "none";
      }
    }

    function dismissLingerAlert() {
      document.getElementById("linger-popup").style.display = "none";
    }

    let grammieRoom = null;
    let grammieRoomSince = 0;

    db.ref("beacons/Grammie").on("value", (snapshot) => {
      const data = snapshot.val();
      if (data && data.room && data.entered_at) {
        grammieRoom = data.room;
        grammieRoomSince = data.entered_at * 1000;
        moveDot(dotGrammie, grammieRoom, -40);
        startTimer("Grammie", data.entered_at);
      }
    });

    setInterval(() => {
      if (grammieRoom && grammieRoomSince) {
        checkLinger(grammieRoom, grammieRoomSince);
      }
    }, 10000);
  </script>
</body>
</html>
