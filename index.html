import paho.mqtt.client as mqtt
import json
import time
from collections import defaultdict, deque
import firebase_admin
from firebase_admin import credentials, db

# ==== Firebase Setup ====
cred = credentials.Certificate("firebase-key.json")
firebase_admin.initialize_app(cred, {
    "databaseURL": "https://ultrawatchfloorplan-default-rtdb.firebaseio.com/"
})

# ==== MQTT Settings ====
BROKER = "localhost"
PORT = 1883
TOPIC = "#"

# ==== Gateway MAC ‚Üí Room ====
room_map = {
    "B0B21C863204": "Living Room",
    "B0B21C8631C4": "Bedroom",
    "B0B21C8631EC": "Kitchen",
    "B0B21CA68C0C": "Bathroom",
    "08B61F77BEB0": "FrontDoor"
}

# ==== Beacons to Track ====
watched_beacons = {
    "D490B297D096": "Grammie",
    "CDB7DA7557A6": "Axel"
}

# ==== RSSI Handling ====
rssi_history = defaultdict(lambda: defaultdict(lambda: deque(maxlen=10)))
last_seen = defaultdict(float)
last_reported = defaultdict(float)
last_known_room = dict()  # beacon_mac ‚Üí last room
REPORT_INTERVAL = 5  # seconds

# ==== MQTT Callbacks ====
def on_connect(client, userdata, flags, rc):
    print("Connected to MQTT broker.")
    client.subscribe(TOPIC)

def on_message(client, userdata, msg):
    try:
        payload = json.loads(msg.payload.decode())
        gateway_mac = payload.get("device_info", {}).get("mac", "").upper()

        topic_parts = msg.topic.strip("/").split("/")
        if len(topic_parts) >= 3 and not gateway_mac:
            gateway_mac = topic_parts[2].upper()

        data_list = payload.get("data", [])
        if not isinstance(data_list, list):
            return

        for entry in data_list:
            beacon_mac = entry.get("mac", "").upper()
            rssi = entry.get("rssi")

            if beacon_mac in watched_beacons and rssi is not None:
                rssi_history[beacon_mac][gateway_mac].append(rssi)
                last_seen[beacon_mac] = time.time()
    except Exception as e:
        print("Error parsing message:", e)

# ==== Beacon Analysis + Firebase Update ====
def analyze_positions():
    now = time.time()
    for beacon_mac, beacon_name in watched_beacons.items():
        if beacon_mac in rssi_history and now - last_reported[beacon_mac] >= REPORT_INTERVAL:
            avg_rssi_per_gateway = {}
            for gw_mac, rssi_list in rssi_history[beacon_mac].items():
                if rssi_list:
                    avg_rssi = sum(rssi_list) / len(rssi_list)
                    avg_rssi_per_gateway[gw_mac] = avg_rssi

            if avg_rssi_per_gateway:
                strongest_gateway = max(avg_rssi_per_gateway, key=avg_rssi_per_gateway.get)
                room = room_map.get(strongest_gateway, "Unknown Room")

                # Only update if room has changed
                if last_known_room.get(beacon_mac) != room:
                    last_known_room[beacon_mac] = room
                    db.reference(f"/beacons/{beacon_name}").set({
                        "room": room,
                        "entered_at": int(now)
                    })
                    print(f"üìç {beacon_name} moved to {room}")
                    last_reported[beacon_mac] = now

# ==== MQTT Client Setup ====
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message

client.connect(BROKER, PORT, 60)
client.loop_start()

# ==== Run Main Loop ====
try:
    while True:
        analyze_positions()
        time.sleep(1)
except KeyboardInterrupt:
    client.loop_stop()
    client.disconnect()
    print("Stopped.")
