<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UltraWatch - Client Status</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .header { display:flex; justify-content:space-between; align-items:flex-end; gap:16px; margin-bottom: 12px; }
    h1 { margin:0; font-size: 22px; }
    .sub { opacity:.8; font-size: 13px; }
    .card { background: rgba(255,255,255,0.07); border-radius: 16px; padding: 14px; }
    .table { width:100%; border-collapse: separate; border-spacing: 0 10px; }
    .row { background: rgba(255,255,255,0.06); border-radius: 14px; overflow:hidden; }
    .row td { padding: 12px 12px; vertical-align: middle; }
    .name { font-weight: 800; font-size: 16px; }
    .small { opacity: .85; font-size: 12px; margin-top: 3px; }
    .badge { display:inline-block; padding: 8px 10px; border-radius: 999px; font-weight: 900; letter-spacing: .3px; }
    .good { background:#0f7a3a; }
    .check { background:#b8860b; color:#fff7db; }
    .emergency { background:#b42318; }
    .offline { background: rgba(255,255,255,0.12); color:#c9d3ee; }
    .away { background: rgba(120,140,255,0.18); color:#dbe2ff; }
    .muted { opacity:.75; }
    .right { text-align:right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    button { border-radius: 12px; padding: 8px 10px; font-weight: 800; }

    .rowOffline { opacity: 0.55; filter: grayscale(100%); }

    .statusBadge { display:inline-block; padding:6px 10px; border-radius:12px; font-weight:900; letter-spacing:.3px; }
    .statusBadge.green { background: rgba(0,255,0,0.15); color:#7CFF7C; }
    .statusBadge.gray  { background: rgba(255,255,255,0.10); color:#B8C0D9; }
    .statusLine { display:flex; gap:10px; align-items:center; justify-content:flex-end; }

    .err { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(180,35,24,0.18); color: #ffd2cd; display:none; }

    /* NEW: make live rows feel clickable */
    .row.clickable { cursor: pointer; }
    .row.clickable:hover { outline: 2px solid rgba(255,255,255,0.10); }

    /* NEW: history panel */
    .historyWrap {
      margin-top: 12px;
      background: rgba(255,255,255,0.07);
      border-radius: 16px;
      padding: 12px;
      display: none;
    }
    .historyHead {
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
    }
    .historyTitle {
      font-weight: 900;
      font-size: 15px;
    }
    .historyList {
      display: grid;
      gap: 10px;
    }
    .histRow {
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .histTop {
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap:10px;
    }
    .histRoom { font-weight: 900; }
    .histDur { font-weight: 900; opacity: .95; }
    .histMeta { margin-top: 4px; font-size: 12px; opacity: .85; }
    .histMeta .mono { opacity: .95; }

    @media (max-width: 720px) {
      .hide-mobile { display:none; }
      .right { text-align:left; }
      .statusLine { justify-content:flex-start; margin-top:10px; }
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="header">
      <div>
        <h1>UltraWatch Client Status</h1>
        <div class="sub">One-line overview for all monitored clients</div>
        <div class="sub mono">Build: 2025-12-24 08:30</div>      
        <div class="sub" style="margin-top:8px;">
          <button id="enableSoundBtn">Enable Sound</button>
          <span class="muted" id="soundStatus" style="margin-left:10px;">Sound: off</span>
        </div>
        <div class="err mono" id="errBox"></div>
      </div>

      <div>
        <div class="statusLine">
          <div id="systemStatus" class="statusBadge gray">OFFLINE</div>
          <div class="sub mono" id="dataAge">Data age: --</div>
          <div class="sub mono" id="updateCount">Updates: 0</div>
        </div>
        <div class="sub mono" id="clock" style="margin-top:6px;">--:--:--</div>
      </div>
    </div>

    <div class="card" id="mainCard">
      <table class="table" id="clientTable">
        <thead class="muted">
          <tr>
            <td>Client</td>
            <td>Status</td>
            <td class="hide-mobile">Notes</td>
            <td class="right">Caretaker</td>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <!-- NEW: History panel -->
      <div class="historyWrap" id="historyWrap">
        <div class="historyHead">
          <div class="historyTitle" id="historyTitle">History</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <span class="sub mono" id="historyStatus"></span>
            <button id="historyCloseBtn">Close</button>
          </div>
        </div>
        <div class="historyList" id="historyList"></div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  (function () {
    const errBox = document.getElementById("errBox");
    function showError(msg) {
      errBox.style.display = "block";
      errBox.textContent = "JS ERROR: " + msg;
    }

    try {
      const firebaseConfig = { databaseURL: "https://ultrawatch-home-default-rtdb.firebaseio.com/" };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ===== Audible Alarm =====
      let soundEnabled = false;
      const alarmAudio = new Audio("alarm.mp3");
      alarmAudio.loop = true;

      function startAlarm() {
        if (!soundEnabled) return;
        if (alarmAudio.paused) {
          alarmAudio.currentTime = 0;
          alarmAudio.play().catch(() => console.log("Alarm blocked until user interaction"));
        }
      }
      function stopAlarm() {
        if (!alarmAudio.paused) {
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
        }
      }

      const enableBtn = document.getElementById("enableSoundBtn");
      const soundStatus = document.getElementById("soundStatus");
      enableBtn.onclick = async () => {
        try {
          soundEnabled = true;
          alarmAudio.currentTime = 0;
          await alarmAudio.play();
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
          soundStatus.textContent = "Sound: on";
        } catch (e) {
          soundStatus.textContent = "Sound: blocked (tap again)";
        }
      };

      function clearAlerts(firebaseKey) {
        if (!firebaseKey) return;
        db.ref("/alerts/" + firebaseKey).update({
          sos: false,
          pool: false,
          timestamp: Math.floor(Date.now() / 1000)
        });
      }

      // ✅ ONE clients list (full)
      const clients = [
        { displayName: "Christine", firebaseKey: "Grammie", caretakerName: "Laura Simmons", caretakerPhone: "(407) 555-0127" },
        { displayName: "Jack",      firebaseKey: "GRANDPA", caretakerName: "Mark Delaney", caretakerPhone: "(321) 555-0188" },

        { displayName: "Evelyn", caretakerName: "Dana Price", caretakerPhone: "(813) 555-0141", demoStatus: "GOOD", demoNote: "Living Room routine" },
        { displayName: "Harold", caretakerName: "Trent Wallace", caretakerPhone: "(352) 555-0194", demoStatus: "CHECK", demoNote: "Bathroom dwell > threshold" },
        { displayName: "Marjorie", caretakerName: "Sofia Ramos", caretakerPhone: "(954) 555-0103", demoStatus: "GOOD", demoNote: "Kitchen – normal" },
        { displayName: "Walter", caretakerName: "Chris Bennett", caretakerPhone: "(305) 555-0177", demoStatus: "EMERGENCY", demoNote: "SOS triggered" },
        { displayName: "Dolores", caretakerName: "Priya Nair", caretakerPhone: "(239) 555-0138", demoStatus: "GOOD", demoNote: "Bedroom – resting" },
        { displayName: "Frank", caretakerName: "Ethan Cole", caretakerPhone: "(727) 555-0160", demoStatus: "CHECK", demoNote: "Not seen (signal lost)" },
        { displayName: "Helen", caretakerName: "Maya Johnson", caretakerPhone: "(386) 555-0119", demoStatus: "GOOD", demoNote: "FrontDoor – brief visit" },
        { displayName: "Robert", caretakerName: "Noah Kim", caretakerPhone: "(561) 555-0155", demoStatus: "GOOD", demoNote: "Living Room – TV time" },
        { displayName: "Patricia", caretakerName: "Ava Martinez", caretakerPhone: "(904) 555-0199", demoStatus: "CHECK", demoNote: "Kitchen linger" },
        { displayName: "Stanley", caretakerName: "Jordan Lee", caretakerPhone: "(850) 555-0108", demoStatus: "GOOD", demoNote: "All clear" },
        { displayName: "Ruth", caretakerName: "Olivia Chen", caretakerPhone: "(863) 555-0120", demoStatus: "GOOD", demoNote: "Bathroom – normal" },
        { displayName: "George", caretakerName: "Sam Harper", caretakerPhone: "(941) 555-0184", demoStatus: "EMERGENCY", demoNote: "Pool alarm" },
        { displayName: "Irene", caretakerName: "Taylor Fox", caretakerPhone: "(407) 555-0150", demoStatus: "GOOD", demoNote: "Bedroom – asleep" },
        { displayName: "Bernard", caretakerName: "Casey Stone", caretakerPhone: "(321) 555-0171", demoStatus: "CHECK", demoNote: "Not seen > 2m" }
      ];

      const tbody = document.getElementById("tbody");

      function statusClassFromText(t) {
        const s = (t || "").toUpperCase();
        if (s.includes("EMERGENCY")) return "emergency";
        if (s.includes("CHECK") || s.includes("NOT SEEN")) return "check";
        return "good";
      }

      function formatDuration(seconds) {
        const s = Math.max(0, Math.floor(seconds || 0));
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        if (h > 0) return `${h}:${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
        return `${m}:${String(sec).padStart(2,"0")}`;
      }

      function formatDateTime(ts) {
        if (!ts) return "--";
        return new Date(ts * 1000).toLocaleString();
      }

      function badgeTextFromState(state) {
        const kind = state.kind || "good";
        if (kind === "emergency") return "EMERGENCY";
        if (kind === "away") return "AWAY";
        if (kind === "offline") return "OFFLINE";
        if (kind === "check") return state.text || "CHECK";
        return "GOOD";
      }

      function makeRow(id, client, state) {
        const tr = document.createElement("tr");
        tr.className = "row" + (client.firebaseKey ? " clickable" : "");
        tr.id = id;
        if (client.firebaseKey) tr.dataset.firebaseKey = client.firebaseKey;

        const kind = state.kind || "good";
        tr.innerHTML = `
          <td>
            <div class="name">${client.displayName}</div>
            <div class="small muted">${client.firebaseKey ? "Live (Firebase) — click for history" : "Demo"}</div>
          </td>
          <td><span class="badge ${kind}">${badgeTextFromState(state)}</span></td>
          <td class="hide-mobile"><span class="muted">${state.note || ""}</span></td>
          <td class="right">
            <div><strong>${client.caretakerName || ""}</strong></div>
            <div class="small mono muted">${client.caretakerPhone || ""}</div>
            ${client.firebaseKey ? `<div style="margin-top:8px;"><button data-clear="${client.firebaseKey}">Clear</button></div>` : ``}
          </td>
        `;
        return tr;
      }

      // Initial render
      clients.forEach((c, idx) => {
        const id = `row_${idx}`;
        const state = c.firebaseKey
          ? { kind: "check", text: "LOADING", note: "Waiting for data…" }
          : { kind: statusClassFromText(c.demoStatus), text: c.demoStatus, note: c.demoNote || "" };
        tbody.appendChild(makeRow(id, c, state));
      });

      // Clear button clicks
      document.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-clear]");
        if (!btn) return;
        e.stopPropagation(); // NEW: don't trigger row click
        clearAlerts(btn.getAttribute("data-clear"));
      });

      function updateRowForClient(idx, state) {
        const row = document.getElementById(`row_${idx}`);
        if (!row) return;

        const kind = state.kind || "good";
        const badge = row.querySelector(".badge");
        badge.className = "badge " + kind;
        badge.textContent = badgeTextFromState(state);

        const noteCell = row.querySelector(".hide-mobile .muted");
        if (noteCell) noteCell.textContent = state.note || "";

        if (kind === "offline") row.classList.add("rowOffline");
        else row.classList.remove("rowOffline");
      }

      const CHECK_THRESHOLDS = {
        "Bathroom": 60 * 60,
        "Kitchen": 4 * 60 * 60,
        "Living Room": 4 * 60 * 60,
        "Bedroom": 10 * 60 * 60,
        "Front Door": 10 * 60
      };

      const BEACON_OFFLINE_SECONDS = 12;
      const AWAY_IF_LAST_ROOM = "Front Door";
      const liveState = {}; // firebaseKey -> {room, entered_at, alerts, last_seen}

      function computeState(displayName, firebaseKey) {
        const v = liveState[firebaseKey] || {};
        const room = v.room || "";
        const enteredAt = v.entered_at || null;
        const alerts = v.alerts || {};
        const lastSeen = v.last_seen || 0;

        const nowSec = Math.floor(Date.now()/1000);
        const dwell = (enteredAt && enteredAt > 0) ? (nowSec - enteredAt) : 0;
        const dwellStr = enteredAt ? formatDuration(dwell) : "--:--";

        const offline = (!lastSeen) || ((nowSec - lastSeen) > BEACON_OFFLINE_SECONDS);
        if (offline) {
          const age = lastSeen ? (nowSec - lastSeen) : null;

          if (room === AWAY_IF_LAST_ROOM) {
            return {
              kind: "away",
              text: "AWAY",
              note: `Left from ${room}${enteredAt ? ` • was there ${dwellStr}` : ""}${age === null ? "" : ` • last seen ${age}s ago`}`
            };
          }

          return {
            kind: "offline",
            text: "OFFLINE",
            note: age === null
              ? "No signal yet"
              : `${room ? (room + " • ") : ""}No signal (${age}s)${enteredAt && room ? ` • was there ${dwellStr}` : ""}`
          };
        }

        if (alerts.sos === true) return { kind: "emergency", text: "EMERGENCY", note: `SOS triggered${room ? " • " + room : ""}` };
        if (alerts.pool === true) return { kind: "emergency", text: "EMERGENCY", note: `Pool alarm${room ? " • " + room : ""}` };

        if (!room) return { kind: "check", text: displayName + " NOT SEEN", note: "No room reported" };

        const threshold = CHECK_THRESHOLDS[room];
        if (threshold && enteredAt) {
          if (dwell >= threshold) return { kind: "check", text: "CHECK", note: `${room} • ${dwellStr} • dwell exceeded` };
        }

        return { kind: "good", text: "GOOD", note: `${room} • ${dwellStr}` };
      }

      function evaluateAnyEmergencyAndSound() {
        let anyEmergency = false;
        clients.forEach((c) => {
          if (!c.firebaseKey) return;
          const v = liveState[c.firebaseKey] || {};
          const alerts = v.alerts || {};
          if (alerts.sos === true || alerts.pool === true) anyEmergency = true;
        });
        if (anyEmergency) startAlarm();
        else stopAlarm();
      }

      // System badge based on /system/lastDataRx
      let lastDataRx = 0;
      let dataUpdateCount = 0;
      const STALE_SECONDS = 8;

      const systemStatusEl = document.getElementById("systemStatus");
      const dataAgeEl = document.getElementById("dataAge");
      const updateCountEl = document.getElementById("updateCount");

      db.ref("/system/lastDataRx").on("value", (snap) => {
        lastDataRx = snap.val() || 0;
        dataUpdateCount++;
        updateCountEl.textContent = "Updates: " + dataUpdateCount;
      });

      function refreshSystemBadge() {
        const now = Math.floor(Date.now() / 1000);
        const age = lastDataRx ? (now - lastDataRx) : null;
        const stale = (age === null) || (age > STALE_SECONDS);

        dataAgeEl.textContent = "Data age: " + (age === null ? "--" : (age + "s"));

        if (stale) {
          systemStatusEl.textContent = "OFFLINE";
          systemStatusEl.classList.remove("green");
          systemStatusEl.classList.add("gray");
        } else {
          systemStatusEl.textContent = "ONLINE";
          systemStatusEl.classList.remove("gray");
          systemStatusEl.classList.add("green");
        }
      }

      // ======================
      // NEW: History UI + loader
      // ======================
      const historyWrap = document.getElementById("historyWrap");
      const historyTitle = document.getElementById("historyTitle");
      const historyStatus = document.getElementById("historyStatus");
      const historyList = document.getElementById("historyList");
      const historyCloseBtn = document.getElementById("historyCloseBtn");

      historyCloseBtn.onclick = () => {
        historyWrap.style.display = "none";
        historyTitle.textContent = "History";
        historyStatus.textContent = "";
        historyList.innerHTML = "";
      };

      function setHistoryLoading(clientLabel) {
        historyWrap.style.display = "block";
        historyTitle.textContent = `${clientLabel} — Last 10 rooms`;
        historyStatus.textContent = "Loading…";
        historyList.innerHTML = "";
      }

      function renderHistory(clientLabel, rows) {
        historyWrap.style.display = "block";
        historyTitle.textContent = `${clientLabel} — Last 10 rooms`;
        historyStatus.textContent = rows.length ? `${rows.length} record(s)` : "No history yet";
        historyList.innerHTML = "";

        if (!rows.length) {
          historyList.innerHTML = `<div class="histRow"><div class="muted">No history found.</div></div>`;
          return;
        }

        rows.forEach((x) => {
          const room = x.room || "—";

          // New interval format
          const enteredAt = x.entered_at || null;
          const exitedAt  = x.exited_at  || null;
          const durSec    = x.duration_sec || 0;

          // Legacy format (your old logs)
          const legacyTs = x.timestamp || null;

          let durText = "";
          let meta = "";

          if (enteredAt && exitedAt) {
            durText = formatDuration(durSec);
            meta = `Entered: <span class="mono">${formatDateTime(enteredAt)}</span> • Exited: <span class="mono">${formatDateTime(exitedAt)}</span>`;
          } else if (legacyTs) {
            durText = "(legacy)";
            meta = `Time: <span class="mono">${formatDateTime(legacyTs)}</span>`;
          } else {
            durText = "--:--";
            meta = `<span class="muted">Incomplete record</span>`;
          }

          const div = document.createElement("div");
          div.className = "histRow";
          div.innerHTML = `
            <div class="histTop">
              <div class="histRoom">${room}</div>
              <div class="histDur">${durText}</div>
            </div>
            <div class="histMeta">${meta}</div>
          `;
          historyList.appendChild(div);
        });
      }

      function loadHistory(firebaseKey, clientLabel) {
        if (!firebaseKey) return;

        setHistoryLoading(clientLabel);

        db.ref("/logs/" + firebaseKey)
          .limitToLast(10)
          .once("value")
          .then((snap) => {
            const rows = [];
            snap.forEach((child) => rows.push(child.val() || {}));

            // Sort newest-first:
            // Prefer exited_at, else entered_at, else timestamp
            rows.sort((a, b) => {
              const at = (a.exited_at || a.entered_at || a.timestamp || 0);
              const bt = (b.exited_at || b.entered_at || b.timestamp || 0);
              return bt - at;
            });

            renderHistory(clientLabel, rows);
          })
          .catch((e) => {
            historyWrap.style.display = "block";
            historyTitle.textContent = `${clientLabel} — Last 10 rooms`;
            historyStatus.textContent = "Error";
            historyList.innerHTML = `<div class="histRow"><div class="muted">Failed to load history: ${String(e && e.message ? e.message : e)}</div></div>`;
          });
      }

      // Row click → open history (ignore demo rows)
// Row click → open history (attach to tbody so it always works)
tbody.addEventListener("click", (e) => {
  const row = e.target.closest("tr.row.clickable");
  if (!row) return;

  // Ignore clicks on the Clear button (handled separately)
  if (e.target.closest("button")) return;

  const firebaseKey = row.dataset.firebaseKey;
  const idx = parseInt(row.id.replace("row_", ""), 10);
  const client = clients[idx];

  if (!firebaseKey || !client) return;

  loadHistory(firebaseKey, client.displayName);
});


      // ======================
      // Subscribe live clients
      // ======================
      clients.forEach((c, idx) => {
        if (!c.firebaseKey) return;

        db.ref("/beacons/" + c.firebaseKey).on("value", snap => {
          const val = snap.val() || {};
          liveState[c.firebaseKey] = liveState[c.firebaseKey] || {};
          liveState[c.firebaseKey].room = val.room || "";
          liveState[c.firebaseKey].entered_at = val.entered_at || null;
          liveState[c.firebaseKey].last_seen = val.last_seen || 0;

          updateRowForClient(idx, computeState(c.displayName, c.firebaseKey));
        });

        db.ref("/alerts/" + c.firebaseKey).on("value", snap => {
          const val = snap.val() || {};
          liveState[c.firebaseKey] = liveState[c.firebaseKey] || {};
          liveState[c.firebaseKey].alerts = val || {};
          updateRowForClient(idx, computeState(c.displayName, c.firebaseKey));
          evaluateAnyEmergencyAndSound();
        });
      });

      function tick() {
        document.getElementById("clock").textContent = new Date().toLocaleString();
        clients.forEach((c, idx) => {
          if (!c.firebaseKey) return;
          updateRowForClient(idx, computeState(c.displayName, c.firebaseKey));
        });
        evaluateAnyEmergencyAndSound();
        refreshSystemBadge();
      }

      setInterval(tick, 1000);
      tick();

    } catch (e) {
      showError(e && e.message ? e.message : String(e));
      console.error(e);
    }
  })();
  </script>
</body>
</html>
