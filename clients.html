<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UltraWatch - Client Status</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .header { display:flex; justify-content:space-between; align-items:flex-end; gap:16px; margin-bottom: 12px; }
    h1 { margin:0; font-size: 22px; }
    .sub { opacity:.8; font-size: 13px; }
    .card { background: rgba(255,255,255,0.07); border-radius: 16px; padding: 14px; }
    .table { width:100%; border-collapse: separate; border-spacing: 0 10px; }
    .row { background: rgba(255,255,255,0.06); border-radius: 14px; overflow:hidden; }
    .row td { padding: 12px 12px; vertical-align: middle; }
    .name { font-weight: 800; font-size: 16px; }
    .small { opacity: .85; font-size: 12px; margin-top: 3px; }
    .badge { display:inline-block; padding: 8px 10px; border-radius: 999px; font-weight: 900; letter-spacing: .3px; }
    .good { background:#0f7a3a; }
    .check { background:#b8860b; color:#fff7db; }
    .emergency { background:#b42318; }
    .muted { opacity:.75; }
    .right { text-align:right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    button { border-radius: 12px; padding: 8px 10px; font-weight: 800; }

    /* === System online/offline badge === */
    .statusBadge { display:inline-block; padding:6px 10px; border-radius:12px; font-weight:900; letter-spacing:.3px; }
    .statusBadge.green { background: rgba(0,255,0,0.15); color:#7CFF7C; }
    .statusBadge.gray  { background: rgba(255,255,255,0.10); color:#B8C0D9; }
    .statusLine { display:flex; gap:10px; align-items:center; justify-content:flex-end; }

    /* Dim UI when no data is arriving */
    .offlineDim { opacity: 0.55; filter: grayscale(100%); }

    @media (max-width: 720px) {
      .hide-mobile { display:none; }
      .right { text-align:left; }
      .statusLine { justify-content:flex-start; margin-top:10px; }
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="header">
      <div>
        <h1>UltraWatch Client Status</h1>
        <div class="sub">One-line overview for all monitored clients</div>
        <div class="sub" style="margin-top:8px;">
          <button id="enableSoundBtn">Enable Sound</button>
          <span class="muted" id="soundStatus" style="margin-left:10px;">Sound: off</span>
        </div>
      </div>

      <div>
        <div class="statusLine">
          <div id="systemStatus" class="statusBadge gray">OFFLINE</div>
          <div class="sub mono" id="dataAge">Data age: --</div>
          <div class="sub mono" id="updateCount" title="Increments when /system/lastDataRx changes">Updates: 0</div>
        </div>
        <div class="sub mono" id="clock" style="margin-top:6px;">--:--:--</div>
      </div>
    </div>

    <div class="card" id="mainCard">
      <table class="table" id="clientTable">
        <thead class="muted">
          <tr>
            <td>Client</td>
            <td>Status</td>
            <td class="hide-mobile">Notes</td>
            <td class="right">Caretaker</td>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase (same pattern as your other pages) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // === Firebase DB URL (your project) ===
    const firebaseConfig = {
      databaseURL: "https://ultrawatch-home-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Audible Alarm (browser side) =====
    // Put alarm.mp3 in the same GitHub folder as this HTML file.
    let soundEnabled = false;
    const alarmAudio = new Audio("alarm.mp3");
    alarmAudio.loop = true;

    function startAlarm() {
      if (!soundEnabled) return;
      if (alarmAudio.paused) {
        alarmAudio.currentTime = 0;
        alarmAudio.play().catch(() => {
          console.log("Alarm blocked until user interaction");
        });
      }
    }

    function stopAlarm() {
      if (!alarmAudio.paused) {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
      }
    }

    // One-time user interaction to allow audio playback
    const enableBtn = document.getElementById("enableSoundBtn");
    const soundStatus = document.getElementById("soundStatus");
    enableBtn.onclick = async () => {
      try {
        soundEnabled = true;
        alarmAudio.currentTime = 0;
        await alarmAudio.play();
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
        soundStatus.textContent = "Sound: on";
      } catch (e) {
        soundStatus.textContent = "Sound: blocked (tap again)";
      }
    };

    function clearAlerts(firebaseKey) {
      if (!firebaseKey) return;
      db.ref("/alerts/" + firebaseKey).update({
        sos: false,
        pool: false,
        timestamp: Math.floor(Date.now() / 1000)
      });
    }

    // === Demo roster ===
    const clients = [
      { displayName: "Christine", firebaseKey: "Grammie", caretakerName: "Laura Simmons", caretakerPhone: "(407) 555-0127" },
      { displayName: "Jack",      firebaseKey: "GRANDPA", caretakerName: "Mark Delaney", caretakerPhone: "(321) 555-0188" },

      { displayName: "Evelyn", caretakerName: "Dana Price", caretakerPhone: "(813) 555-0141", demoStatus: "GOOD", demoNote: "Living Room routine" },
      { displayName: "Harold", caretakerName: "Trent Wallace", caretakerPhone: "(352) 555-0194", demoStatus: "CHECK", demoNote: "Bathroom dwell > threshold" },
      { displayName: "Marjorie", caretakerName: "Sofia Ramos", caretakerPhone: "(954) 555-0103", demoStatus: "GOOD", demoNote: "Kitchen – normal" },
      { displayName: "Walter", caretakerName: "Chris Bennett", caretakerPhone: "(305) 555-0177", demoStatus: "EMERGENCY", demoNote: "SOS triggered" },
      { displayName: "Dolores", caretakerName: "Priya Nair", caretakerPhone: "(239) 555-0138", demoStatus: "GOOD", demoNote: "Bedroom – resting" },
      { displayName: "Frank", caretakerName: "Ethan Cole", caretakerPhone: "(727) 555-0160", demoStatus: "CHECK", demoNote: "Not seen (signal lost)" },
      { displayName: "Helen", caretakerName: "Maya Johnson", caretakerPhone: "(386) 555-0119", demoStatus: "GOOD", demoNote: "FrontDoor – brief visit" },
      { displayName: "Robert", caretakerName: "Noah Kim", caretakerPhone: "(561) 555-0155", demoStatus: "GOOD", demoNote: "Living Room – TV time" },
      { displayName: "Patricia", caretakerName: "Ava Martinez", caretakerPhone: "(904) 555-0199", demoStatus: "CHECK", demoNote: "Kitchen linger" },
      { displayName: "Stanley", caretakerName: "Jordan Lee", caretakerPhone: "(850) 555-0108", demoStatus: "GOOD", demoNote: "All clear" },
      { displayName: "Ruth", caretakerName: "Olivia Chen", caretakerPhone: "(863) 555-0120", demoStatus: "GOOD", demoNote: "Bathroom – normal" },
      { displayName: "George", caretakerName: "Sam Harper", caretakerPhone: "(941) 555-0184", demoStatus: "EMERGENCY", demoNote: "Pool alarm" },
      { displayName: "Irene", caretakerName: "Taylor Fox", caretakerPhone: "(407) 555-0150", demoStatus: "GOOD", demoNote: "Bedroom – asleep" },
      { displayName: "Bernard", caretakerName: "Casey Stone", caretakerPhone: "(321) 555-0171", demoStatus: "CHECK", demoNote: "Not seen > 2m" }
    ];

    // === Render table rows ===
    const tbody = document.getElementById("tbody");

    function statusClassFromText(t) {
      const s = (t || "").toUpperCase();
      if (s.includes("EMERGENCY")) return "emergency";
      if (s.includes("CHECK") || s.includes("NOT SEEN")) return "check";
      return "good";
    }

    function badgeTextFromState(state) {
      if (state.kind === "emergency") return "EMERGENCY";
      if (state.kind === "check") return state.text || "CHECK";
      return "GOOD";
    }

    function makeRow(id, client, state) {
      const tr = document.createElement("tr");
      tr.className = "row";
      tr.id = id;

      const badgeClass = state.kind;
      const badgeText = badgeTextFromState(state);

      tr.innerHTML = `
        <td>
          <div class="name">${client.displayName}</div>
          <div class="small muted">${client.firebaseKey ? "Live (Firebase)" : "Demo"}</div>
        </td>
        <td><span class="badge ${badgeClass}">${badgeText}</span></td>
        <td class="hide-mobile"><span class="muted">${state.note || ""}</span></td>
        <td class="right">
          <div><strong>${client.caretakerName}</strong></div>
          <div class="small mono muted">${client.caretakerPhone}</div>
          ${client.firebaseKey ? `<div style="margin-top:8px;"><button data-clear="${client.firebaseKey}">Clear</button></div>` : ``}
        </td>
      `;

      return tr;
    }

    // Initial render
    clients.forEach((c, idx) => {
      const id = `row_${idx}`;
      const demoState = c.firebaseKey
        ? { kind: "check", text: "LOADING", note: "Waiting for data…" }
        : { kind: statusClassFromText(c.demoStatus), text: c.demoStatus, note: c.demoNote || "" };

      tbody.appendChild(makeRow(id, c, demoState));
    });

    // Handle Clear button clicks (event delegation)
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-clear]");
      if (!btn) return;
      const key = btn.getAttribute("data-clear");
      clearAlerts(key);
    });

    function updateRowForClient(idx, state) {
      const id = `row_${idx}`;
      const row = document.getElementById(id);
      if (!row) return;

      const badgeText = badgeTextFromState(state);
      row.querySelector(".badge").className = "badge " + state.kind;
      row.querySelector(".badge").textContent = badgeText;

      const noteCell = row.querySelector(".hide-mobile .muted");
      if (noteCell) noteCell.textContent = state.note || "";
    }

    // === Live status computation ===
    const CHECK_THRESHOLDS = {
      "Bathroom": 60 * 60,
      "Kitchen": 4 * 60 * 60,
      "Living Room": 4 * 60 * 60,
      "Bedroom": 10 * 60 * 60,
      "FrontDoor": 10 * 60
    };

    const liveState = {}; // firebaseKey -> {room, entered_at, alerts}

    function computeState(displayName, firebaseKey) {
      const v = liveState[firebaseKey] || {};
      const room = v.room || "";
      const enteredAt = v.entered_at || null;
      const alerts = v.alerts || {};

      if (alerts.sos === true) return { kind: "emergency", text: "EMERGENCY", note: "SOS triggered" };
      if (alerts.pool === true) return { kind: "emergency", text: "EMERGENCY", note: "Pool alarm" };
      if (!room) return { kind: "check", text: displayName + " NOT SEEN", note: "No room reported" };

      const threshold = CHECK_THRESHOLDS[room];
      if (threshold && enteredAt) {
        const nowSec = Math.floor(Date.now()/1000);
        const dwell = nowSec - enteredAt;
        if (dwell >= threshold) return { kind: "check", text: "CHECK", note: room + " dwell exceeded" };
      }
      return { kind: "good", text: "GOOD", note: room };
    }

    function evaluateAnyEmergencyAndSound() {
      let anyEmergency = false;
      clients.forEach((c) => {
        if (!c.firebaseKey) return;
        const v = liveState[c.firebaseKey] || {};
        const alerts = v.alerts || {};
        if (alerts.sos === true || alerts.pool === true) anyEmergency = true;
      });

      if (anyEmergency) startAlarm();
      else stopAlarm();
    }

    // === DATA HEARTBEAT (from Python on MQTT receive) ===
    let lastDataRx = 0;
    let dataUpdateCount = 0;
    const STALE_SECONDS = 8;

    const systemStatusEl = document.getElementById("systemStatus");
    const dataAgeEl = document.getElementById("dataAge");
    const updateCountEl = document.getElementById("updateCount");
    const wrapEl = document.getElementById("wrap");

    db.ref("/system/lastDataRx").on("value", (snap) => {
      lastDataRx = snap.val() || 0;
      dataUpdateCount++;
      if (updateCountEl) updateCountEl.textContent = "Updates: " + dataUpdateCount;
    });

    function refreshOnlineOffline() {
      const now = Math.floor(Date.now() / 1000);
      const age = lastDataRx ? (now - lastDataRx) : null;
      const stale = (age === null) || (age > STALE_SECONDS);

      if (dataAgeEl) {
        dataAgeEl.textContent = "Data age: " + (age === null ? "--" : (age + "s"));
      }

      if (systemStatusEl) {
        if (stale) {
          systemStatusEl.textContent = "OFFLINE";
          systemStatusEl.classList.remove("green");
          systemStatusEl.classList.add("gray");
        } else {
          systemStatusEl.textContent = "ONLINE";
          systemStatusEl.classList.remove("gray");
          systemStatusEl.classList.add("green");
        }
      }

      // Dim the UI when offline
      if (wrapEl) {
        if (stale) wrapEl.classList.add("offlineDim");
        else wrapEl.classList.remove("offlineDim");
      }
    }

    // Subscribe live for each firebaseKey entry
    clients.forEach((c, idx) => {
      if (!c.firebaseKey) return;

      db.ref("/beacons/" + c.firebaseKey).on("value", snap => {
        const val = snap.val() || {};
        liveState[c.firebaseKey] = liveState[c.firebaseKey] || {};
        liveState[c.firebaseKey].room = val.room || "";
        liveState[c.firebaseKey].entered_at = val.entered_at || null;
        updateRowForClient(idx, computeState(c.displayName, c.firebaseKey));
      });

      db.ref("/alerts/" + c.firebaseKey).on("value", snap => {
        const val = snap.val() || {};
        liveState[c.firebaseKey] = liveState[c.firebaseKey] || {};
        liveState[c.firebaseKey].alerts = val || {};
        updateRowForClient(idx, computeState(c.displayName, c.firebaseKey));
        evaluateAnyEmergencyAndSound();
      });
    });

    // clock + periodic refresh
    function tick() {
      document.getElementById("clock").textContent = new Date().toLocaleString();

      clients.forEach((c, idx) => {
        if (!c.firebaseKey) return;
        updateRowForClient(idx, computeState(c.displayName, c.firebaseKey));
      });

      evaluateAnyEmergencyAndSound();
      refreshOnlineOffline();
    }

    setInterval(tick, 1000);
    tick();
  </script>
</body>
</html>
