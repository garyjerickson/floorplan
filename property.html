<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UltraWatch - Property Monitor (Demo)</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .header { display:flex; justify-content:space-between; align-items:flex-end; gap:16px; margin-bottom: 12px; flex-wrap:wrap; }
    h1 { margin:0; font-size: 22px; }
    .sub { opacity:.8; font-size: 13px; }
    .card { background: rgba(255,255,255,0.07); border-radius: 16px; padding: 14px; margin-bottom: 12px; }
    .grid { display:grid; gap:10px; }
    .grid2 { grid-template-columns: 1fr 1fr; }
    @media (max-width: 720px) { .grid2 { grid-template-columns: 1fr; } }

    .row { background: rgba(255,255,255,0.06); border-radius: 14px; overflow:hidden; padding:12px; }
    .rowTop { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .name { font-weight: 900; font-size: 16px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { opacity:.75; }
    .small { font-size: 12px; opacity:.85; margin-top:4px; }

    .badge { display:inline-block; padding: 8px 10px; border-radius: 999px; font-weight: 900; letter-spacing: .3px; }
    .good { background:#0f7a3a; }
    .check { background:#b8860b; color:#fff7db; }
    .emergency { background:#b42318; }
    .offline { background: rgba(255,255,255,0.12); color:#c9d3ee; }

    button { border-radius: 12px; padding: 8px 10px; font-weight: 800; border:0; cursor:pointer; }
    .btn { background: rgba(255,255,255,0.12); color:#e9eefc; }
    .btn:hover { background: rgba(255,255,255,0.16); }
    .btnDanger { background: rgba(180,35,24,0.75); color: #fff; }
    .btnDanger:hover { background: rgba(180,35,24,0.90); }

    input[type="text"], input[type="tel"]{
      width:100%;
      box-sizing:border-box;
      border-radius: 12px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#e9eefc;
      outline:none;
    }
    label { display:flex; align-items:center; gap:10px; user-select:none; }
    input[type="checkbox"]{ transform: scale(1.15); }

    .statusPill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px; font-weight: 900;
      background: rgba(255,255,255,0.10); color:#B8C0D9;
    }
    .dot { width:10px; height:10px; border-radius: 99px; background: rgba(255,255,255,0.35); }
    .liveOn { background: rgba(0,255,0,0.15); color:#7CFF7C; }
    .liveOn .dot { background: #46ff6a; }
    .livePending { background: rgba(255,200,0,0.15); color:#ffd37a; }
    .livePending .dot { background: #ffd37a; }

    .banner {
      display:none;
      margin-bottom: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(180,35,24,0.26);
      border: 1px solid rgba(255,120,120,0.25);
    }
    .bannerTop { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .bannerTitle { font-weight: 900; font-size: 15px; }
    .bannerText { margin-top:4px; }

    .err { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(180,35,24,0.18); color: #ffd2cd; display:none; }

    .pillList { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .pill {
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
    }

    /* NEW: Sound gate shown immediately on load until enabled */
    .soundGate {
      position: sticky;
      top: 0;
      z-index: 9999;
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(15, 122, 58, 0.18);
      border: 1px solid rgba(70,255,106,0.22);
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .soundGateTitle { font-weight: 900; }
    .soundGateHint { font-size: 12px; opacity: .85; }
    .soundGateRight { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>UltraWatch ‚Äî Property Monitor (Demo)</h1>
        <div class="sub">Single-location monitor page (AirBnB / VRBO demo)</div>
        <div class="sub mono">Build: 2025-12-26 15:14</div>
        <div class="err mono" id="errBox"></div>
      </div>
      <div class="mono muted" id="clock">--</div>
    </div>

    <!-- NEW: SOUND GATE (always visible until sound is enabled) -->
    <div class="soundGate" id="soundGate">
      <div>
        <div class="soundGateTitle">üîî Tap to enable alarms</div>
        <div class="soundGateHint">Phones block alarm audio until you tap once on this page.</div>
      </div>
      <div class="soundGateRight">
        <button class="btn" id="soundGateBtn">Enable Sound</button>
        <span class="sub mono muted" id="soundStatus" style="align-self:center;">Sound: off</span>
      </div>
    </div>

    <!-- RED ALERT BANNER -->
    <div class="banner" id="alertBanner">
      <div class="bannerTop">
        <div>
          <div class="bannerTitle">‚ö†Ô∏è EMERGENCY ALERT ACTIVE</div>
          <div class="sub mono bannerText" id="alertBannerText">--</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btnDanger" id="clearAllBtn">Clear All</button>
          <button class="btn" id="testAlarmBtn">Test Alarm</button>
          <button class="btn" id="enableSoundBtn">Enable Sound</button>
          <!-- soundStatus is up top in the gate -->
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid grid2">
        <div>
          <div style="font-weight:900; margin-bottom:6px;">Live monitoring request</div>
          <label>
            <input type="checkbox" id="liveMonitorChk" />
            <span>Request live monitoring</span>
          </label>
          <div style="margin-top:10px;">
            <span class="statusPill" id="livePill">
              <span class="dot"></span>
              <span id="liveText">LIVE MONITORING: OFF</span>
            </span>
            <div class="small muted">Demo-only: turns green a few seconds after checking.</div>
          </div>
        </div>

        <div>
          <div style="font-weight:900; margin-bottom:6px;">Emergency contact number(s)</div>
<div class="grid" style="grid-template-columns: 1fr auto auto; align-items:center;">
  <input type="tel" id="phoneInput" placeholder="Enter phone number (e.g., 407-555-0123)" />
  <button class="btn" id="addPhoneBtn">Add</button>
  <button class="btnDanger" id="clearPhonesBtn">Clear</button>
</div>

          <div class="small muted">Numbers are stored locally in this browser (demo).</div>

          <div id="registeredBlock" style="margin-top:10px; display:none;">
            <div class="small muted">Registered:</div>
            <div class="pillList" id="registeredList"></div>
          </div>
        </div>
      </div>

      <hr style="border:0; border-top:1px solid rgba(255,255,255,0.10); margin:12px 0;">

      <div class="grid grid2">
        <div>
          <div style="font-weight:900; margin-bottom:6px;">Pool alarm</div>
          <label>
            <input type="checkbox" id="poolEnabledChk" checked />
            <span>Enable pool alarm</span>
          </label>
          <div class="small muted">
            Demo-only pool trigger: if a person‚Äôs current room contains ‚Äúpool‚Äù (e.g., ‚ÄúPool‚Äù, ‚ÄúPool Area‚Äù, ‚ÄúBackyard Pool‚Äù), the pool alarm latches ON until cleared.
          </div>
        </div>

        <div>
          <div style="font-weight:900; margin-bottom:6px;">System</div>
          <div class="sub mono" id="systemLine">System: --</div>
          <div class="sub mono" id="dataAgeLine">Data age: --</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900; margin-bottom:8px;">Guests at this property</div>
      <div class="grid" id="peopleList"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  (function () {
    const errBox = document.getElementById("errBox");
    function showError(msg) {
      errBox.style.display = "block";
      errBox.textContent = "JS ERROR: " + msg;
    }

    try {
      // ---- Firebase ----
      const firebaseConfig = { databaseURL: "https://ultrawatch-home-default-rtdb.firebaseio.com/" };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ---- People to monitor (REAL Firebase keys) ----
      const people = [
        { label: "Jack", firebaseKey: "GRANDPA" },
        { label: "Axel", firebaseKey: "Axel" }
      ];

      // ---- Audio alarm (requires user interaction to enable on mobile) ----
      let soundEnabled = false;
      const alarmAudio = new Audio("alarm.mp3");
      alarmAudio.loop = true;

      const soundStatus = document.getElementById("soundStatus");
      const enableSoundBtn = document.getElementById("enableSoundBtn");
      const soundGate = document.getElementById("soundGate");
      const soundGateBtn = document.getElementById("soundGateBtn");

      function startAlarm() {
        if (!soundEnabled) return;
        if (alarmAudio.paused) {
          alarmAudio.currentTime = 0;
          alarmAudio.play().catch(() => console.log("Alarm blocked until user interaction"));
        }
      }
      function stopAlarm() {
        if (!alarmAudio.paused) {
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
        }
      }

      async function armSound() {
        try {
          soundEnabled = true;

          // "warm up" for iOS/Android
          alarmAudio.currentTime = 0;
          await alarmAudio.play();
          alarmAudio.pause();
          alarmAudio.currentTime = 0;

          soundStatus.textContent = "Sound: on";
          soundGate.style.display = "none"; // hide gate once enabled
          return true;
        } catch (e) {
          soundEnabled = false;
          soundStatus.textContent = "Sound: blocked (tap again)";
          soundGate.style.display = "flex";
          return false;
        }
      }

      // Gate button
      soundGateBtn.addEventListener("click", armSound);

      // Banner button (same behavior)
      enableSoundBtn.addEventListener("click", armSound);

      // Optional: first tap anywhere attempts to arm (helps users)
      document.addEventListener("click", (e) => {
        if (soundEnabled) return;
        if (e.target.closest("input, textarea")) return;
        if (e.target.closest("#soundGateBtn")) return;
        armSound();
      }, { passive:true });

      // ---- Demo-only: Live monitoring request ----
      const liveMonitorChk = document.getElementById("liveMonitorChk");
      const livePill = document.getElementById("livePill");
      const liveText = document.getElementById("liveText");
      let livePendingTimer = null;

      function setLivePill(state) {
        livePill.classList.remove("liveOn","livePending");
        if (state === "ON") {
          livePill.classList.add("liveOn");
          liveText.textContent = "LIVE MONITORING: ON";
        } else if (state === "PENDING") {
          livePill.classList.add("livePending");
          liveText.textContent = "LIVE MONITORING: PENDING‚Ä¶";
        } else {
          liveText.textContent = "LIVE MONITORING: OFF";
        }
      }
      setLivePill("OFF");

      liveMonitorChk.addEventListener("change", () => {
        if (livePendingTimer) { clearTimeout(livePendingTimer); livePendingTimer = null; }
        if (liveMonitorChk.checked) {
          setLivePill("PENDING");
          livePendingTimer = setTimeout(() => setLivePill("ON"), 2500);
        } else {
          setLivePill("OFF");
        }
      });

      // ---- Phone registration (localStorage) ----
      const phoneInput = document.getElementById("phoneInput");
      const addPhoneBtn = document.getElementById("addPhoneBtn");
      const registeredBlock = document.getElementById("registeredBlock");
      const registeredList = document.getElementById("registeredList");
      const registeredList = document.getElementById("registeredList");

      const PHONE_STORE_KEY = "ultrawatch_property_demo_numbers_v1";
      function loadPhones() {
        try { return JSON.parse(localStorage.getItem(PHONE_STORE_KEY) || "[]"); } catch { return []; }
      }
      function savePhones(arr) {
        localStorage.setItem(PHONE_STORE_KEY, JSON.stringify(arr));
      }
      function normalizePhone(s) {
        return String(s || "").trim();
      }
      function renderPhones() {
        const arr = loadPhones();
        registeredList.innerHTML = "";
        if (!arr.length) {
          registeredBlock.style.display = "none";
          return;
        }
        registeredBlock.style.display = "block";
        arr.forEach((p) => {
          const el = document.createElement("div");
          el.className = "pill mono";
          el.textContent = p;
          registeredList.appendChild(el);
        });
      }
      renderPhones();

      addPhoneBtn.addEventListener("click", () => {
        const p = normalizePhone(phoneInput.value);
        if (!p) return;
        const arr = loadPhones();
        if (!arr.includes(p)) arr.push(p);
        savePhones(arr);
        phoneInput.value = "";
        renderPhones();
      });

      clearPhonesBtn.addEventListener("click", () => {
  localStorage.removeItem(PHONE_STORE_KEY);
  renderPhones();
});


      // ---- Pool alarm behavior (demo-only, local latch) ----
      const poolEnabledChk = document.getElementById("poolEnabledChk");
      const poolLatched = {}; // firebaseKey -> bool
      function isPoolRoom(room) {
        const r = String(room || "").toLowerCase();
        return r.includes("pool");
      }
      function clearPool(firebaseKey) {
        poolLatched[firebaseKey] = false;
        evaluateAlarmNow();
        refreshBanner();
        paintAll();
      }

      // ---- SOS clear (REAL Firebase alerts) ----
      function clearSOS(firebaseKey) {
        if (!firebaseKey) return;
        db.ref("/alerts/" + firebaseKey).update({
          sos: false,
          timestamp: Math.floor(Date.now() / 1000)
        });
      }

      // ---- UI elements ----
      const peopleList = document.getElementById("peopleList");
      const alertBanner = document.getElementById("alertBanner");
      const alertBannerText = document.getElementById("alertBannerText");
      const clearAllBtn = document.getElementById("clearAllBtn");
      const testAlarmBtn = document.getElementById("testAlarmBtn");

      // ---- Data ----
      const live = {}; // firebaseKey -> {room, entered_at, last_seen, alerts}
      let lastSystemRx = 0;
      const systemLine = document.getElementById("systemLine");
      const dataAgeLine = document.getElementById("dataAgeLine");

      // ---- Alarm test ----
      let testAlarmUntil = 0;
      function triggerTestAlarm() {
        const now = Math.floor(Date.now()/1000);
        testAlarmUntil = now + 8;
        startAlarm();
        refreshBanner();
        setTimeout(() => { evaluateAlarmNow(); refreshBanner(); }, 8200);
      }
      testAlarmBtn.addEventListener("click", triggerTestAlarm);

      clearAllBtn.addEventListener("click", () => {
        people.forEach(p => poolLatched[p.firebaseKey] = false);
        people.forEach(p => clearSOS(p.firebaseKey));
        evaluateAlarmNow();
        refreshBanner();
        paintAll();
      });

      // ---- Render / update helpers ----
      function formatDuration(seconds) {
        const s = Math.max(0, Math.floor(seconds || 0));
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        if (h > 0) return `${h}:${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
        return `${m}:${String(sec).padStart(2,"0")}`;
      }

      function computeStatus(p) {
        const v = live[p.firebaseKey] || {};
        const room = v.room || "";
        const enteredAt = v.entered_at || 0;
        const lastSeen = v.last_seen || 0;
        const alerts = v.alerts || {};

        // latch pool if pool room is detected
        if (isPoolRoom(room)) poolLatched[p.firebaseKey] = true;

        const sosActive = (alerts.sos === true);
        const poolActive = (poolLatched[p.firebaseKey] === true);

        const now = Math.floor(Date.now()/1000);
        const age = lastSeen ? (now - lastSeen) : null;
        const offline = (age === null) || (age > 12);

        const dwell = enteredAt ? (now - enteredAt) : 0;
        const dwellStr = enteredAt ? formatDuration(dwell) : "--:--";

        if (sosActive || poolActive) {
          const parts = [];
          if (sosActive) parts.push("SOS");
          if (poolActive) parts.push("POOL");
          return {
            kind: "emergency",
            badge: "EMERGENCY",
            note: `${parts.join(" + ")}${room ? " ‚Ä¢ " + room : ""}`,
            room, dwellStr, offline,
            sosActive, poolActive
          };
        }

        if (offline) {
          return {
            kind: "offline",
            badge: "OFFLINE",
            note: age === null ? "No signal yet" : `No signal (${age}s)${room ? " ‚Ä¢ last: " + room : ""}`,
            room, dwellStr, offline,
            sosActive:false, poolActive:false
          };
        }

        if (!room) {
          return {
            kind: "check",
            badge: "CHECK",
            note: "No room reported",
            room, dwellStr, offline:false,
            sosActive:false, poolActive:false
          };
        }

        return {
          kind: "good",
          badge: "OK",
          note: `${room} ‚Ä¢ ${dwellStr}`,
          room, dwellStr, offline:false,
          sosActive:false, poolActive:false
        };
      }

      function paintAll() {
        people.forEach(p => paintRow(p));
      }

      function paintRow(p) {
        const row = document.getElementById("person_" + p.firebaseKey);
        if (!row) return;
        const s = computeStatus(p);

        const badgeEl = row.querySelector("[data-badge]");
        const noteEl = row.querySelector("[data-note]");

        badgeEl.className = "badge " + s.kind;
        badgeEl.textContent = s.kind === "good" ? "GOOD" : s.badge;

        noteEl.textContent = s.note || "";

        const clearSOSBtn = row.querySelector("button[data-clear-sos]");
        const clearPoolBtn = row.querySelector("button[data-clear-pool]");

        if (clearSOSBtn) clearSOSBtn.style.display = s.sosActive ? "inline-block" : "none";
        if (clearPoolBtn) clearPoolBtn.style.display = s.poolActive ? "inline-block" : "none";
      }

      function anyEmergencyTriggersAlarm() {
        const now = Math.floor(Date.now()/1000);
        if (testAlarmUntil && now <= testAlarmUntil) return true;

        const poolEnabled = poolEnabledChk.checked;

        return people.some(p => {
          const v = live[p.firebaseKey] || {};
          const a = v.alerts || {};
          const sos = (a.sos === true);
          const pool = (poolLatched[p.firebaseKey] === true);
          if (sos) return true;
          if (pool && poolEnabled) return true;
          return false;
        });
      }

      function evaluateAlarmNow() {
        if (anyEmergencyTriggersAlarm()) startAlarm();
        else stopAlarm();
      }

      function refreshBanner() {
        const now = Math.floor(Date.now()/1000);
        const testActive = (testAlarmUntil && now <= testAlarmUntil);

        const sosNames = [];
        const poolNames = [];

        people.forEach(p => {
          const v = live[p.firebaseKey] || {};
          const a = v.alerts || {};
          if (a.sos === true) sosNames.push(p.label);
          if (poolLatched[p.firebaseKey] === true) poolNames.push(p.label);
        });

        if (!testActive && !sosNames.length && !poolNames.length) {
          alertBanner.style.display = "none";
          alertBannerText.textContent = "--";
          return;
        }

        alertBanner.style.display = "block";
        const parts = [];
        if (testActive) parts.push("TEST ALARM");
        if (sosNames.length) parts.push("SOS: " + sosNames.join(", "));
        if (poolNames.length) parts.push("POOL: " + poolNames.join(", "));
        alertBannerText.textContent = parts.join("  |  ");
      }

      // ---- Build the rows ----
      function buildRows() {
        peopleList.innerHTML = "";
        people.forEach(p => {
          const div = document.createElement("div");
          div.className = "row";
          div.id = "person_" + p.firebaseKey;
          div.innerHTML = `
            <div class="rowTop">
              <div>
                <div class="name">${p.label}</div>
                <div class="small muted mono">Firebase key: ${p.firebaseKey}</div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <span class="badge check" data-badge>LOADING</span>
                <button class="btnDanger" data-clear-sos="${p.firebaseKey}" style="display:none;">Clear SOS</button>
                <button class="btnDanger" data-clear-pool="${p.firebaseKey}" style="display:none;">Clear Pool</button>
                <button class="btn" data-test-alarm="1">Test Alarm</button>
              </div>
            </div>
            <div class="small" style="margin-top:8px;">
              <span class="muted">Status:</span> <span data-note class="mono">Waiting for data‚Ä¶</span>
            </div>
          `;
          peopleList.appendChild(div);
        });
      }
      buildRows();

      // ---- Click actions ----
      document.addEventListener("click", (e) => {
        const sosBtn = e.target.closest("button[data-clear-sos]");
        if (sosBtn) { clearSOS(sosBtn.getAttribute("data-clear-sos")); return; }

        const poolBtn = e.target.closest("button[data-clear-pool]");
        if (poolBtn) { clearPool(poolBtn.getAttribute("data-clear-pool")); return; }

        const testBtn = e.target.closest("button[data-test-alarm]");
        if (testBtn) { triggerTestAlarm(); return; }
      });

      poolEnabledChk.addEventListener("change", () => {
        evaluateAlarmNow();
        refreshBanner();
      });

      // ---- System heartbeat (optional) ----
      db.ref("/system/lastDataRx").on("value", (snap) => {
        lastSystemRx = snap.val() || 0;
      });

      // ---- Subscriptions: read REAL room/entered_at/last_seen + REAL SOS alerts ----
      people.forEach(p => {
        db.ref("/beacons/" + p.firebaseKey).on("value", (snap) => {
          const val = snap.val() || {};
          live[p.firebaseKey] = live[p.firebaseKey] || {};
          live[p.firebaseKey].room = val.room || "";
          live[p.firebaseKey].entered_at = val.entered_at || 0;
          live[p.firebaseKey].last_seen = val.last_seen || 0;
          paintRow(p);
          evaluateAlarmNow();
          refreshBanner();
        });

        db.ref("/alerts/" + p.firebaseKey).on("value", (snap) => {
          const val = snap.val() || {};
          live[p.firebaseKey] = live[p.firebaseKey] || {};
          live[p.firebaseKey].alerts = val || {};
          paintRow(p);
          evaluateAlarmNow();
          refreshBanner();
        });
      });

      // ---- Clock + system lines ----
      function tick() {
        document.getElementById("clock").textContent = new Date().toLocaleString();

        const now = Math.floor(Date.now()/1000);
        if (!lastSystemRx) {
          systemLine.textContent = "System: --";
          dataAgeLine.textContent = "Data age: --";
        } else {
          const age = now - lastSystemRx;
          systemLine.textContent = "System: " + (age <= 8 ? "ONLINE" : "OFFLINE");
          dataAgeLine.textContent = "Data age: " + age + "s";
        }

        paintAll();
        evaluateAlarmNow();
        refreshBanner();
      }
      setInterval(tick, 1000);
      tick();

    } catch (e) {
      showError(e && e.message ? e.message : String(e));
      console.error(e);
    }
  })();
  </script>
</body>
</html>
