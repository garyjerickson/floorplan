<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UltraWatch - Property Demo</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .header { display:flex; justify-content:space-between; align-items:flex-end; gap:16px; margin-bottom: 12px; }
    h1 { margin:0; font-size: 22px; }
    .sub { opacity:.8; font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { opacity:.75; }

    .card { background: rgba(255,255,255,0.07); border-radius: 16px; padding: 14px; margin-bottom: 12px; }
    .table { width:100%; border-collapse: separate; border-spacing: 0 10px; }
    .row { background: rgba(255,255,255,0.06); border-radius: 14px; overflow:hidden; }
    .row td { padding: 12px 12px; vertical-align: middle; }

    .name { font-weight: 900; font-size: 16px; }
    .small { opacity: .85; font-size: 12px; margin-top: 3px; }

    .right { text-align:right; }
    @media (max-width: 720px) { .right { text-align:left; } .hide-mobile { display:none; } }

    .badge { display:inline-block; padding: 8px 10px; border-radius: 999px; font-weight: 900; letter-spacing: .3px; }
    .good { background:#0f7a3a; }
    .check { background:#b8860b; color:#fff7db; }
    .emergency { background:#b42318; }
    .offline { background: rgba(255,255,255,0.12); color:#c9d3ee; }

    .rowOffline { opacity: 0.55; filter: grayscale(100%); }

    .statusBadge { display:inline-block; padding:6px 10px; border-radius:12px; font-weight:900; letter-spacing:.3px; }
    .statusBadge.green { background: rgba(0,255,0,0.15); color:#7CFF7C; }
    .statusBadge.gray  { background: rgba(255,255,255,0.10); color:#B8C0D9; }
    .statusLine { display:flex; gap:10px; align-items:center; justify-content:flex-end; }
    @media (max-width: 720px) { .statusLine { justify-content:flex-start; margin-top:10px; } }

    button { border-radius: 12px; padding: 8px 10px; font-weight: 900; cursor:pointer; border:0; }
    .btn { background: rgba(255,255,255,0.10); color:#e9eefc; }
    .btnPrimary { background: rgba(124,255,124,0.18); color:#dfffe0; border: 1px solid rgba(124,255,124,0.30); }
    .btnDanger { background: rgba(255,90,90,0.20); color:#ffe2e2; border: 1px solid rgba(255,90,90,0.25); }

    input[type="tel"] {
      width: 100%;
      box-sizing: border-box;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: #e9eefc;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      outline: none;
    }

    .err { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(180,35,24,0.18); color: #ffd2cd; display:none; }

    .controlGrid { display:grid; grid-template-columns: 1.4fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .controlGrid { grid-template-columns: 1fr; } }

    .toggleRow { display:flex; align-items:center; gap:10px; }
    .toggleRow input { transform: scale(1.2); }

    .lampWrap { display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    @media (max-width: 720px) { .lampWrap { justify-content:flex-start; } }

    .lamp {
      width: 14px; height: 14px; border-radius: 999px;
      background: rgba(255,255,255,0.18);
      box-shadow: 0 0 0 rgba(0,0,0,0);
      border: 1px solid rgba(255,255,255,0.12);
    }
    .lamp.on {
      background: rgba(124,255,124,0.95);
      box-shadow: 0 0 18px rgba(124,255,124,0.55);
      border-color: rgba(124,255,124,0.75);
    }
    .lamp.pending {
      background: rgba(255,210,80,0.95);
      box-shadow: 0 0 18px rgba(255,210,80,0.35);
      border-color: rgba(255,210,80,0.70);
    }

    .pill {
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      font-weight: 900;
      letter-spacing: .2px;
    }
    .pillOk { background: rgba(124,255,124,0.15); color:#dfffe0; border: 1px solid rgba(124,255,124,0.25); }

    .inlineActions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    @media (max-width: 720px) { .inlineActions { justify-content:flex-start; margin-top:10px; } }

    .registeredBox {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      display:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>UltraWatch Property Demo</h1>
        <div class="sub">Single-location page monitoring Jack + Axel</div>
        <div class="sub mono">Build: 2025-12-26 1316</div>

        <div class="sub" style="margin-top:8px;">
          <button class="btn" id="enableSoundBtn">Enable Sound</button>
          <span class="muted" id="soundStatus" style="margin-left:10px;">Sound: off</span>
        </div>

        <div class="err mono" id="errBox"></div>
      </div>

      <div>
        <div class="statusLine">
          <div id="systemStatus" class="statusBadge gray">OFFLINE</div>
          <div class="sub mono" id="dataAge">Data age: --</div>
          <div class="sub mono" id="updateCount">Updates: 0</div>
        </div>
        <div class="sub mono" id="clock" style="margin-top:6px;">--</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="controlGrid">
        <div>
          <div class="toggleRow">
            <input type="checkbox" id="liveMonitorChk" />
            <div>
              <div style="font-weight:900;">Request Live Monitoring</div>
              <div class="sub">UltraWatch backup monitoring for this property.</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div style="font-weight:900; margin-bottom:6px;">Emergency Contact Phone Number(s)</div>
            <input id="phoneInput" type="tel" placeholder="Example: 407-555-0123, 321-555-0188" />
            <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
              <button class="btnPrimary" id="registerPhonesBtn">Register</button>
              <span class="pill pillOk mono" id="registeredPill" style="display:none;">Registered ✓</span>
            </div>

            <!-- NEW: show registered numbers below -->
            <div class="registeredBox" id="registeredBox">
              <div style="font-weight:900;">Registered numbers</div>
              <div class="sub mono" id="registeredList" style="margin-top:6px;">--</div>
            </div>

            <div class="sub muted" style="margin-top:8px;">
              Tip: separate multiple numbers with commas.
            </div>
          </div>

          <div style="margin-top:14px;">
            <!-- IMPORTANT: per your rule, if NOT checked => alarm SHOULD sound.
                 So this is a "Mute Pool Alarm" checkbox. -->
            <div class="toggleRow">
              <input type="checkbox" id="poolMuteChk" />
              <div>
                <div style="font-weight:900;">Mute Pool Alarm</div>
                <div class="sub">If unchecked, entering pool area triggers red status + alarm.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="lampWrap">
          <div>
            <div style="font-weight:900;">Live Monitoring Status</div>
            <div class="sub" id="liveStatusText">Not requested</div>
          </div>
          <div class="lamp" id="liveLamp" title="Live monitoring status"></div>
        </div>
      </div>
    </div>

    <!-- People table -->
    <div class="card">
      <table class="table" id="clientTable">
        <thead class="muted">
          <tr>
            <td>Person</td>
            <td>Status</td>
            <td class="hide-mobile">Notes</td>
            <td class="right">Actions</td>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  (function () {
    const errBox = document.getElementById("errBox");
    function showError(msg) {
      errBox.style.display = "block";
      errBox.textContent = "JS ERROR: " + msg;
    }

    try {
      const firebaseConfig = { databaseURL: "https://ultrawatch-home-default-rtdb.firebaseio.com/" };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ===== Real targets =====
      const people = [
        { label: "Jack", firebaseKey: "GRANDPA" },
        { label: "Axel", firebaseKey: "Axel" }
      ];

      // ===== Audible alarm =====
      let soundEnabled = false;
      const alarmAudio = new Audio("alarm.mp3");
      alarmAudio.loop = true;

      function startAlarm() {
        if (!soundEnabled) return;
        if (alarmAudio.paused) {
          alarmAudio.currentTime = 0;
          alarmAudio.play().catch(() => console.log("Alarm blocked until user interaction"));
        }
      }
      function stopAlarm() {
        if (!alarmAudio.paused) {
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
        }
      }

      const enableBtn = document.getElementById("enableSoundBtn");
      const soundStatus = document.getElementById("soundStatus");
      enableBtn.onclick = async () => {
        try {
          soundEnabled = true;
          alarmAudio.currentTime = 0;
          await alarmAudio.play();
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
          soundStatus.textContent = "Sound: on";
        } catch (e) {
          soundStatus.textContent = "Sound: blocked (tap again)";
        }
      };

      // ===== Local storage keys =====
      const LS_LIVE = "uw_property_live_requested";
      const LS_PHONES = "uw_property_phones";
      const LS_POOL_MUTE = "uw_property_pool_mute";

      // ===== Live monitoring UI (demo-only) =====
      const liveChk = document.getElementById("liveMonitorChk");
      const liveLamp = document.getElementById("liveLamp");
      const liveStatusText = document.getElementById("liveStatusText");
      let liveTimer = null;

      function setLiveState(state) {
        liveLamp.classList.remove("on", "pending");
        if (state === "pending") {
          liveLamp.classList.add("pending");
          liveStatusText.textContent = "Connecting…";
        } else if (state === "on") {
          liveLamp.classList.add("on");
          liveStatusText.textContent = "Live monitoring active";
        } else {
          liveStatusText.textContent = "Not requested";
        }
      }

      function applyLiveFromStorage() {
        const requested = localStorage.getItem(LS_LIVE) === "true";
        liveChk.checked = requested;

        if (requested) {
          setLiveState("pending");
          clearTimeout(liveTimer);
          liveTimer = setTimeout(() => setLiveState("on"), 2500);
        } else {
          setLiveState("off");
        }
      }

      liveChk.addEventListener("change", () => {
        localStorage.setItem(LS_LIVE, liveChk.checked ? "true" : "false");
        if (liveChk.checked) {
          setLiveState("pending");
          clearTimeout(liveTimer);
          liveTimer = setTimeout(() => setLiveState("on"), 2500);
        } else {
          clearTimeout(liveTimer);
          setLiveState("off");
        }
      });

      applyLiveFromStorage();

      // ===== Phone registration UI =====
      const phoneInput = document.getElementById("phoneInput");
      const registerPhonesBtn = document.getElementById("registerPhonesBtn");
      const registeredPill = document.getElementById("registeredPill");
      const registeredBox = document.getElementById("registeredBox");
      const registeredList = document.getElementById("registeredList");

      function normalizePhones(raw) {
        // Keep it simple: split on commas, trim, drop empties
        return (raw || "")
          .split(",")
          .map(x => x.trim())
          .filter(Boolean);
      }

      function refreshRegisteredUI() {
        const saved = localStorage.getItem(LS_PHONES) || "";
        const arr = normalizePhones(saved);

        if (!arr.length) {
          registeredBox.style.display = "none";
          registeredList.textContent = "--";
          return;
        }

        registeredBox.style.display = "block";
        registeredList.textContent = arr.join(", ");
      }

      function loadPhoneStorage() {
        phoneInput.value = localStorage.getItem(LS_PHONES) || "";
        refreshRegisteredUI();
      }

      registerPhonesBtn.addEventListener("click", () => {
        const val = (phoneInput.value || "").trim();
        localStorage.setItem(LS_PHONES, val);

        // visual confirmation
        registeredPill.style.display = "inline-block";
        setTimeout(() => { registeredPill.style.display = "none"; }, 2500);

        refreshRegisteredUI();
      });

      loadPhoneStorage();

      // ===== Pool mute checkbox (IMPORTANT: unchecked => alarm can sound) =====
      const poolMuteChk = document.getElementById("poolMuteChk");
      function applyPoolMuteFromStorage() {
        const v = localStorage.getItem(LS_POOL_MUTE);
        poolMuteChk.checked = (v === "true"); // default false if missing
      }
      poolMuteChk.addEventListener("change", () => {
        localStorage.setItem(LS_POOL_MUTE, poolMuteChk.checked ? "true" : "false");
        evaluateAlarmNow();
      });
      applyPoolMuteFromStorage();

      // ===== Helpers =====
      function formatDuration(seconds) {
        const s = Math.max(0, Math.floor(seconds || 0));
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        if (h > 0) return `${h}:${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
        return `${m}:${String(sec).padStart(2,"0")}`;
      }

      function badgeText(kind) {
        if (kind === "emergency") return "EMERGENCY";
        if (kind === "offline") return "OFFLINE";
        if (kind === "check") return "CHECK";
        return "GOOD";
      }

      // ===== Actions =====
      // SOS: still uses Firebase alerts, like your existing setup
      function clearSOS(firebaseKey) {
        db.ref("/alerts/" + firebaseKey).update({
          sos: false,
          timestamp: Math.floor(Date.now() / 1000)
        });
      }

      // Pool: DEMO-LOCAL ONLY acknowledge (no Firebase writes)
      const poolAck = {}; // firebaseKey -> true/false (clears automatically when they leave pool)
      function ackPool(firebaseKey) { poolAck[firebaseKey] = true; evaluateAlarmNow(); }

      // ===== UI render =====
      const tbody = document.getElementById("tbody");

      function makeRow(idx, p) {
        const tr = document.createElement("tr");
        tr.className = "row";
        tr.id = "row_" + idx;
        tr.innerHTML = `
          <td>
            <div class="name">${p.label}</div>
            <div class="small muted">Firebase key: <span class="mono">${p.firebaseKey}</span></div>
          </td>
          <td><span class="badge offline">LOADING</span></td>
          <td class="hide-mobile"><span class="muted">Waiting for data…</span></td>
          <td class="right">
            <div class="inlineActions">
              <button class="btnDanger" data-clear-sos="${p.firebaseKey}">Clear SOS</button>
              <button class="btn" data-ack-pool="${p.firebaseKey}">Acknowledge Pool</button>
            </div>
          </td>
        `;
        return tr;
      }

      people.forEach((p, idx) => tbody.appendChild(makeRow(idx, p)));

      document.addEventListener("click", (e) => {
        const sosBtn = e.target.closest("button[data-clear-sos]");
        if (sosBtn) { clearSOS(sosBtn.getAttribute("data-clear-sos")); return; }

        const ackBtn = e.target.closest("button[data-ack-pool]");
        if (ackBtn) { ackPool(ackBtn.getAttribute("data-ack-pool")); return; }
      });

      // ===== Live data =====
      const BEACON_OFFLINE_SECONDS = 12;
      const live = {}; // key -> { room, entered_at, last_seen, alerts }

      // Pool room names (DEMO): add whatever your script uses
      const POOL_ROOMS = new Set([
        "Pool", "POOL",
        "Pool Area", "POOL AREA",
        "PoolDeck", "POOLDECK",
        "Poolside", "POOLSIDE"
      ]);

      function isPoolRoom(room) {
        const r = (room || "").trim();
        if (!r) return false;
        if (POOL_ROOMS.has(r)) return true;
        // Also allow partial matches like "Pool - Back"
        return r.toLowerCase().includes("pool");
      }

      function computeState(p) {
        const v = live[p.firebaseKey] || {};
        const room = v.room || "";
        const enteredAt = v.entered_at || null;
        const lastSeen = v.last_seen || 0;
        const alerts = v.alerts || {};

        const now = Math.floor(Date.now()/1000);
        const dwell = (enteredAt && enteredAt > 0) ? (now - enteredAt) : 0;
        const dwellStr = enteredAt ? formatDuration(dwell) : "--:--";

        const sosActive = (alerts.sos === true);

        // Pool condition derived ONLY from room
        const poolActive = isPoolRoom(room);
        if (!poolActive) poolAck[p.firebaseKey] = false; // auto-clear ack when leaving pool

        // Offline
        const offline = (!lastSeen) || ((now - lastSeen) > BEACON_OFFLINE_SECONDS);
        if (offline) {
          const age = lastSeen ? (now - lastSeen) : null;
          return {
            kind:"offline",
            note: age === null ? "No signal yet" : `${room ? room + " • " : ""}No signal (${age}s)${enteredAt && room ? ` • was there ${dwellStr}` : ""}`,
            sosActive, poolActive
          };
        }

        // Emergency if SOS or Pool (pool is local demo)
        if (sosActive || poolActive) {
          const parts = [];
          if (sosActive) parts.push("SOS");
          if (poolActive) parts.push(poolAck[p.firebaseKey] ? "POOL (ACK)" : "POOL");
          return {
            kind:"emergency",
            note: `${parts.join(" + ")}${room ? " • " + room : ""}`,
            sosActive, poolActive
          };
        }

        if (!room) return { kind:"check", note:"No room reported", sosActive, poolActive };

        return { kind:"good", note:`${room} • ${dwellStr}`, sosActive, poolActive };
      }

      function paintRow(idx, p) {
        const row = document.getElementById("row_" + idx);
        if (!row) return;

        const st = computeState(p);

        const badge = row.querySelector(".badge");
        badge.className = "badge " + st.kind;
        badge.textContent = badgeText(st.kind);

        const note = row.querySelector(".hide-mobile .muted");
        if (note) note.textContent = st.note || "";

        if (st.kind === "offline") row.classList.add("rowOffline");
        else row.classList.remove("rowOffline");
      }

      function anyEmergencyTriggersAlarm() {
        const poolMuted = poolMuteChk.checked; // IMPORTANT: if NOT checked, alarm should sound on pool
        return people.some(p => {
          const v = live[p.firebaseKey] || {};
          const a = v.alerts || {};

          const sos = (a.sos === true);

          const room = (v.room || "");
          const pool = isPoolRoom(room) && !poolAck[p.firebaseKey];

          if (sos) return true;
          if (pool && !poolMuted) return true;
          return false;
        });
      }

      function evaluateAlarmNow() {
        if (anyEmergencyTriggersAlarm()) startAlarm();
        else stopAlarm();
      }

      // Subscribe
      people.forEach((p, idx) => {
        db.ref("/beacons/" + p.firebaseKey).on("value", snap => {
          const val = snap.val() || {};
          live[p.firebaseKey] = live[p.firebaseKey] || {};
          live[p.firebaseKey].room = val.room || "";
          live[p.firebaseKey].entered_at = val.entered_at || null;
          live[p.firebaseKey].last_seen = val.last_seen || 0;
          paintRow(idx, p);
          evaluateAlarmNow();
        });

        db.ref("/alerts/" + p.firebaseKey).on("value", snap => {
          const val = snap.val() || {};
          live[p.firebaseKey] = live[p.firebaseKey] || {};
          live[p.firebaseKey].alerts = val || {};
          paintRow(idx, p);
          evaluateAlarmNow();
        });
      });

      // ===== System online badge via /system/lastDataRx =====
      let lastDataRx = 0;
      let updates = 0;
      const STALE_SECONDS = 8;

      const systemStatusEl = document.getElementById("systemStatus");
      const dataAgeEl = document.getElementById("dataAge");
      const updateCountEl = document.getElementById("updateCount");

      db.ref("/system/lastDataRx").on("value", (snap) => {
        lastDataRx = snap.val() || 0;
        updates++;
        updateCountEl.textContent = "Updates: " + updates;
      });

      function refreshSystemBadge() {
        const now = Math.floor(Date.now()/1000);
        const age = lastDataRx ? (now - lastDataRx) : null;
        const stale = (age === null) || (age > STALE_SECONDS);

        dataAgeEl.textContent = "Data age: " + (age === null ? "--" : (age + "s"));

        systemStatusEl.classList.remove("gray","green");
        if (stale) {
          systemStatusEl.textContent = "OFFLINE";
          systemStatusEl.classList.add("gray");
        } else {
          systemStatusEl.textContent = "ONLINE";
          systemStatusEl.classList.add("green");
        }
      }

      function tick() {
        document.getElementById("clock").textContent = new Date().toLocaleString();
        people.forEach((p, idx) => paintRow(idx, p));
        refreshSystemBadge();
        evaluateAlarmNow();
      }

      setInterval(tick, 1000);
      tick();

    } catch (e) {
      showError(e && e.message ? e.message : String(e));
      console.error(e);
    }
  })();
  </script>
</body>
</html>
