<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UltraWatch - Property Demo</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .header { display:flex; justify-content:space-between; align-items:flex-end; gap:16px; margin-bottom: 12px; }
    h1 { margin:0; font-size: 22px; }
    .sub { opacity:.8; font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .card { background: rgba(255,255,255,0.07); border-radius: 16px; padding: 14px; }
    .table { width:100%; border-collapse: separate; border-spacing: 0 10px; }
    .row { background: rgba(255,255,255,0.06); border-radius: 14px; overflow:hidden; }
    .row td { padding: 12px 12px; vertical-align: middle; }

    .name { font-weight: 900; font-size: 16px; }
    .small { opacity: .85; font-size: 12px; margin-top: 3px; }
    .muted { opacity:.75; }
    .right { text-align:right; }
    @media (max-width: 720px) { .right { text-align:left; } .hide-mobile { display:none; } }

    .badge { display:inline-block; padding: 8px 10px; border-radius: 999px; font-weight: 900; letter-spacing: .3px; }
    .good { background:#0f7a3a; }
    .check { background:#b8860b; color:#fff7db; }
    .emergency { background:#b42318; }
    .offline { background: rgba(255,255,255,0.12); color:#c9d3ee; }
    .away { background: rgba(120,140,255,0.18); color:#dbe2ff; }

    .rowOffline { opacity: 0.55; filter: grayscale(100%); }

    .statusBadge { display:inline-block; padding:6px 10px; border-radius:12px; font-weight:900; letter-spacing:.3px; }
    .statusBadge.green { background: rgba(0,255,0,0.15); color:#7CFF7C; }
    .statusBadge.gray  { background: rgba(255,255,255,0.10); color:#B8C0D9; }
    .statusLine { display:flex; gap:10px; align-items:center; justify-content:flex-end; }
    @media (max-width: 720px) { .statusLine { justify-content:flex-start; margin-top:10px; } }

    button { border-radius: 12px; padding: 8px 10px; font-weight: 900; cursor:pointer; border:0; }
    .err { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(180,35,24,0.18); color: #ffd2cd; display:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>UltraWatch Property Demo</h1>
        <div class="sub">Live demo reading real locations for Jack (GRANDPA) and Axel</div>
        <div class="sub mono">Build: 2025-12-26 12:00</div>

        <div class="sub" style="margin-top:8px;">
          <button id="enableSoundBtn">Enable Sound</button>
          <span class="muted" id="soundStatus" style="margin-left:10px;">Sound: off</span>
        </div>

        <div class="err mono" id="errBox"></div>
      </div>

      <div>
        <div class="statusLine">
          <div id="systemStatus" class="statusBadge gray">OFFLINE</div>
          <div class="sub mono" id="dataAge">Data age: --</div>
          <div class="sub mono" id="updateCount">Updates: 0</div>
        </div>
        <div class="sub mono" id="clock" style="margin-top:6px;">--</div>
      </div>
    </div>

    <div class="card">
      <table class="table" id="clientTable">
        <thead class="muted">
          <tr>
            <td>Person</td>
            <td>Status</td>
            <td class="hide-mobile">Notes</td>
            <td class="right">Actions</td>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  (function () {
    const errBox = document.getElementById("errBox");
    function showError(msg) {
      errBox.style.display = "block";
      errBox.textContent = "JS ERROR: " + msg;
    }

    try {
      // ===== Firebase =====
      const firebaseConfig = { databaseURL: "https://ultrawatch-home-default-rtdb.firebaseio.com/" };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ===== Demo targets (REAL) =====
      const people = [
        { label: "Jack", firebaseKey: "GRANDPA" },
        { label: "Axel", firebaseKey: "Axel" }
      ];

      // ===== Audible alarm =====
      let soundEnabled = false;
      const alarmAudio = new Audio("alarm.mp3");
      alarmAudio.loop = true;

      function startAlarm() {
        if (!soundEnabled) return;
        if (alarmAudio.paused) {
          alarmAudio.currentTime = 0;
          alarmAudio.play().catch(() => console.log("Alarm blocked until user interaction"));
        }
      }
      function stopAlarm() {
        if (!alarmAudio.paused) {
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
        }
      }

      const enableBtn = document.getElementById("enableSoundBtn");
      const soundStatus = document.getElementById("soundStatus");
      enableBtn.onclick = async () => {
        try {
          soundEnabled = true;
          alarmAudio.currentTime = 0;
          await alarmAudio.play();
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
          soundStatus.textContent = "Sound: on";
        } catch (e) {
          soundStatus.textContent = "Sound: blocked (tap again)";
        }
      };

      // ===== Helpers =====
      function formatDuration(seconds) {
        const s = Math.max(0, Math.floor(seconds || 0));
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        if (h > 0) return `${h}:${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
        return `${m}:${String(sec).padStart(2,"0")}`;
      }

      function badgeText(kind, fallback) {
        if (kind === "emergency") return "EMERGENCY";
        if (kind === "offline") return "OFFLINE";
        if (kind === "check") return fallback || "CHECK";
        return "GOOD";
      }

      function clearAlerts(firebaseKey) {
        db.ref("/alerts/" + firebaseKey).update({
          sos: false,
          pool: false,
          timestamp: Math.floor(Date.now() / 1000)
        });
      }

      // ===== UI render =====
      const tbody = document.getElementById("tbody");

      function makeRow(idx, p) {
        const tr = document.createElement("tr");
        tr.className = "row";
        tr.id = "row_" + idx;
        tr.innerHTML = `
          <td>
            <div class="name">${p.label}</div>
            <div class="small muted">Firebase key: <span class="mono">${p.firebaseKey}</span></div>
          </td>
          <td><span class="badge offline">LOADING</span></td>
          <td class="hide-mobile"><span class="muted">Waiting for data…</span></td>
          <td class="right">
            <button data-clear="${p.firebaseKey}">Clear</button>
          </td>
        `;
        return tr;
      }

      people.forEach((p, idx) => tbody.appendChild(makeRow(idx, p)));

      document.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-clear]");
        if (!btn) return;
        clearAlerts(btn.getAttribute("data-clear"));
      });

      // ===== Live data =====
      const BEACON_OFFLINE_SECONDS = 12;
      const live = {}; // key -> { room, entered_at, last_seen, alerts }

      function computeState(p) {
        const v = live[p.firebaseKey] || {};
        const room = v.room || "";
        const enteredAt = v.entered_at || null;
        const lastSeen = v.last_seen || 0;
        const alerts = v.alerts || {};

        const now = Math.floor(Date.now()/1000);
        const dwell = (enteredAt && enteredAt > 0) ? (now - enteredAt) : 0;
        const dwellStr = enteredAt ? formatDuration(dwell) : "--:--";

        // Emergency first
        if (alerts.sos === true) {
          return { kind:"emergency", note:`SOS triggered${room ? " • " + room : ""}` };
        }
        if (alerts.pool === true) {
          return { kind:"emergency", note:`Pool alarm${room ? " • " + room : ""}` };
        }

        // Offline / no signal
        const offline = (!lastSeen) || ((now - lastSeen) > BEACON_OFFLINE_SECONDS);
        if (offline) {
          const age = lastSeen ? (now - lastSeen) : null;
          return {
            kind:"offline",
            note: age === null ? "No signal yet" : `${room ? room + " • " : ""}No signal (${age}s)${enteredAt && room ? ` • was there ${dwellStr}` : ""}`
          };
        }

        if (!room) return { kind:"check", note:"No room reported" };

        return { kind:"good", note:`${room} • ${dwellStr}` };
      }

      function paintRow(idx, p) {
        const row = document.getElementById("row_" + idx);
        if (!row) return;

        const st = computeState(p);

        const badge = row.querySelector(".badge");
        badge.className = "badge " + st.kind;
        badge.textContent = badgeText(st.kind, "CHECK");

        const note = row.querySelector(".hide-mobile .muted");
        if (note) note.textContent = st.note || "";

        if (st.kind === "offline") row.classList.add("rowOffline");
        else row.classList.remove("rowOffline");
      }

      function anyEmergency() {
        return people.some(p => {
          const v = live[p.firebaseKey] || {};
          const a = v.alerts || {};
          return a.sos === true || a.pool === true;
        });
      }

      // Subscribe
      people.forEach((p, idx) => {
        db.ref("/beacons/" + p.firebaseKey).on("value", snap => {
          const val = snap.val() || {};
          live[p.firebaseKey] = live[p.firebaseKey] || {};
          live[p.firebaseKey].room = val.room || "";
          live[p.firebaseKey].entered_at = val.entered_at || null;
          live[p.firebaseKey].last_seen = val.last_seen || 0;
          paintRow(idx, p);
        });

        db.ref("/alerts/" + p.firebaseKey).on("value", snap => {
          const val = snap.val() || {};
          live[p.firebaseKey] = live[p.firebaseKey] || {};
          live[p.firebaseKey].alerts = val || {};
          paintRow(idx, p);
          if (anyEmergency()) startAlarm(); else stopAlarm();
        });
      });

      // ===== System online badge via /system/lastDataRx =====
      let lastDataRx = 0;
      let updates = 0;
      const STALE_SECONDS = 8;

      const systemStatusEl = document.getElementById("systemStatus");
      const dataAgeEl = document.getElementById("dataAge");
      const updateCountEl = document.getElementById("updateCount");

      db.ref("/system/lastDataRx").on("value", (snap) => {
        lastDataRx = snap.val() || 0;
        updates++;
        updateCountEl.textContent = "Updates: " + updates;
      });

      function refreshSystemBadge() {
        const now = Math.floor(Date.now()/1000);
        const age = lastDataRx ? (now - lastDataRx) : null;
        const stale = (age === null) || (age > STALE_SECONDS);

        dataAgeEl.textContent = "Data age: " + (age === null ? "--" : (age + "s"));

        systemStatusEl.classList.remove("gray","green");
        if (stale) {
          systemStatusEl.textContent = "OFFLINE";
          systemStatusEl.classList.add("gray");
        } else {
          systemStatusEl.textContent = "ONLINE";
          systemStatusEl.classList.add("green");
        }
      }

      function tick() {
        document.getElementById("clock").textContent = new Date().toLocaleString();
        people.forEach((p, idx) => paintRow(idx, p));
        refreshSystemBadge();
        if (anyEmergency()) startAlarm(); else stopAlarm();
      }

      setInterval(tick, 1000);
      tick();

    } catch (e) {
      showError(e && e.message ? e.message : String(e));
      console.error(e);
    }
  })();
  </script>
</body>
</html>
