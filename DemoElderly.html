<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!--
    UltraWatch
    Build: DEMO-ELDERLY v0.4.0
    Last Updated: 2025-12-30
  -->

  <title>UltraWatch — Elderly Care</title>

  <!-- Leaflet (free) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.07);
      --panel2:rgba(255,255,255,.10);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.72);
      --line:rgba(255,255,255,.12);
      --good:#4ade80;
      --warn:#facc15;
      --bad:#fb7185;
      --accent:#60a5fa;
      --radius:18px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    /* ===== Build Banner (internal) ===== */
    .build{
      background:rgba(96,165,250,.15);
      border:1px solid rgba(96,165,250,.35);
      color:#cfe3ff;
      padding:8px 12px;
      border-radius:12px;
      font-size:12px;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .build b{font-weight:800}

    /* ===== Header ===== */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      margin-bottom:12px;
    }
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .btn{
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      padding:9px 12px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn.danger{
      border-color:rgba(251,113,133,.45);
      background:rgba(251,113,133,.12);
    }

    /* ===== Layout ===== */
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:980px){
      .grid{grid-template-columns:320px 1.25fr .75fr}
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      overflow:hidden;
    }

    /* ===== Tabs ===== */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .tab{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.15);
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      border-color:rgba(96,165,250,.55);
      background:rgba(96,165,250,.16);
      color:var(--text);
    }

    /* ===== People list ===== */
    .search{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
    }
    .search input{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
    }
    .list{max-height:620px;overflow:auto}
    .person{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      cursor:pointer;
    }
    .person:hover{background:rgba(255,255,255,.03)}
    .person.active{background:rgba(96,165,250,.12)}
    .pname{font-weight:800}
    .pmeta{color:var(--muted);font-size:12px;margin-top:2px}
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      height:fit-content;
    }
    .dot{width:9px;height:9px;border-radius:50%;background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    /* ===== Status / Pills ===== */
    .status{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.15);
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* ===== View Tabs (Dashboard/Timeline) ===== */
    .viewTabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .viewTab{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.15);
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .viewTab.active{
      border-color:rgba(96,165,250,.55);
      background:rgba(96,165,250,.16);
      color:var(--text);
      font-weight:800;
    }

    /* ===== Floor / Map ===== */
    .floor,.mapWrap{
      height:380px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
      margin-top:12px;
    }
    .room{
      position:absolute;
      border:1px dashed rgba(255,255,255,.25);
      border-radius:14px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .pin{
      position:absolute;
      width:14px;height:14px;border-radius:50%;
      background:var(--good);
      box-shadow:0 0 0 6px rgba(74,222,128,.18);
    }
    .pin.warn{background:var(--warn);box-shadow:0 0 0 6px rgba(250,204,21,.18)}
    .pin.bad{background:var(--bad);box-shadow:0 0 0 6px rgba(251,113,133,.20)}

    .mapTag{
      position:absolute;left:12px;top:12px;
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      font-size:12px;color:var(--muted);background:rgba(0,0,0,.35);
      z-index:5;
    }
    .mapMeta{
      position:absolute;left:12px;bottom:12px;
      display:flex;gap:8px;flex-wrap:wrap;
      z-index:5;
    }
    .mapControls{
      position:absolute;right:12px;top:12px;
      display:flex;gap:8px;flex-wrap:wrap;
      z-index:5;
    }

    #leafletMap{
      position:absolute;
      inset:0;
    }

    .leaflet-control-zoom a{
      background:rgba(20,26,40,.85) !important;
      color:var(--text) !important;
      border:1px solid rgba(255,255,255,.12) !important;
    }
    .leaflet-control-attribution{
      background:rgba(20,26,40,.65) !important;
      color:rgba(233,238,252,.72) !important;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      padding:2px 6px;
    }

    /* ===== Timeline ===== */
    .timeline{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }
    .timelineHead{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:12px;
      background:rgba(0,0,0,.15);
      border-bottom:1px solid var(--line);
    }
    .timelineBody{
      max-height:360px;
      overflow:auto;
      padding:0 12px;
    }
    .tlRow{
      display:grid;
      grid-template-columns:92px 1fr 120px;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid var(--line);
      align-items:start;
    }
    .tlTime{color:var(--muted);font-size:12px}
    .tlMsg{font-weight:800}
    .tlLoc{color:var(--muted);font-size:12px;text-align:right}

    /* ===== Activity ===== */
    .log{max-height:620px;overflow:auto}
    .evt{
      display:flex;justify-content:space-between;gap:12px;
      padding:9px 0;border-bottom:1px solid var(--line);
    }
    .evt .t{font-size:12px;color:var(--muted)}

    /* ===== Alert Modal ===== */
    .alert{
      display:none;
      position:fixed;inset:0;
      background:rgba(0,0,0,.7);
      padding:16px;
      z-index:50;
    }
    .alertBox{
      max-width:560px;
      margin:80px auto;
      background:rgba(20,26,40,.98);
      border:1px solid var(--line);
      border-radius:22px;
      padding:16px;
    }
    .alertBox h2{margin:0 0 6px 0}
    .alertBox .sub{margin:0}

    footer{
      margin-top:16px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- Build Banner (your internal reference) -->
  <div class="build">
    <div><b>UltraWatch</b> — Build <b>DEMO-ELDERLY v0.4.0</b></div>
    <div>Updated: <b>Dec 30, 2025</b></div>
  </div>

  <!-- Header -->
  <div class="header">
    <div>
      <h1>Elderly Care Dashboard</h1>
      <div class="sub">In-home awareness, safety alerts, and caregiver confidence</div>
      <div class="tabs" id="tabs"></div>
    </div>

    <div class="row">
      <a class="btn" href="DemoIndex.html">← Back</a>
      <button class="btn" onclick="simulateMove()">Move Room</button>
      <button class="btn" onclick="simulateLinger()">Linger</button>
      <button class="btn danger" onclick="simulateSOS()">SOS</button>
      <button class="btn" onclick="simulateNotSeen()">Not Seen</button>
      <button class="btn danger" onclick="testSOS()">Test SOS</button>
    </div>
  </div>

  <div class="grid">

    <!-- People List -->
    <div class="card">
      <div class="search">
        <input id="search" placeholder="Search people…" oninput="renderPeople()" />
      </div>
      <div class="sub" style="margin-bottom:10px">Monitored People</div>
      <div class="list" id="peopleList"></div>
    </div>

    <!-- Main View -->
    <div class="card">

      <div class="status">
        <div>
          <div id="name" style="font-weight:900;font-size:16px">—</div>
          <div class="sub">
            Battery <span id="battery">—</span> • Last update <span id="lastSeen">—</span> • Last sensor <span id="lastSensor">—</span>
          </div>
        </div>
        <div class="row">
          <span class="pill"><span id="stateDot" class="dot"></span><span id="stateText">OK</span></span>
          <span class="pill">Status: <b id="statusText">Home</b></span>
          <span class="pill">Room: <b id="room">—</b></span>
          <span class="pill">Time: <b id="time">—</b></span>
        </div>
      </div>

      <!-- View Tabs -->
      <div class="viewTabs">
        <div id="vtDashboard" class="viewTab active" onclick="setMainView('dashboard')">Dashboard</div>
        <div id="vtTimeline" class="viewTab" onclick="setMainView('timeline')">Timeline</div>
      </div>

      <!-- DASHBOARD VIEW -->
      <div id="mainDashboard">

        <!-- Floorplan -->
        <div id="floor" class="floor">
          <div class="room" style="left:18px;top:18px;width:42%;height:28%">Bedroom</div>
          <div class="room" style="left:52%;top:18px;width:40%;height:28%">Bathroom</div>
          <div class="room" style="left:18px;top:54%;width:42%;height:40%">Living Room</div>
          <div class="room" style="left:52%;top:54%;width:40%;height:40%">Kitchen</div>
          <div class="room" style="left:38%;top:46%;width:24%;height:8%;text-align:center">Front Door</div>
          <div id="pin" class="pin" style="left:72%;top:76%"></div>
        </div>

        <!-- Map View (Leaflet) -->
        <div id="mapWrap" class="mapWrap" style="display:none">
          <div class="mapTag">Map View</div>

          <div class="mapControls">
            <button class="btn" onclick="centerSelectedOnMap()">Center</button>
            <button class="btn" onclick="fitAwayOnMap()">Fit Away</button>
          </div>

          <div class="mapMeta">
            <span class="pill">Selected: <b id="gpsSelectedName">—</b></span>
            <span class="pill">GPS: <b id="gpsLatLng">—</b></span>
            <span class="pill">Accuracy: <b id="gpsAcc">—</b></span>
            <span class="pill">Updated: <b id="gpsUpdated">—</b></span>
          </div>

          <div id="leafletMap"></div>
        </div>

      </div>

      <!-- TIMELINE VIEW -->
      <div id="mainTimeline" style="display:none">
        <div class="timeline">
          <div class="timelineHead">
            <div>
              <div style="font-weight:900">Timeline</div>
              <div class="sub">Recent activity for the selected person</div>
            </div>
            <div class="row">
              <span class="pill">Range: <b>Last 24 Hours</b></span>
              <button class="btn" onclick="refreshTimeline()">Refresh</button>
            </div>
          </div>
          <div class="timelineBody" id="timelineBody"></div>
        </div>
      </div>

    </div>

    <!-- Activity (quick feed) -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div style="font-weight:900">Activity</div>
          <div class="sub">Recent events for the selected person</div>
        </div>
        <button class="btn" onclick="clearActivity()">Clear</button>
      </div>
      <div style="height:10px"></div>
      <div class="log" id="log"></div>
    </div>

  </div>

  <footer>
    <div>UltraWatch © 2025</div>
    <div>Demo Version</div>
  </footer>

</div>

<!-- Alert Modal -->
<div id="alert" class="alert" onclick="dismissAlert()">
  <div class="alertBox" onclick="event.stopPropagation()">
    <h2 id="alertTitle">Alert</h2>
    <p id="alertBody" class="sub">Message</p>
    <div style="height:12px"></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" onclick="dismissAlert()">Dismiss</button>
    </div>
  </div>
</div>

<script>
  // =========================
  // Demo Data
  // =========================
  const ROOMS = ["Kitchen","Living Room","Bathroom","Bedroom","Front Door"];
  const ROOM_POS = {
    "Bedroom": {l:"28%",t:"24%"},
    "Bathroom": {l:"72%",t:"24%"},
    "Living Room": {l:"28%",t:"76%"},
    "Kitchen": {l:"72%",t:"76%"},
    "Front Door": {l:"50%",t:"49%"},
    "": {l:"50%",t:"49%"}
  };

  // Demo GPS baseline (Orlando-ish) for "away" mode
  const BASE_GPS = { lat: 28.538336, lng: -81.379234 };

  // 20 monitored people
  const people = [
    { id:"p1", name:"Jack Erickson", room:"Kitchen", lastSensor:"Kitchen", battery:82, status:"Home", state:"ok", lastSeenSec:2, timeInRoom:"00:12:43",
      gps:{ lat: BASE_GPS.lat+0.0021, lng: BASE_GPS.lng-0.0014, accM:18, updatedAt:Date.now() } },
    { id:"p2", name:"Christine Visalli", room:"Living Room", lastSensor:"Living Room", battery:76, status:"Home", state:"ok", lastSeenSec:4, timeInRoom:"00:08:19",
      gps:{ lat: BASE_GPS.lat+0.0012, lng: BASE_GPS.lng-0.0006, accM:22, updatedAt:Date.now() } },
    { id:"p3", name:"Dail Skogstrom", room:"Bedroom", lastSensor:"Bedroom", battery:64, status:"Home", state:"ok", lastSeenSec:7, timeInRoom:"01:02:11",
      gps:{ lat: BASE_GPS.lat+0.0033, lng: BASE_GPS.lng-0.0020, accM:15, updatedAt:Date.now() } },
    { id:"p4", name:"Amada Morales", room:"Bathroom", lastSensor:"Bathroom", battery:71, status:"Home", state:"ok", lastSeenSec:3, timeInRoom:"00:04:52",
      gps:{ lat: BASE_GPS.lat+0.0007, lng: BASE_GPS.lng-0.0011, accM:25, updatedAt:Date.now() } },

    ...[
      "Evelyn Carter","Harold Bennett","Rosa Delgado","Stanley Young","Martha Price",
      "Arthur Lee","Nina Kim","Frank Owens","Olivia Stone","Paul Rivera",
      "Linda Chavez","George Miles","Patricia Hall","Victor Nguyen","Teresa Brooks","Samuel Wright"
    ].map((n,i)=>({
      id:"p"+(i+5),
      name:n,
      room: (i%4===0)?"Kitchen":(i%4===1)?"Living Room":(i%4===2)?"Bedroom":"Bathroom",
      lastSensor: (i%4===0)?"Kitchen":(i%4===1)?"Living Room":(i%4===2)?"Bedroom":"Bathroom",
      battery: 55 + (i*2 % 40),
      status:"Home",
      state:"ok",
      lastSeenSec: 3 + (i%10),
      timeInRoom: "00:" + String(5+i).padStart(2,"0") + ":" + String(10+i*3%60).padStart(2,"0"),
      gps:{ lat: BASE_GPS.lat + 0.001 + (i*0.00035), lng: BASE_GPS.lng - 0.001 + (i*0.00025), accM: 14 + (i%18), updatedAt: Date.now() }
    }))
  ];

  let selectedId = "p1";

  // Activity per person (live feed)
  const activity = {};
  people.forEach(p => activity[p.id] = [
    { msg:"System online", t:timeNow(), room:p.room || "" }
  ]);

  // Timeline per person (24h-style)
  const timeline = {};
  people.forEach(p => timeline[p.id] = generateDemoTimeline(p));

  // Main view mode: 'dashboard' or 'timeline'
  let mainView = "dashboard";

  // =========================
  // Alarm (audible)
  // =========================
  let audioCtx = null;
  let osc = null;
  let gain = null;
  let alarmTimer = null;

  function startAlarm(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === "suspended") audioCtx.resume();
      if(alarmTimer) return;

      gain = audioCtx.createGain();
      gain.gain.value = 0.0001;
      gain.connect(audioCtx.destination);

      osc = audioCtx.createOscillator();
      osc.type = "square";
      osc.frequency.value = 880;
      osc.connect(gain);
      osc.start();

      alarmTimer = setInterval(() => {
        const now = audioCtx.currentTime;
        gain.gain.cancelScheduledValues(now);
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.linearRampToValueAtTime(0.12, now + 0.01);
        gain.gain.linearRampToValueAtTime(0.0001, now + 0.25);
      }, 350);
    }catch(e){
      console.log("Alarm audio error:", e);
    }
  }

  function stopAlarm(){
    try{
      if(alarmTimer){ clearInterval(alarmTimer); alarmTimer = null; }
      if(osc){ osc.stop(); osc.disconnect(); osc = null; }
      if(gain){ gain.disconnect(); gain = null; }
    }catch(e){
      console.log("Stop alarm error:", e);
    }
  }

  // =========================
  // Leaflet Map (multi-person)
  // =========================
  let map = null;
  let mapInitialized = false;
  let awayLayer = null;
  let selectedAccuracy = null;

  function initMapOnce(){
    if(mapInitialized) return;
    mapInitialized = true;

    map = L.map('leafletMap', { zoomControl:true }).setView([BASE_GPS.lat, BASE_GPS.lng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    awayLayer = L.layerGroup().addTo(map);

    // Accuracy ring for selected person (always one)
    selectedAccuracy = L.circle([BASE_GPS.lat, BASE_GPS.lng], {
      radius: 20,
      color: '#60a5fa',
      weight: 1,
      fillColor: '#60a5fa',
      fillOpacity: 0.12
    }).addTo(map);
  }

  function stateColor(state){
    return (state==="bad") ? "#fb7185" : (state==="warn") ? "#facc15" : "#4ade80";
  }

  function updateAwayLayer(){
    initMapOnce();
    awayLayer.clearLayers();

    const awayPeople = people.filter(p => p.status === "Left Home");
    awayPeople.forEach(p => {
      if(!p.gps) return;

      const isSelected = (p.id === selectedId);
      const radius = isSelected ? 10 : 7;
      const weight = isSelected ? 3 : 2;

      const marker = L.circleMarker([p.gps.lat, p.gps.lng], {
        radius,
        color: '#ffffff',
        weight,
        fillColor: stateColor(p.state),
        fillOpacity: 0.95
      }).addTo(awayLayer);

      marker.bindTooltip(p.name, { direction:"top", opacity:0.9 });

      marker.on('click', () => {
        selectPerson(p.id);
        setMainView('dashboard'); // clicking on a dot jumps to that person
      });
    });
  }

  function updateSelectedMapMeta(p, pan=false){
    initMapOnce();

    document.getElementById("gpsSelectedName").textContent = p.name;

    if(!p.gps){
      document.getElementById("gpsLatLng").textContent = "—";
      document.getElementById("gpsAcc").textContent = "—";
      document.getElementById("gpsUpdated").textContent = "—";
      return;
    }

    const lat = p.gps.lat;
    const lng = p.gps.lng;
    const acc = p.gps.accM ?? 20;

    document.getElementById("gpsLatLng").textContent = lat.toFixed(6) + ", " + lng.toFixed(6);
    document.getElementById("gpsAcc").textContent = acc + " m";
    const secs = Math.max(0, Math.round((Date.now() - p.gps.updatedAt) / 1000));
    document.getElementById("gpsUpdated").textContent = secs + "s ago";

    selectedAccuracy.setLatLng([lat,lng]);
    selectedAccuracy.setRadius(acc);

    if(pan){
      map.setView([lat,lng], Math.max(map.getZoom(), 15));
    }

    setTimeout(() => map.invalidateSize(), 50);
  }

  function centerSelectedOnMap(){
    const p = getSelected();
    if(!p.gps) return;
    initMapOnce();
    map.setView([p.gps.lat, p.gps.lng], Math.max(map.getZoom(), 15));
  }

  function fitAwayOnMap(){
    initMapOnce();
    const awayPeople = people.filter(p => p.status === "Left Home" && p.gps);
    if(!awayPeople.length) return;

    const bounds = L.latLngBounds(awayPeople.map(p => [p.gps.lat, p.gps.lng]));
    map.fitBounds(bounds.pad(0.2));
  }

  // Demo “movement” when away: jitter GPS
  function jitterGps(p){
    if(!p.gps) p.gps = { lat: BASE_GPS.lat, lng: BASE_GPS.lng, accM: 20, updatedAt: Date.now() };
    const dLat = (Math.random() - 0.5) * 0.00018;
    const dLng = (Math.random() - 0.5) * 0.00018;
    p.gps.lat += dLat;
    p.gps.lng += dLng;
    p.gps.accM = 12 + Math.floor(Math.random() * 25);
    p.gps.updatedAt = Date.now();
  }

  // =========================
  // Rendering / Views
  // =========================
  function timeNow(){ return new Date().toLocaleTimeString(); }
  function getSelected(){ return people.find(p => p.id === selectedId); }

  function setMainView(mode){
    mainView = mode;

    document.getElementById("vtDashboard").classList.toggle("active", mode==="dashboard");
    document.getElementById("vtTimeline").classList.toggle("active", mode==="timeline");

    document.getElementById("mainDashboard").style.display = (mode==="dashboard") ? "block" : "none";
    document.getElementById("mainTimeline").style.display = (mode==="timeline") ? "block" : "none";

    // Make sure timeline is current for selection
    if(mode==="timeline"){
      renderTimeline();
    }else{
      renderMain(); // refresh dashboard toggles
    }
  }

  function renderTabs(){
    const tabs = document.getElementById("tabs");
    tabs.innerHTML = "";
    const quick = people.slice(0, 6);
    quick.forEach(p => {
      const el = document.createElement("div");
      el.className = "tab" + (p.id === selectedId ? " active" : "");
      el.innerHTML = `<span class="dot ${p.state==='warn'?'warn':p.state==='bad'?'bad':''}"></span>${escapeHtml(p.name)}`;
      el.onclick = () => selectPerson(p.id);
      tabs.appendChild(el);
    });
  }

  function renderPeople(){
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    const list = document.getElementById("peopleList");
    list.innerHTML = "";

    people
      .filter(p => !q || p.name.toLowerCase().includes(q))
      .forEach(p => {
        const el = document.createElement("div");
        el.className = "person" + (p.id === selectedId ? " active" : "");
        const stateDot = p.state === "warn" ? "warn" : p.state === "bad" ? "bad" : "";
        const right = (p.status === "Left Home")
          ? `<span class="badge"><span class="dot ${stateDot}"></span>Left Home</span>`
          : `<span class="badge"><span class="dot ${stateDot}"></span>${escapeHtml(p.room || "—")}</span>`;

        el.innerHTML = `
          <div>
            <div class="pname">${escapeHtml(p.name)}</div>
            <div class="pmeta">Battery ${p.battery}% • Last ${p.lastSeenSec}s • Sensor ${escapeHtml(p.lastSensor || "—")}</div>
          </div>
          ${right}
        `;
        el.onclick = () => selectPerson(p.id);
        list.appendChild(el);
      });
  }

  function renderMain(){
    const p = getSelected();
    document.getElementById("name").textContent = p.name;
    document.getElementById("battery").textContent = p.battery + "%";
    document.getElementById("lastSeen").textContent = p.lastSeenSec + "s ago";
    document.getElementById("lastSensor").textContent = p.lastSensor || "—";
    document.getElementById("room").textContent = p.room || "—";
    document.getElementById("time").textContent = p.timeInRoom || "—";
    document.getElementById("statusText").textContent = p.status;

    const sd = document.getElementById("stateDot");
    sd.className = "dot" + (p.state==="warn" ? " warn" : p.state==="bad" ? " bad" : "");
    document.getElementById("stateText").textContent =
      p.state==="ok" ? "OK" : p.state==="warn" ? "LINGER" : "ALERT";

    // Floor pin
    const pin = document.getElementById("pin");
    pin.className = "pin" + (p.state==="warn" ? " warn" : p.state==="bad" ? " bad" : "");
    const pos = ROOM_POS[p.room || ""] || ROOM_POS[""];
    pin.style.left = pos.l;
    pin.style.top = pos.t;

    // Show map if away/left home
    const showMap = (p.status === "Left Home") || (p.lastSeenSec >= 30 && p.lastSensor === "Front Door");
    document.getElementById("floor").style.display = showMap ? "none" : "block";
    document.getElementById("mapWrap").style.display = showMap ? "block" : "none";

    if(showMap){
      updateAwayLayer();                 // multi-person dots
      updateSelectedMapMeta(p, true);    // selected meta + accuracy ring
    }

    renderActivity();
  }

  function addEvent(pid, msg, room=""){
    if(!activity[pid]) activity[pid] = [];
    activity[pid].push({ msg, t: timeNow(), room });
  }

  function renderActivity(){
    const p = getSelected();
    const log = document.getElementById("log");
    log.innerHTML = "";
    (activity[p.id] || []).slice().reverse().forEach(e => {
      const row = document.createElement("div");
      row.className = "evt";
      row.innerHTML = `<div><b>${escapeHtml(e.msg)}</b></div><div class="t">${escapeHtml(e.t)}</div>`;
      log.appendChild(row);
    });
    log.scrollTop = log.scrollHeight;
  }

  function clearActivity(){
    const p = getSelected();
    activity[p.id] = [];
    addEvent(p.id, "Activity cleared", p.room || "");
    renderActivity();
  }

  function selectPerson(pid){
    selectedId = pid;
    renderTabs();
    renderPeople();

    if(mainView === "timeline"){
      renderTimeline();
    }else{
      renderMain();
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  // =========================
  // Timeline
  // =========================
  function generateDemoTimeline(p){
    // Build a believable last-24h pattern (pure demo)
    const now = Date.now();
    const entries = [];

    function add(hoursAgo, msg, room){
      const t = new Date(now - hoursAgo*3600*1000);
      entries.push({
        ts: t.getTime(),
        time: t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
        msg, room
      });
    }

    // A simple daily story:
    add(23.5, "Overnight monitoring active", "Bedroom");
    add(7.8,  "Room update — Bathroom", "Bathroom");
    add(7.5,  "Room update — Kitchen", "Kitchen");
    add(6.0,  "Routine check-in complete", "Kitchen");
    add(4.2,  "Room update — Living Room", "Living Room");
    add(3.7,  "Room update — Kitchen", "Kitchen");

    // Inject current state near “now”
    add(0.6,  "Room update — " + (p.room || "Kitchen"), p.room || "Kitchen");
    add(0.1,  "Last seen update received", p.room || "");

    // If away, add a leave-home event
    if(p.status === "Left Home"){
      add(1.2, "Front Door activity detected", "Front Door");
      add(1.0, "Not detected after Front Door — marked as Left Home", "Front Door");
      add(0.8, "GPS tracking active", "Away");
    }

    // Sort newest first for display
    entries.sort((a,b)=>b.ts-a.ts);
    return entries;
  }

  function renderTimeline(){
    const p = getSelected();

    // Ensure timeline exists and stays reasonable when state changes
    timeline[p.id] = generateDemoTimeline(p);

    const body = document.getElementById("timelineBody");
    body.innerHTML = "";

    timeline[p.id].forEach(e => {
      const row = document.createElement("div");
      row.className = "tlRow";
      row.innerHTML = `
        <div class="tlTime">${escapeHtml(e.time)}</div>
        <div class="tlMsg">${escapeHtml(e.msg)}</div>
        <div class="tlLoc">${escapeHtml(e.room || "")}</div>
      `;
      body.appendChild(row);
    });
  }

  function refreshTimeline(){
    renderTimeline();
  }

  // =========================
  // Simulations
  // =========================
  function simulateMove(){
    const p = getSelected();
    if(p.status === "Left Home"){
      // bring back home via front door
      p.status = "Home";
      p.lastSeenSec = 2;
      p.lastSensor = "Front Door";
      p.room = "Front Door";
      p.timeInRoom = "00:00:02";
      p.state = "ok";
      addEvent(p.id, "Returned home — Front Door", "Front Door");
      timeline[p.id] = generateDemoTimeline(p);
      renderTabs(); renderPeople();
      (mainView==="timeline") ? renderTimeline() : renderMain();
      return;
    }

    const i = Math.max(0, ROOMS.indexOf(p.room));
    const next = ROOMS[(i + 1) % ROOMS.length];
    p.room = next;
    p.lastSensor = next;
    p.lastSeenSec = 2;
    p.timeInRoom = "00:00:05";
    p.state = "ok";
    addEvent(p.id, "Room update — " + next, next);
    timeline[p.id] = generateDemoTimeline(p);

    renderTabs(); renderPeople();
    (mainView==="timeline") ? renderTimeline() : renderMain();
  }

  function simulateLinger(){
    const p = getSelected();
    p.state = "warn";
    addEvent(p.id, "Linger alert triggered", p.room || "");
    showAlert("Linger Alert", `${p.name} has remained in ${p.room} longer than expected.`);
    startAlarm();
    timeline[p.id] = generateDemoTimeline(p);

    renderTabs(); renderPeople();
    (mainView==="timeline") ? renderTimeline() : renderMain();
  }

  function simulateSOS(){
    const p = getSelected();
    triggerSOSFor(p.id);
  }

  function simulateNotSeen(){
    const p = getSelected();
    p.lastSeenSec = 45;

    if(p.lastSensor === "Front Door"){
      p.status = "Left Home";
      p.room = "";
      jitterGps(p);
      addEvent(p.id, "Not detected after Front Door — marked as Left Home", "Front Door");
    }else{
      p.state = "warn";
      addEvent(p.id, "Beacon not detected — switching to map view", p.room || "");
    }

    timeline[p.id] = generateDemoTimeline(p);

    renderTabs(); renderPeople();
    (mainView==="timeline") ? renderTimeline() : renderMain();
  }

  function triggerSOSFor(pid){
    const p = people.find(x => x.id === pid);
    p.state = "bad";
    addEvent(pid, "Emergency alert — SOS triggered", p.room || "");
    selectedId = pid;

    timeline[p.id] = generateDemoTimeline(p);

    renderTabs(); renderPeople();
    (mainView==="timeline") ? renderTimeline() : renderMain();

    showAlert("Emergency Alert", `SOS triggered for ${p.name}. Caregiver notified.`);
    startAlarm();
  }

  function testSOS(){
    const idx = Math.floor(Math.random() * people.length);
    triggerSOSFor(people[idx].id);
  }

  // =========================
  // Alert modal
  // =========================
  function showAlert(title, body){
    document.getElementById("alertTitle").textContent = title;
    document.getElementById("alertBody").textContent = body;
    document.getElementById("alert").style.display = "block";
  }

  function dismissAlert(){
    document.getElementById("alert").style.display = "none";
    stopAlarm();
  }

  // =========================
  // Lightweight “live” feel
  // =========================
  setInterval(() => {
    people.forEach(p => {
      p.lastSeenSec = Math.min(999, p.lastSeenSec + 1);

      if(p.status === "Left Home"){
        jitterGps(p);
      }
    });

    // If map visible, keep dots moving
    const p = getSelected();
    const showMap = (p.status === "Left Home") || (p.lastSeenSec >= 30 && p.lastSensor === "Front Door");
    if(showMap){
      updateAwayLayer();
      updateSelectedMapMeta(p, false);
    }

    // Keep the list feeling alive
    renderTabs();
    renderPeople();

    // Update main area depending on view
    if(mainView === "timeline"){
      // timeline is "snapshotty" — refresh lightly
      renderTimeline();
    }else{
      renderMain();
    }

  }, 3000);

  // Initial render
  renderTabs();
  renderPeople();
  renderMain();
  setMainView("dashboard");
</script>

</body>
</html>
