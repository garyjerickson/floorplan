<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!--
    UltraWatch
    Build: JACK-ONLY v1.2.0
    Last Updated: 2026-01-08

    Live reads:
      /beacons/GRANDPA  -> room, entered_at, last_seen, last_sensor (optional), battery (optional)
      /alerts/GRANDPA   -> sos, pool, timestamp
      /gps/GRANDPA      -> lat, lng OR lon, accM/accuracyM/accuracy, updatedAt/timestamp
      /messages/GRANDPA -> {text,timestamp,...} (last 20)
      /logs/GRANDPA     -> room intervals (timeline/history)
      /system/heartbeat -> epoch seconds (or ms) heartbeat
  -->

  <title>UltraWatch ‚Äî Jack Erickson</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.07);
      --panel2:rgba(255,255,255,.10);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.72);
      --line:rgba(255,255,255,.12);
      --good:#4ade80;
      --warn:#facc15;
      --bad:#fb7185;
      --accent:#60a5fa;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }

    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px;
      max-width:520px;
      margin:0 auto;
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      overflow:hidden;
    }

    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .title{display:flex;flex-direction:column;gap:4px;}
    .title h1{margin:0;font-size:18px;letter-spacing:.2px;line-height:1.15;}
    .sub{color:var(--muted);font-size:12px;line-height:1.3;}

    .actions{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      padding:9px 12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      font-size:12px;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn.danger{
      border-color:rgba(251,113,133,.45);
      background:rgba(251,113,133,.12);
    }

    .pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;color:var(--muted);
      white-space:nowrap;background:rgba(0,0,0,.10);
    }
    .pill b{color:var(--text)}
    .dot{width:9px;height:9px;border-radius:50%;background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tab{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.15);
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      font-weight:900;
    }
    .tab.active{
      border-color:rgba(96,165,250,.55);
      background:rgba(96,165,250,.16);
      color:var(--text);
    }

    .bigStatus{margin-top:10px;display:grid;grid-template-columns:1fr;gap:10px;}
    .hero{
      border:1px solid rgba(96,165,250,.45);
      border-radius:16px;
      padding:14px;
      background:linear-gradient(180deg, rgba(96,165,250,.16), rgba(0,0,0,.18));
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      box-shadow: 0 6px 22px rgba(0,0,0,.35);
      position:relative;
    }
    .hero::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:4px;
      background:rgba(96,165,250,.85);
      border-radius:16px 0 0 16px;
    }
    .hero.warn{
      background:linear-gradient(180deg, rgba(250,204,21,.20), rgba(0,0,0,.18));
      border-color:rgba(250,204,21,.55);
    }
    .hero.warn::before{ background:rgba(250,204,21,.9); }
    .hero.bad{
      background:linear-gradient(180deg, rgba(251,113,133,.20), rgba(0,0,0,.18));
      border-color:rgba(251,113,133,.55);
    }
    .hero.bad::before{ background:rgba(251,113,133,.9); }

    .heroLeft{display:flex;flex-direction:column;gap:3px;min-width:0;}
    .heroLabel{color:var(--muted);font-size:12px}
    .heroValue{
      font-size:26px;font-weight:950;line-height:1.05;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .heroRight{display:flex;flex-direction:column;align-items:flex-end;gap:4px;text-align:right;}
    .heroRight .mini{font-size:12px;color:var(--muted);}

    /* Messages & History list */
    .listBox{
      max-height:180px;
      overflow:auto;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.10);
      padding:8px 10px;
    }
    .evt{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:8px 0;
      border-bottom:1px solid rgba(255,255,255,.08);
      align-items:flex-start;
    }
    .evt:last-child{border-bottom:none}
    .evt .t{font-size:12px;color:var(--muted);white-space:nowrap}
    .evt .msg{font-weight:900}
    .evt .meta{font-size:12px;color:var(--muted);margin-top:2px}

    /* Settings rows */
    .setRow{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.15);
      margin-top:10px;
    }
    .setRow .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .input{
      width:110px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:14px;
      padding:10px 10px;
      outline:none;
      text-align:right;
      font-weight:900;
    }
    .toggle{
      width:52px;height:30px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      position:relative;cursor:pointer;flex:0 0 auto;
    }
    .knob{
      width:22px;height:22px;border-radius:999px;
      position:absolute;top:50%;left:4px;
      transform:translateY(-50%);
      background:rgba(255,255,255,.85);
      transition:left .18s ease;
      box-shadow:0 6px 14px rgba(0,0,0,.35);
    }
    .toggle.on{
      background: rgba(96,165,250,.25);
      border-color: rgba(96,165,250,.55);
    }
    .toggle.on .knob{left:26px}

    /* Map */
    .mapCard{padding:10px;}
    .mapTop{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px;}
    .mapMeta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .mapWrap{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:rgba(0,0,0,.18);
      position:relative;
      height:38vh;
      min-height:240px;
      max-height:420px;
    }
    #leafletMap{position:absolute;inset:0;}

    .leaflet-control-zoom a{
      background:rgba(20,26,40,.85) !important;
      color:var(--text) !important;
      border:1px solid rgba(255,255,255,.12) !important;
    }
    .leaflet-control-attribution{
      background:rgba(20,26,40,.65) !important;
      color:rgba(233,238,252,.72) !important;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      padding:2px 6px;
    }

    /* Alert Modal */
    .alert{
      display:none;
      position:fixed;inset:0;
      background:rgba(0,0,0,.72);
      padding:16px;
      z-index:50;
    }
    .alertBox{
      max-width:560px;
      margin:80px auto;
      background:rgba(20,26,40,.98);
      border:1px solid var(--line);
      border-radius:22px;
      padding:16px;
    }
    .alertBox h2{margin:0 0 6px 0}
    .alertBox .sub{margin:0}
    #alertBody.sub{font-size:16px; line-height:1.35; color:var(--text); white-space:pre-line;}

    /* Alert type styling */
    .alertBox[data-kind="sos"]{
      border-color: rgba(251,113,133,.75);
      box-shadow: 0 0 0 2px rgba(251,113,133,.20), 0 18px 50px rgba(0,0,0,.55);
    }
    .alertBox[data-kind="linger"]{
      border-color: rgba(250,204,21,.75);
      box-shadow: 0 0 0 2px rgba(250,204,21,.18), 0 18px 50px rgba(0,0,0,.55);
    }
    .alertBox[data-kind="msg"]{
      border-color: rgba(96,165,250,.75);
      box-shadow: 0 0 0 2px rgba(96,165,250,.18), 0 18px 50px rgba(0,0,0,.55);
    }
    .alertBox[data-kind="offline"]{
      border-color: rgba(251,113,133,.75);
      box-shadow: 0 0 0 2px rgba(251,113,133,.18), 0 18px 50px rgba(0,0,0,.55);
    }
    .alertBox[data-kind="away"]{
      border-color: rgba(250,204,21,.75);
      box-shadow: 0 0 0 2px rgba(250,204,21,.18), 0 18px 50px rgba(0,0,0,.55);
    }

    .foot{
      display:flex;justify-content:space-between;gap:10px;
      align-items:center;color:var(--muted);font-size:12px;padding:0 2px;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- Top summary + Tabs -->
    <div class="card">
      <div class="topRow">
        <div class="title">
          <h1>Jack Erickson</h1>
          <div class="sub">UltraWatch ‚Äî Elderly Monitoring</div>
        </div>

        <div class="actions">
          <button class="btn" id="btnCenter" type="button">Center Map</button>
          <button class="btn danger" id="btnMute" type="button">Sound: ON</button>
        </div>
      </div>

      <div class="pills">
        <!-- ‚úÖ System online light -->
        <span class="pill"><span id="sysDot" class="dot"></span><b id="sysText">System Online</b></span>

        <span class="pill"><span id="stateDot" class="dot"></span><b id="stateText">OK</b></span>
        <span class="pill">Status: <b id="statusText">‚Äî</b></span>
        <span class="pill">Last seen: <b id="lastSeen">‚Äî</b></span>
        <span class="pill">Sensor: <b id="lastSensor">‚Äî</b></span>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="status">üè† Status</div>
        <div class="tab" data-tab="history">üïí History</div>
        <div class="tab" data-tab="settings">‚öôÔ∏è Settings</div>
      </div>

      <!-- STATUS TAB -->
      <div id="panel_status">
        <div class="bigStatus">
          <div class="hero">
            <div class="heroLeft">
              <div class="heroLabel">Current room</div>
              <div class="heroValue" id="room">‚Äî</div>
            </div>
            <div class="heroRight">
              <div class="mini">Time in room</div>
              <div style="font-weight:950;font-size:18px" id="timeInRoom">‚Äî</div>
            </div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:950">Messages from phone</div>
            <div class="sub">Recent quick-button messages from Jack‚Äôs app</div>
          </div>
          <button class="btn" onclick="clearMessages()">Clear</button>
        </div>

        <div style="height:8px"></div>
        <div class="listBox" id="msgLog">
          <div class="evt"><div><b>No messages yet</b></div><div class="t">‚Äî</div></div>
        </div>
      </div>

      <!-- HISTORY TAB -->
      <div id="panel_history" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div>
            <div style="font-weight:950">Room History</div>
            <div class="sub">From Firebase: <span style="opacity:.95">/logs/GRANDPA</span></div>
          </div>
          <button class="btn" id="btnRefreshHistory" type="button">Refresh</button>
        </div>

        <div style="height:8px"></div>
        <div class="listBox" id="historyList" style="max-height:260px">
          <div class="evt"><div><b>Loading‚Ä¶</b></div><div class="t">‚Äî</div></div>
        </div>

        <div class="sub" style="margin-top:8px">
          Tip: If you don‚Äôt see history, your Python logger may not be writing intervals to <span style="opacity:.95">/logs/GRANDPA</span> yet.
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="panel_settings" style="display:none">
        <div class="setRow">
          <div class="left">
            <div style="font-weight:950">Linger alerts</div>
            <div class="sub">Warn if Jack stays in a room longer than the limit</div>
          </div>
          <div class="toggle on" id="toggleLinger"><div class="knob"></div></div>
        </div>

        <div class="setRow">
          <div class="left">
            <div style="font-weight:950">Sound on linger</div>
            <div class="sub">Play alarm tone for linger warnings</div>
          </div>
          <div class="toggle" id="toggleLingerSound"><div class="knob"></div></div>
        </div>

        <div class="setRow">
          <div class="left">
            <div style="font-weight:950">Default limit</div>
            <div class="sub">Minutes if a room-specific limit is blank</div>
          </div>
          <input class="input" id="limitDefault" inputmode="numeric" pattern="[0-9]*" placeholder="min" />
        </div>

        <div class="sub" style="margin-top:10px;font-weight:950">Room limits (minutes)</div>

        <div class="setRow">
          <div class="left"><div style="font-weight:950">Bedroom</div><div class="sub">Typical longer stays</div></div>
          <input class="input" id="limitBedroom" inputmode="numeric" pattern="[0-9]*" placeholder="min" />
        </div>

        <div class="setRow">
          <div class="left"><div style="font-weight:950">Bathroom</div><div class="sub">Short stays expected</div></div>
          <input class="input" id="limitBathroom" inputmode="numeric" pattern="[0-9]*" placeholder="min" />
        </div>

        <div class="setRow">
          <div class="left"><div style="font-weight:950">Kitchen</div><div class="sub">Meals / drinks</div></div>
          <input class="input" id="limitKitchen" inputmode="numeric" pattern="[0-9]*" placeholder="min" />
        </div>

        <div class="setRow">
          <div class="left"><div style="font-weight:950">Living Room</div><div class="sub">Sitting / TV</div></div>
          <input class="input" id="limitLiving" inputmode="numeric" pattern="[0-9]*" placeholder="min" />
        </div>

        <div class="setRow">
          <div class="left"><div style="font-weight:950">Front Door</div><div class="sub">Short dwell expected</div></div>
          <input class="input" id="limitFrontDoor" inputmode="numeric" pattern="[0-9]*" placeholder="min" />
        </div>

        <div style="height:10px"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnSaveSettings" type="button">Save</button>
          <button class="btn" id="btnResetSettings" type="button">Reset</button>
        </div>

        <div class="sub" style="margin-top:8px">
          Settings are stored on this device (localStorage).
        </div>
      </div>
    </div>

    <!-- Map (bottom) -->
    <div class="card mapCard">
      <div class="mapTop">
        <div class="mapMeta">
          <span class="pill">GPS: <b id="gpsLatLng">‚Äî</b></span>
          <span class="pill">Acc: <b id="gpsAcc">‚Äî</b></span>
          <span class="pill">Updated: <b id="gpsUpdated">‚Äî</b></span>
        </div>
      </div>

      <div class="mapWrap" id="mapWrap" style="display:none">
        <div id="leafletMap"></div>
      </div>

      <div class="sub" id="gpsWaiting"
           style="text-align:center;padding:12px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.10)">
        Waiting for GPS‚Ä¶
      </div>
    </div>

    <div class="foot">
      <div>UltraWatch ¬© 2026</div>
      <div>Firebase: <b id="fbStatus">Connecting‚Ä¶</b></div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alert" class="alert" onclick="dismissAlert()">
    <div class="alertBox" id="alertBox" data-kind="msg" onclick="event.stopPropagation()">
      <h2 id="alertTitle">Alert</h2>
      <p id="alertBody" class="sub">Message</p>
      <div style="height:12px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap">

        <!-- Normal alerts use this -->
        <div id="alertBtnsDefault">
          <button class="btn" id="btnClearPopup" style="display:none" type="button">Clear</button>
          <button class="btn" onclick="dismissAlert()">Dismiss</button>
        </div>

        <!-- Confirm-clear uses this -->
        <div id="alertBtnsConfirm" style="display:none">
          <button class="btn danger" onclick="confirmClearAlarmYes()">Yes</button>
          <button class="btn" onclick="confirmClearAlarmNo()">No</button>
        </div>

      </div>
    </div>
  </div>

<script>
  // =========================
  // Constants
  // =========================
  const PERSON_NAME = "Jack Erickson";
  const FIREBASE_KEY = "GRANDPA";
  const firebaseConfig = { databaseURL: "https://ultrawatch-home-default-rtdb.firebaseio.com/" };
  const BASE_GPS = { lat: 28.538336, lng: -81.379234 };

  // Rooms you care about
  const ROOMS = ["Bedroom","Bathroom","Kitchen","Living Room","Front Door"];

  // Client "Away" threshold (seconds) ‚Äî your existing logic
  const OFFLINE_SEC = 12;

  // ‚úÖ Heartbeat stale threshold (seconds) for "System Offline"
  const HEARTBEAT_OFFLINE_SEC = 20;

  // =========================
  // State
  // =========================
  const jack = {
    name: PERSON_NAME,
    room: "",
    lastSensor: "",
    battery: null,
    status: "‚Äî",
    state: "ok",          // ok | warn | bad
    lastSeenSec: null,
    timeInRoom: "‚Äî",
    _entered_at: null,    // epoch seconds
    _last_seen: 0,        // epoch seconds
    _alerts: {},          // {sos,pool,...}
    gps: null             // {lat,lng,accM,updatedAt(ms)}
  };

  let liveJackMessages = [];
  let db = null;

  // =========================
  // Message popup tracking
  // =========================
  let lastMsgPopupTs = 0;
  let currentMsgKey = null;

  // Linger tracking (so we only alert once per room entry)
  let lingerAlertedForEnteredAt = null;

  // Linger snooze (2 minutes)
  let lingerSnoozeUntilMs = 0;

  // SOS/Pool "silence" (No = don't clear Firebase, but don't pop right back up)
  let emergencySnoozeUntilMs = 0;
  let alertMode = "default"; // "default" | "confirmClear"

  // =========================
  // ‚úÖ Heartbeat tracking
  // =========================
  let lastHeartbeatSec = 0;
  let systemOnline = true;

  // =========================
  // ‚úÖ Interval logging for Away / System Offline
  // Writes to /logs/GRANDPA as intervals, auto-closes on recovery
  // =========================
  let awayActive = false;
  let awaySinceSec = 0;
  let awayLogKey = null;

  let sysOfflineActive = false;
  let sysOfflineSinceSec = 0;
  let sysOfflineLogKey = null;

  function nowSec(){ return Math.floor(Date.now()/1000); }

  function startIntervalLog(kindLabel, enteredAtSec){
    if(!db) return Promise.resolve(null);
    const ref = db.ref("/logs/" + FIREBASE_KEY).push();
    const payload = {
      room: kindLabel,           // show in History list
      entered_at: enteredAtSec,
      exited_at: null,
      duration_sec: null,
      source: "dashboard",
      kind: kindLabel === "Away" ? "away" : "system_offline"
    };
    return ref.set(payload).then(()=> ref.key).catch(()=> null);
  }

  function closeIntervalLog(logKey, exitedAtSec){
    if(!db || !logKey) return Promise.resolve();
    return db.ref("/logs/" + FIREBASE_KEY + "/" + logKey).update({
      exited_at: exitedAtSec,
      duration_sec: null // filled below
    }).then(()=>{
      // compute duration safely
      return db.ref("/logs/" + FIREBASE_KEY + "/" + logKey).once("value");
    }).then((snap)=>{
      const v = snap.val() || {};
      const entered = Number(v.entered_at || 0);
      const exited = Number(exitedAtSec || 0);
      const dur = (entered && exited && exited >= entered) ? (exited - entered) : null;
      return db.ref("/logs/" + FIREBASE_KEY + "/" + logKey).update({
        duration_sec: dur
      });
    }).catch(()=>{});
  }

  // =========================
  // Settings (localStorage)
  // =========================
  const SETTINGS_KEY = "uw_jack_settings_v1";
  const defaultSettings = {
    lingerEnabled: true,
    lingerSound: false,
    defaultLimitMin: 60,
    perRoomMin: {
      "Bedroom": 600,
      "Bathroom": 60,
      "Kitchen": 240,
      "Living Room": 240,
      "Front Door": 60
    }
  };

  const clone = (o)=> JSON.parse(JSON.stringify(o));
  let settings = loadSettings();

  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if(!raw) return clone(defaultSettings);
      const obj = JSON.parse(raw);
      const merged = clone(defaultSettings);

      merged.lingerEnabled = (obj.lingerEnabled !== undefined) ? !!obj.lingerEnabled : merged.lingerEnabled;
      merged.lingerSound = (obj.lingerSound !== undefined) ? !!obj.lingerSound : merged.lingerSound;
      merged.defaultLimitMin = isFinite(obj.defaultLimitMin) ? Number(obj.defaultLimitMin) : merged.defaultLimitMin;

      if(obj.perRoomMin && typeof obj.perRoomMin === "object"){
        for(const k of Object.keys(merged.perRoomMin)){
          if(isFinite(obj.perRoomMin[k])) merged.perRoomMin[k] = Number(obj.perRoomMin[k]);
        }
      }
      return merged;
    }catch(e){
      return clone(defaultSettings);
    }
  }

  function saveSettings(){
    try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }
    catch(e){ console.log("saveSettings error:", e); }
  }

  function applySettingsToUI(){
    document.getElementById("toggleLinger").classList.toggle("on", !!settings.lingerEnabled);
    document.getElementById("toggleLingerSound").classList.toggle("on", !!settings.lingerSound);

    document.getElementById("limitDefault").value = settings.defaultLimitMin ?? "";
    document.getElementById("limitBedroom").value = settings.perRoomMin["Bedroom"] ?? "";
    document.getElementById("limitBathroom").value = settings.perRoomMin["Bathroom"] ?? "";
    document.getElementById("limitKitchen").value = settings.perRoomMin["Kitchen"] ?? "";
    document.getElementById("limitLiving").value = settings.perRoomMin["Living Room"] ?? "";
    document.getElementById("limitFrontDoor").value = settings.perRoomMin["Front Door"] ?? "";
  }

  function readSettingsFromUI(){
    const n = (v)=> {
      const x = Number(String(v ?? "").trim());
      return isFinite(x) && x >= 0 ? x : null;
    };

    settings.defaultLimitMin = n(document.getElementById("limitDefault").value) ?? defaultSettings.defaultLimitMin;

    const bedroom = n(document.getElementById("limitBedroom").value);
    const bath = n(document.getElementById("limitBathroom").value);
    const kit = n(document.getElementById("limitKitchen").value);
    const liv = n(document.getElementById("limitLiving").value);
    const fd = n(document.getElementById("limitFrontDoor").value);

    if(bedroom !== null) settings.perRoomMin["Bedroom"] = bedroom;
    if(bath !== null) settings.perRoomMin["Bathroom"] = bath;
    if(kit !== null) settings.perRoomMin["Kitchen"] = kit;
    if(liv !== null) settings.perRoomMin["Living Room"] = liv;
    if(fd !== null) settings.perRoomMin["Front Door"] = fd;
  }

  function commitSettingsFromUI(){
    readSettingsFromUI();
    settings.lingerEnabled = document.getElementById("toggleLinger").classList.contains("on");
    settings.lingerSound = document.getElementById("toggleLingerSound").classList.contains("on");
    saveSettings();
  }

  function getRoomLimitSeconds(room){
    if(!room) return null;
    const min = settings.perRoomMin[room];
    const useMin = isFinite(min) ? Number(min) : Number(settings.defaultLimitMin || 0);
    if(!isFinite(useMin) || useMin <= 0) return null;
    return Math.floor(useMin * 60);
  }

  function wireEnterToNextInSettings(){
    const ids = ["limitDefault","limitBedroom","limitBathroom","limitKitchen","limitLiving","limitFrontDoor"];
    ids.forEach((id, idx) => {
      const el = document.getElementById(id);
      if(!el) return;

      el.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          const next = document.getElementById(ids[idx + 1]);
          if(next){
            next.focus();
            next.select?.();
          } else {
            document.getElementById("btnSaveSettings").click();
          }
        }
      });
    });
  }

  function wireSettingsInputs(){
    const ids = ["limitDefault","limitBedroom","limitBathroom","limitKitchen","limitLiving","limitFrontDoor"];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener("input", ()=>{ commitSettingsFromUI(); });
      el.addEventListener("change", ()=>{ commitSettingsFromUI(); });
    });
  }

  // =========================
  // Helpers
  // =========================
  function setFbStatus(txt){ document.getElementById("fbStatus").textContent = txt; }

  function isValidGps(lat, lng){
    if(!isFinite(lat) || !isFinite(lng)) return false;
    if(Math.abs(lat) < 0.000001 && Math.abs(lng) < 0.000001) return false;
    if(lat < -90 || lat > 90) return false;
    if(lng < -180 || lng > 180) return false;
    return true;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function clearMessages(){
    if(!db) return;
    if(!confirm("Clear all messages from Jack‚Äôs phone?")) return;

    db.ref("/messages/" + FIREBASE_KEY)
      .remove()
      .then(()=>{ liveJackMessages = []; renderMessages(); })
      .catch(err=>{ console.log("Clear messages error:", err); alert("Failed to clear messages."); });
  }

  function formatDuration(seconds) {
    const s = Math.max(0, Math.floor(seconds || 0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if (h > 0) return `${h}:${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
    return `${m}:${String(sec).padStart(2,"0")}`;
  }

  function updateDerivedTimes(){
    const n = nowSec();

    if(jack._last_seen){
      jack.lastSeenSec = Math.max(0, n - jack._last_seen);
    }else{
      jack.lastSeenSec = null;
    }

    if(jack._entered_at){
      const dwell = Math.max(0, n - jack._entered_at);
      jack.timeInRoom = formatDuration(dwell);
    }else{
      jack.timeInRoom = "‚Äî";
    }
  }

  function computeAway(){
    const n = nowSec();
    const lastSeen = jack._last_seen || 0;
    const offline = !lastSeen || ((n - lastSeen) > OFFLINE_SEC);
    jack.status = offline ? "Away" : "Home";
    return offline;
  }

  // ‚úÖ heartbeat normalize (seconds or ms)
  function normalizeHeartbeatToSec(v){
    let x = Number(v || 0);
    if(!isFinite(x) || x <= 0) return 0;
    if(x > 1e12) x = Math.floor(x / 1000); // ms -> sec
    return Math.floor(x);
  }

  function computeSystemOnline(){
    const n = nowSec();
    if(!lastHeartbeatSec) return false;
    return (n - lastHeartbeatSec) <= HEARTBEAT_OFFLINE_SEC;
  }

  // =========================
  // Alarm sound
  // =========================
  let soundOn = true;
  let audioCtx = null, osc = null, gain = null, alarmTimer = null;

  function startAlarm(){
    if(!soundOn) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === "suspended") audioCtx.resume();
      if(alarmTimer) return;

      gain = audioCtx.createGain();
      gain.gain.value = 0.0001;
      gain.connect(audioCtx.destination);

      osc = audioCtx.createOscillator();
      osc.type = "square";
      osc.frequency.value = 880;
      osc.connect(gain);
      osc.start();

      alarmTimer = setInterval(() => {
        const now = audioCtx.currentTime;
        gain.gain.cancelScheduledValues(now);
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.linearRampToValueAtTime(0.12, now + 0.01);
        gain.gain.linearRampToValueAtTime(0.0001, now + 0.25);
      }, 350);
    }catch(e){ console.log("Alarm audio error:", e); }
  }

  function stopAlarm(){
    try{
      if(alarmTimer){ clearInterval(alarmTimer); alarmTimer = null; }
      if(osc){ osc.stop(); osc.disconnect(); osc = null; }
      if(gain){ gain.disconnect(); gain = null; }
    }catch(e){ console.log("Stop alarm error:", e); }
  }

  // =========================
  // Alert modal (typed + SOS priority)
  // =========================
  let currentAlertKind = null; // "sos" | "linger" | "msg" | "offline" | "away" | null

  function setAlertKind(kind){
    currentAlertKind = kind || null;
    const box = document.getElementById("alertBox");
    if(box) box.setAttribute("data-kind", kind || "msg");
  }

  function showAlertKind(kind, title, body){
    // SOS popups overwrite all others
    if(currentAlertKind === "sos" && kind !== "sos") return;
    setAlertKind(kind);
    document.getElementById("alertTitle").textContent = title;
    document.getElementById("alertBody").textContent = body;
    document.getElementById("alert").style.display = "block";
  }

  function setAlertButtonsMode(mode){
    alertMode = mode || "default";
    const a = document.getElementById("alertBtnsDefault");
    const b = document.getElementById("alertBtnsConfirm");
    if(!a || !b) return;

    if(alertMode === "confirmClear"){
      a.style.display = "none";
      b.style.display = "block";
    }else{
      a.style.display = "block";
      b.style.display = "none";
    }
  }

  function showClearAlarmPrompt(){
    setAlertButtonsMode("confirmClear");
    showAlertKind("msg", "Clear the alarm?", "This will clear the SOS/Pool alarm in Firebase for this client.");
  }

  function clearFirebaseAlerts(){
    if(!db) return Promise.resolve();
    return db.ref("/alerts/" + FIREBASE_KEY).update({
      sos: false,
      pool: false,
      timestamp: Date.now()
    });
  }

  function confirmClearAlarmYes(){
    document.getElementById("alert").style.display = "none";
    setAlertButtonsMode("default");
    emergencySnoozeUntilMs = 0;
    clearFirebaseAlerts().catch(err => console.log("clearFirebaseAlerts error:", err));
  }

  function confirmClearAlarmNo(){
    document.getElementById("alert").style.display = "none";
    setAlertButtonsMode("default");
    emergencySnoozeUntilMs = Date.now() + (2 * 60 * 1000);
    stopAlarm();
    render();
  }

  // =========================
  // Message popup helpers
  // =========================
  function showMessagePopup(msgKey, msgObj){
    currentMsgKey = msgKey;
    setAlertButtonsMode("default");
    setAlertKind("msg");
    document.getElementById("alertTitle").textContent = "Message from phone";
    document.getElementById("alertBody").textContent = msgObj?.text || "";
    document.getElementById("alert").style.display = "block";

    const clearBtn = document.getElementById("btnClearPopup");
    if(clearBtn) clearBtn.style.display = "inline-flex";
  }

  function hideMessagePopupControls(){
    currentMsgKey = null;
    const clearBtn = document.getElementById("btnClearPopup");
    if(clearBtn) clearBtn.style.display = "none";
  }

  function clearCurrentPopupMessage(){
    if(!db || !currentMsgKey) return;

    db.ref("/messages/" + FIREBASE_KEY + "/" + currentMsgKey)
      .remove()
      .then(()=>{
        hideMessagePopupControls();
        document.getElementById("alert").style.display = "none";
      })
      .catch(err=>{
        console.log("Clear popup message error:", err);
        alert("Failed to clear message.");
      });
  }

  function dismissAlert(){
    const dismissedKind = currentAlertKind;

    document.getElementById("alert").style.display = "none";
    stopAlarm();
    hideMessagePopupControls();

    if(dismissedKind === "sos"){
      setAlertKind(null);
      showClearAlarmPrompt();
      return;
    }

    if(dismissedKind === "linger"){
      lingerSnoozeUntilMs = Date.now() + (2 * 60 * 1000);
    }

    // For offline/away, dismiss just hides it (it may re-open if still active)
    setAlertKind(null);
    setAlertButtonsMode("default");
    render();
  }

  // =========================
  // Alerts / State priority
  // =========================
  function applyStateFromAlerts(){
    const a = jack._alerts || {};
    const emergencyActive = (a.sos === true || a.pool === true);

    if(emergencyActive){
      if(Date.now() < emergencySnoozeUntilMs){
        jack.state = "bad";
        stopAlarm();
        return true;
      }

      if(jack.state !== "bad"){
        showAlertKind("sos", "Emergency Alert", `LIVE SOS/Alarm for ${jack.name}.`);
        startAlarm();
      }else{
        setAlertKind("sos");
        startAlarm();
      }

      jack.state = "bad";
      return true;
    }

    if(jack.state === "bad"){
      stopAlarm();
    }
    return false;
  }

  function getRoomLimitSeconds(room){
    if(!room) return null;
    const min = settings.perRoomMin[room];
    const useMin = isFinite(min) ? Number(min) : Number(settings.defaultLimitMin || 0);
    if(!isFinite(useMin) || useMin <= 0) return null;
    return Math.floor(useMin * 60);
  }

  function maybeLingerAlert(){
    if(!settings.lingerEnabled) return;
    if(jack.status !== "Home") return;
    if(!jack._entered_at) return;
    if(!jack.room) return;
    if(jack.state === "bad") return;
    if(Date.now() < lingerSnoozeUntilMs) return;

    const limitSec = getRoomLimitSeconds(jack.room);
    if(!limitSec) return;

    const n = nowSec();
    const dwellSec = Math.max(0, n - jack._entered_at);

    if(dwellSec >= limitSec){
      if(lingerAlertedForEnteredAt !== jack._entered_at){
        lingerAlertedForEnteredAt = jack._entered_at;
        jack.state = "warn";
        showAlertKind("linger", "Linger Alert",
          `${jack.name} has been in ${jack.room} for ${formatDuration(dwellSec)} (limit ${formatDuration(limitSec)}).`);
        if(settings.lingerSound) startAlarm();
      }else{
        jack.state = "warn";
      }
    }else{
      if(jack.state === "warn") jack.state = "ok";
    }
  }

  // =========================
  // ‚úÖ System Offline + Away popups + logging
  // =========================
  function handleSystemOfflineAndAway(){
    const n = nowSec();

    // -------- System Offline (heartbeat) --------
    const onlineNow = computeSystemOnline();
    systemOnline = onlineNow;

    if(!onlineNow){
      if(!sysOfflineActive){
        sysOfflineActive = true;
        sysOfflineSinceSec = n;

        // Start interval log
        startIntervalLog("System Offline", sysOfflineSinceSec).then((key)=>{
          sysOfflineLogKey = key;
        });

        // Popup (only on transition)
        if(currentAlertKind !== "sos"){
          showAlertKind("offline", "System Offline",
            `Heartbeat missing/stale.\nFor: ${formatDuration(n - sysOfflineSinceSec)}`);
        }
      }else{
        // Update popup timer if it's currently the offline popup
        if(currentAlertKind === "offline"){
          document.getElementById("alertBody").textContent =
            `Heartbeat missing/stale.\nFor: ${formatDuration(n - sysOfflineSinceSec)}`;
        }
      }
    }else{
      if(sysOfflineActive){
        // close interval log
        closeIntervalLog(sysOfflineLogKey, n);
        sysOfflineActive = false;
        sysOfflineSinceSec = 0;
        sysOfflineLogKey = null;

        // auto-clear popup if it was showing
        if(currentAlertKind === "offline"){
          document.getElementById("alert").style.display = "none";
          setAlertKind(null);
        }
      }
    }

    // -------- Client Away (beacon last_seen) --------
    const awayNow = (jack.status === "Away");

    if(awayNow){
      if(!awayActive){
        awayActive = true;
        awaySinceSec = n;

        startIntervalLog("Away", awaySinceSec).then((key)=>{
          awayLogKey = key;
        });

        if(currentAlertKind !== "sos" && currentAlertKind !== "offline"){
          showAlertKind("away", "Client Away",
            `${jack.name} is not being seen by any sensor.\nFor: ${formatDuration(n - awaySinceSec)}`);
        }
      }else{
        if(currentAlertKind === "away"){
          document.getElementById("alertBody").textContent =
            `${jack.name} is not being seen by any sensor.\nFor: ${formatDuration(n - awaySinceSec)}`;
        }
      }
    }else{
      if(awayActive){
        closeIntervalLog(awayLogKey, n);
        awayActive = false;
        awaySinceSec = 0;
        awayLogKey = null;

        if(currentAlertKind === "away"){
          document.getElementById("alert").style.display = "none";
          setAlertKind(null);
        }
      }
    }
  }

  // =========================
  // Rendering
  // =========================
  function render(){
    // ‚úÖ system online dot
    const sysDot = document.getElementById("sysDot");
    const sysText = document.getElementById("sysText");
    if(sysDot){
      sysDot.className = "dot" + (systemOnline ? "" : " bad");
    }
    if(sysText){
      sysText.textContent = systemOnline ? "System Online" : "System Offline";
    }

    const sd = document.getElementById("stateDot");
    sd.className = "dot" + (jack.state==="warn" ? " warn" : jack.state==="bad" ? " bad" : "");
    document.getElementById("stateText").textContent =
      (jack.state==="ok") ? "OK" : (jack.state==="warn") ? "LINGER" : "ALERT";

    const hero = document.querySelector(".hero");
    if(hero){
      hero.classList.toggle("warn", jack.state === "warn");
      hero.classList.toggle("bad", jack.state === "bad");
    }

    document.getElementById("statusText").textContent = jack.status || "‚Äî";
    document.getElementById("room").textContent =
      (jack.status === "Away") ? "Away" : (jack.room || "‚Äî");
    document.getElementById("timeInRoom").textContent = jack.timeInRoom || "‚Äî";

    document.getElementById("lastSeen").textContent =
      (jack.lastSeenSec === null || jack.lastSeenSec === undefined) ? "‚Äî" : (jack.lastSeenSec + "s ago");

    document.getElementById("lastSensor").textContent = jack.lastSensor || "‚Äî";

    if(jack.gps){
      const lat = jack.gps.lat;
      const lng = jack.gps.lng;
      const acc = jack.gps.accM ?? 20;

      document.getElementById("gpsLatLng").textContent = lat.toFixed(6) + ", " + lng.toFixed(6);
      document.getElementById("gpsAcc").textContent = Math.round(acc) + " m";

      const secs = Math.max(0, Math.round((Date.now() - (jack.gps.updatedAt||Date.now())) / 1000));
      document.getElementById("gpsUpdated").textContent = secs + "s ago";
    }else{
      document.getElementById("gpsLatLng").textContent = "‚Äî";
      document.getElementById("gpsAcc").textContent = "‚Äî";
      document.getElementById("gpsUpdated").textContent = "‚Äî";
    }

    renderMessages();

    if(mapShown){
      updateMap(false);
    }
  }

  function renderMessages(){
    const box = document.getElementById("msgLog");
    if(!box) return;

    if(!liveJackMessages.length){
      box.innerHTML = `<div class="evt"><div><b>No messages yet</b></div><div class="t">‚Äî</div></div>`;
      return;
    }

    box.innerHTML = "";
    liveJackMessages.slice().reverse().forEach(m => {
      const row = document.createElement("div");
      row.className = "evt";
      const when = m.timestamp ? new Date(m.timestamp).toLocaleString() : "‚Äî";
      row.innerHTML = `<div><div class="msg">${escapeHtml(m.text || "")}</div></div><div class="t">${escapeHtml(when)}</div>`;
      box.appendChild(row);
    });
    box.scrollTop = box.scrollHeight;
  }

  // =========================
  // History (Room intervals)
  // =========================
  let historyRows = [];
  let sosHistory = [];

  function formatTime(tsSec){
    if(!tsSec) return "‚Äî";
    const d = new Date(tsSec * 1000);
    return d.toLocaleString([], { month:"numeric", day:"numeric", hour:"2-digit", minute:"2-digit" });
  }

  function loadHistory(){
    const box = document.getElementById("historyList");
    if(!db){
      box.innerHTML = `<div class="evt"><div><b>Not connected</b></div><div class="t">‚Äî</div></div>`;
      return;
    }

    box.innerHTML = `<div class="evt"><div><b>Loading‚Ä¶</b></div><div class="t">‚Äî</div></div>`;

    db.ref("/logs/" + FIREBASE_KEY)
      .orderByChild("exited_at")
      .limitToLast(50)
      .once("value")
      .then((snap)=>{
        const obj = snap.val() || {};
        const rows = Object.values(obj).filter(Boolean);

        rows.sort((a,b)=>{
          const at = (a.exited_at || a.entered_at || a.timestamp || 0);
          const bt = (b.exited_at || b.entered_at || b.timestamp || 0);
          return bt - at;
        });

        historyRows = rows;
        renderHistory();
      })
      .catch((e)=>{
        console.log("History load error:", e);
        box.innerHTML = `<div class="evt"><div><b>Failed to load history</b></div><div class="t">‚Äî</div></div>`;
      });
  }

  function renderHistory(){
    const box = document.getElementById("historyList");
    if(!historyRows.length){
      box.innerHTML = `<div class="evt"><div><b>No history yet</b></div><div class="t">‚Äî</div></div>`;
      return;
    }

    const n = nowSec();

    const intervals = historyRows
      .map(x => ({
        room: x.room || "‚Äî",
        entered_at: x.entered_at || x.timestamp || null,
        exited_at: x.exited_at || null,
        duration_sec: x.duration_sec || null,
        kind: x.kind || null
      }))
      .filter(x => !!x.entered_at);

    intervals.sort((a,b)=> (a.entered_at || 0) - (b.entered_at || 0));

    const merged = [];
    for(let i=0;i<intervals.length;i++){
      const cur = intervals[i];
      const prev = merged.length ? merged[merged.length - 1] : null;

      if(prev && prev.exited_at && cur.entered_at){
        const gap = cur.entered_at - prev.exited_at;
        if(gap > OFFLINE_SEC){
          merged.push({
            room: "Away",
            entered_at: prev.exited_at,
            exited_at: cur.entered_at,
            duration_sec: gap,
            _kind: "away_gap"
          });
        }
      }
      merged.push(cur);
    }

    // If currently away, show an open interval live in history
    if(jack && jack._last_seen){
      const offlineNow = (n - jack._last_seen) > OFFLINE_SEC;
      if(offlineNow){
        merged.push({
          room: "Away",
          entered_at: jack._last_seen,
          exited_at: n,
          duration_sec: n - jack._last_seen,
          _kind: "away_live"
        });
      }
    }

    // SOS inline events (existing)
    sosHistory.forEach(e=>{
      merged.push({
        room: "üö® SOS Button Pressed",
        entered_at: e.timestamp,
        exited_at: null,
        duration_sec: null,
        _kind: "sos"
      });
    });

    merged.sort((a,b)=>{
      const at = (a.exited_at || a.entered_at || 0);
      const bt = (b.exited_at || b.entered_at || 0);
      return bt - at;
    });

    box.innerHTML = "";
    merged.slice(0, 50).forEach(x=>{
      const room = x.room || "‚Äî";
      const entered = x.entered_at || null;
      const exited = x.exited_at || null;
      const dur = x.duration_sec
        ? formatDuration(x.duration_sec)
        : (entered && exited ? formatDuration(exited - entered) : "");

      const left = `
        <div>
          <div class="msg">${escapeHtml(room)}</div>
          <div class="meta">
            ${escapeHtml(formatTime(entered))}${exited ? (" ‚Üí " + escapeHtml(formatTime(exited))) : ""}
            ${dur ? (" ‚Ä¢ " + escapeHtml(dur)) : ""}
          </div>
        </div>
      `;

      const right = `<div class="t">${exited ? "Done" : "‚Äî"}</div>`;

      const row = document.createElement("div");
      row.className = "evt";

      // highlight SOS
      if(x._kind === "sos"){
        row.style.borderLeft = "4px solid #fb7185";
      }
      // highlight System Offline intervals
      if((x.kind === "system_offline") || (String(room).toLowerCase().includes("system offline"))){
        row.style.borderLeft = "4px solid #fb7185";
      }
      // highlight Away intervals
      if((x.kind === "away") || (String(room).toLowerCase() === "away")){
        row.style.borderLeft = row.style.borderLeft || "4px solid #facc15";
      }

      row.innerHTML = left + right;
      box.appendChild(row);
    });
  }

  // =========================
  // Leaflet Map (hidden until GPS is valid)
  // =========================
  let map = null;
  let marker = null;
  let accuracyCircle = null;
  let mapReady = false;
  let mapShown = false;
  let centeredOnce = false;

  function stateFillColor(){
    return (jack.state==="bad") ? "#fb7185" : (jack.state==="warn") ? "#facc15" : "#4ade80";
  }

  function initMap(){
    if(mapReady) return;
    mapReady = true;

    map = L.map('leafletMap', { zoomControl:true }).setView([BASE_GPS.lat, BASE_GPS.lng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    marker = L.circleMarker([BASE_GPS.lat, BASE_GPS.lng], {
      radius: 9,
      color: "#ffffff",
      weight: 2,
      fillColor: "#4ade80",
      fillOpacity: 0.95
    }).addTo(map);

    accuracyCircle = L.circle([BASE_GPS.lat, BASE_GPS.lng], {
      radius: 20,
      color: "#60a5fa",
      weight: 1,
      fillColor: "#60a5fa",
      fillOpacity: 0.12
    }).addTo(map);
  }

  function showMapUI(){
    if(mapShown) return;
    mapShown = true;

    document.getElementById("gpsWaiting").style.display = "none";
    document.getElementById("mapWrap").style.display = "block";

    initMap();
    setTimeout(() => map.invalidateSize(), 80);
  }

  function updateMap(pan){
    if(!mapShown) return;
    initMap();

    const hasGps = !!(jack.gps && isFinite(jack.gps.lat) && isFinite(jack.gps.lng));
    if(!hasGps) return;

    const lat = jack.gps.lat;
    const lng = jack.gps.lng;
    const acc = (jack.gps.accM ?? 20);

    marker.setLatLng([lat,lng]);
    marker.setStyle({
      fillColor: stateFillColor(),
      radius: (jack.state==="bad") ? 11 : 9,
      weight: (jack.state==="bad") ? 3 : 2
    });

    accuracyCircle.setLatLng([lat,lng]);
    accuracyCircle.setRadius(acc);

    if(pan){
      map.setView([lat,lng], Math.max(map.getZoom(), 15));
    }

    setTimeout(() => map.invalidateSize(), 50);
  }

  // =========================
  // Tabs + UI wiring
  // =========================
  let currentTab = "status";

  function showTab(tab){
    if(currentTab === "settings" && tab !== "settings"){
      commitSettingsFromUI();
    }

    currentTab = tab;

    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
    document.getElementById("panel_status").style.display = (tab==="status") ? "block" : "none";
    document.getElementById("panel_history").style.display = (tab==="history") ? "block" : "none";
    document.getElementById("panel_settings").style.display = (tab==="settings") ? "block" : "none";
    if(tab==="history") loadHistory();
    if(tab==="settings") applySettingsToUI();
  }

  document.getElementById("tabs").addEventListener("click", (e)=>{
    const t = e.target.closest(".tab");
    if(!t) return;
    showTab(t.dataset.tab);
  });

  function wireToggle(id, onChange){
    const el = document.getElementById(id);
    el.addEventListener("click", ()=>{
      el.classList.toggle("on");
      onChange?.(el.classList.contains("on"));
    });
  }

  // =========================
  // Buttons
  // =========================
  document.getElementById("btnCenter").addEventListener("click", ()=>{
    if(!jack.gps){
      alert("Waiting for GPS‚Ä¶");
      return;
    }
    if(!mapShown){
      showMapUI();
      setTimeout(()=>updateMap(true), 120);
      return;
    }
    updateMap(true);
  });

  document.getElementById("btnMute").addEventListener("click", (e)=>{
    soundOn = !soundOn;
    e.target.textContent = "Sound: " + (soundOn ? "ON" : "OFF");
    if(!soundOn) stopAlarm();
  });

  document.getElementById("btnRefreshHistory").addEventListener("click", loadHistory);
  document.getElementById("btnClearPopup").addEventListener("click", clearCurrentPopupMessage);

  document.getElementById("btnSaveSettings").addEventListener("click", ()=>{
    commitSettingsFromUI();
    showTab("status");
    showAlertKind("msg", "Saved", "Settings saved on this device.");
  });

  document.getElementById("btnResetSettings").addEventListener("click", ()=>{
    settings = clone(defaultSettings);
    saveSettings();
    applySettingsToUI();
    showTab("status");
    showAlertKind("msg", "Reset", "Settings reset to defaults.");
  });

  wireToggle("toggleLinger", (v)=>{ settings.lingerEnabled = v; saveSettings(); });
  wireToggle("toggleLingerSound", (v)=>{ settings.lingerSound = v; saveSettings(); });

  // =========================
  // Firebase wiring
  // =========================
  function wireFirebase(){
    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      setFbStatus("Connected");

      // ‚úÖ System heartbeat
      db.ref("/system/heartbeat").on("value", (snap)=>{
        const v = snap.val();
        lastHeartbeatSec = normalizeHeartbeatToSec(v);
        // Don't show popups here; tick loop will handle transitions cleanly
      });

      // Live beacons
      db.ref("/beacons/" + FIREBASE_KEY).on("value", (snap)=>{
        const val = snap.val() || {};

        if(val.room !== undefined) jack.room = val.room || "";
        if(val.last_sensor !== undefined) jack.lastSensor = val.last_sensor || (val.room || jack.lastSensor || "");
        else jack.lastSensor = jack.lastSensor || val.room || "";

        if(val.entered_at !== undefined) {
          jack._entered_at = val.entered_at || null;
          if(lingerAlertedForEnteredAt && lingerAlertedForEnteredAt !== jack._entered_at){
            lingerAlertedForEnteredAt = null;
          }
        }
        if(val.last_seen !== undefined) jack._last_seen = val.last_seen || 0;
        if(val.battery !== undefined) jack.battery = val.battery;

        updateDerivedTimes();
        computeAway();

        const emergency = applyStateFromAlerts();
        if(!emergency){
          maybeLingerAlert();
          if(jack.state !== "warn") jack.state = "ok";
        }

        // ‚úÖ handle Away/System Offline popups + logging
        handleSystemOfflineAndAway();

        render();
      });

      // Live alerts
      db.ref("/alerts/" + FIREBASE_KEY).on("value", (snap)=>{
        const prev = jack._alerts || {};
        const next = snap.val() || {};
        jack._alerts = next;

        if(prev.sos !== true && next.sos === true){
          sosHistory.push({ type:"sos", timestamp: nowSec() });
        }

        const emergency = applyStateFromAlerts();
        if(!emergency){
          maybeLingerAlert();
          if(jack.state !== "warn") jack.state = "ok";
        }

        // ‚úÖ keep offline/away logic consistent
        handleSystemOfflineAndAway();

        render();
      });

      // Live GPS
      db.ref("/gps/" + FIREBASE_KEY).on("value", (snap)=>{
        const val = snap.val();
        if(!val) return;

        const latRaw = val.lat ?? val.latitude;
        const lngRaw = val.lng ?? val.lon ?? val.longitude ?? val.long;
        if(latRaw === undefined || lngRaw === undefined) return;

        const lat = Number(latRaw);
        const lng = Number(lngRaw);
        if(!isValidGps(lat, lng)) return;

        const acc = Number(val.accM ?? val.accuracyM ?? val.accuracy ?? 20);

        let updatedMs = (val.updatedAt ?? val.timestamp ?? val.time ?? null);
        if(updatedMs !== null) {
          updatedMs = Number(updatedMs);
          if (updatedMs < 1e12) updatedMs = updatedMs * 1000;
        } else {
          updatedMs = Date.now();
        }

        jack.gps = jack.gps || {};
        jack.gps.lat = lat;
        jack.gps.lng = lng;
        jack.gps.accM = acc;
        jack.gps.updatedAt = updatedMs;

        showMapUI();

        if(!centeredOnce){
          centeredOnce = true;
          setTimeout(()=> updateMap(true), 120);
        }else{
          updateMap(false);
        }

        render();
      });

      // Live messages
      db.ref("/messages/" + FIREBASE_KEY)
        .orderByChild("timestamp")
        .limitToLast(20)
        .on("value", (snap)=>{
          const obj = snap.val() || {};
          const entries = Object.entries(obj)
            .map(([key, val]) => ({ key, ...(val || {}) }))
            .filter(x => !!x.key);

          entries.sort((a,b)=> (a.timestamp || 0) - (b.timestamp || 0));
          liveJackMessages = entries.map(e => ({ text: e.text, timestamp: e.timestamp }));

          renderMessages();

          const newest = entries.length ? entries[entries.length - 1] : null;
          const newestTs = newest?.timestamp || 0;

          if(newest && newestTs && newestTs > lastMsgPopupTs){
            lastMsgPopupTs = newestTs;
            showMessagePopup(newest.key, newest);
          }
        });

    }catch(e){
      console.log("Firebase init error:", e);
      setFbStatus("Error");
    }
  }

  // =========================
  // Tick: derived time + linger + offline/away checks
  // =========================
  let currentTab = "status"; // ensure defined before interval uses it

  setInterval(()=>{
    updateDerivedTimes();
    computeAway();

    const emergency = applyStateFromAlerts();
    if(!emergency){
      maybeLingerAlert();
      if(jack.state !== "warn") jack.state = "ok";
    }

    // ‚úÖ offline/away popups + timers + auto-clear + interval logging
    handleSystemOfflineAndAway();

    render();

    if(currentTab === "history"){
      renderHistory();
    }
  }, 3000);

  // Init UI
  applySettingsToUI();
  wireSettingsInputs();
  wireEnterToNextInSettings();
  updateDerivedTimes();
  computeAway();
  render();
  showTab("status");

  // Start Firebase
  wireFirebase();
</script>

</body>
</html>
