<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!--
    UltraWatch
    Build: DEMO-VACATIONHOME v0.2.0
    Last Updated: 2025-12-30
  -->

  <title>UltraWatch ‚Äî Vacation Home</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.07);
      --panel2:rgba(255,255,255,.10);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.72);
      --line:rgba(255,255,255,.12);
      --good:#4ade80;
      --warn:#facc15;
      --bad:#fb7185;
      --accent:#60a5fa;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    /* Build banner (internal) */
    .build{
      background:rgba(96,165,250,.15);
      border:1px solid rgba(96,165,250,.35);
      color:#cfe3ff;
      padding:8px 12px;
      border-radius:12px;
      font-size:12px;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .build b{font-weight:900}

    /* Header */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .muted{color:var(--muted)}

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .btn{
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      padding:9px 12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.08)}
    .btnDanger{
      border:1px solid rgba(251,113,133,.45);
      background:rgba(251,113,133,.15);
      color:#ffe6ea;
    }
    .btnDanger:hover{filter:brightness(1.12)}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:980px){
      .grid{grid-template-columns:330px 1.3fr .8fr}
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      overflow:hidden;
    }

    /* Sound Gate */
    .soundGate{
      position: sticky;
      top: 0;
      z-index: 9999;
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(15, 122, 58, 0.18);
      border: 1px solid rgba(70,255,106,0.22);
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .soundGateTitle{font-weight:900}
    .soundGateHint{font-size:12px;color:var(--muted)}
    .soundGateRight{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Red Alert Banner */
    .banner{
      display:none;
      margin-bottom: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(180,35,24,0.26);
      border: 1px solid rgba(255,120,120,0.25);
    }
    .bannerTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .bannerTitle{font-weight:900;font-size:14px}
    .bannerText{margin-top:4px;color:rgba(233,238,252,.9)}

    /* People list */
    .search{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .search input{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
    }
    .list{max-height:680px;overflow:auto}
    .person{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      cursor:pointer;
    }
    .person:hover{background:rgba(255,255,255,.03)}
    .person.active{background:rgba(96,165,250,.12)}
    .pname{font-weight:900}
    .pmeta{color:var(--muted);font-size:12px;margin-top:2px}

    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      height:fit-content;
      background:rgba(0,0,0,.12);
    }
    .dot{width:9px;height:9px;border-radius:50%;background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    /* Status */
    .status{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.15);
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      background:rgba(0,0,0,.12);
    }

    /* Property map */
    .property{
      height:440px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
      margin-top:12px;
    }
    .zone{
      position:absolute;
      border:2px dashed rgba(96,165,250,.55);
      border-radius:18px;
      padding:10px;
      font-size:12px;
      color:rgba(233,238,252,.8);
      background:rgba(96,165,250,.06);
      pointer-events:none;
    }
    .pool{
      border-color:rgba(250,204,21,.65);
      background:rgba(250,204,21,.06);
    }
    .label{
      position:absolute;
      font-size:12px;
      color:rgba(233,238,252,.72);
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:999px;
      pointer-events:none;
    }

    /* Per-person pins (multi-person) */
    .pin{
      position:absolute;
      width:12px;height:12px;border-radius:50%;
      transform:translate(-50%,-50%);
      background:var(--good);
      box-shadow:0 0 0 6px rgba(74,222,128,.12);
      border:2px solid rgba(255,255,255,.65);
      cursor:pointer;
    }
    .pin.warn{background:var(--warn);box-shadow:0 0 0 6px rgba(250,204,21,.12)}
    .pin.bad{background:var(--bad);box-shadow:0 0 0 6px rgba(251,113,133,.14)}
    .pin.selected{
      width:14px;height:14px;
      border-color:#fff;
      box-shadow:0 0 0 7px rgba(96,165,250,.16);
    }
    .pinTag{
      position:absolute;
      transform:translate(-50%,-160%);
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.30);
      color:rgba(233,238,252,.85);
      white-space:nowrap;
      pointer-events:none;
    }

    /* Controls blocks */
    .grid2{display:grid;gap:10px}
    @media(min-width:980px){ .grid2{grid-template-columns:1fr 1fr} }

    label{display:flex;align-items:center;gap:10px;user-select:none}
    input[type="checkbox"]{transform:scale(1.1)}
    input[type="tel"]{
      width:100%;
      box-sizing:border-box;
      border-radius:12px;
      padding:10px 10px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .pillList{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .miniPill{
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
    }

    .statusPill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px; font-weight: 900;
      background: rgba(255,255,255,0.10); color:#B8C0D9;
    }
    .statusPill .sdot{width:10px;height:10px;border-radius:99px;background:rgba(255,255,255,0.35)}
    .liveOn{ background: rgba(0,255,0,0.15); color:#7CFF7C; }
    .liveOn .sdot{ background:#46ff6a; }
    .livePending{ background: rgba(255,200,0,0.15); color:#ffd37a; }
    .livePending .sdot{ background:#ffd37a; }

    /* Activity */
    .log{max-height:680px;overflow:auto}
    .evt{
      display:flex;justify-content:space-between;gap:12px;
      padding:9px 0;border-bottom:1px solid var(--line);
    }
    .evt .t{font-size:12px;color:var(--muted)}

    .err{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(180,35,24,0.18);
      color: #ffd2cd;
      display:none;
    }

    footer{
      margin-top:16px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="build">
    <div><b>UltraWatch</b> ‚Äî Build <b>DEMO-VACATIONHOME v0.2.0</b></div>
    <div>Updated: <b>Dec 30, 2025</b></div>
  </div>

  <div class="header">
    <div>
      <h1>Vacation Home & Pool Safety</h1>
      <div class="sub">Property monitor page for AirBnB / VRBO guests ‚Ä¢ Pool proximity alerts ‚Ä¢ Emergency contact & live monitoring</div>
      <div class="sub mono">Build string: <span id="buildString">2025-12-30 12:00</span></div>
      <div class="err mono" id="errBox"></div>
    </div>
    <div class="mono muted" id="clock">--</div>
  </div>

  <!-- SOUND GATE -->
  <div class="soundGate" id="soundGate">
    <div>
      <div class="soundGateTitle">üîî Tap to enable alarms</div>
      <div class="soundGateHint">Phones block alarm audio until you tap once on this page.</div>
    </div>
    <div class="soundGateRight">
      <button class="btn" id="soundGateBtn">Enable Sound</button>
      <span class="sub mono muted" id="soundStatus">Sound: off</span>
    </div>
  </div>

  <!-- EMERGENCY BANNER -->
  <div class="banner" id="alertBanner">
    <div class="bannerTop">
      <div>
        <div class="bannerTitle">‚ö†Ô∏è EMERGENCY ALERT ACTIVE</div>
        <div class="sub mono bannerText" id="alertBannerText">--</div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btnDanger" id="clearAllBtn">Clear All</button>
        <button class="btn" id="testAlarmBtn">Test Alarm</button>
        <button class="btn" id="enableSoundBtn">Enable Sound</button>
      </div>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT: People -->
    <div class="card">
      <div class="search">
        <input id="search" placeholder="Search guests‚Ä¶" oninput="renderPeopleList()" />
      </div>
      <div class="sub" style="margin-bottom:10px">Guests at this property</div>
      <div class="list" id="peopleList"></div>
    </div>

    <!-- CENTER: Property Map + Selected Status -->
    <div class="card">

      <div class="status">
        <div>
          <div id="selName" style="font-weight:900;font-size:16px">‚Äî</div>
          <div class="sub">
            Key <span class="mono" id="selKey">‚Äî</span> ‚Ä¢ Room <span class="mono" id="selRoom">‚Äî</span> ‚Ä¢ Dwell <span class="mono" id="selDwell">‚Äî</span>
          </div>
          <div class="sub">
            Last seen <span class="mono" id="selLastSeen">‚Äî</span> ‚Ä¢ Data age <span class="mono" id="selAge">‚Äî</span>
          </div>
        </div>
        <div class="row">
          <span class="pill"><span id="selStateDot" class="dot"></span><span id="selStateText">OK</span></span>
          <span class="pill">Zone: <b id="selZone">‚Äî</b></span>
          <span class="pill">Pool: <b id="selPool">‚Äî</b></span>
        </div>
      </div>

      <div class="property" id="property">
        <div class="label" style="left:18px;top:14px;">Main House</div>
        <div class="label" style="left:18px;top:46px;">Backyard</div>

        <div class="zone" style="left:18px;top:70px;width:56%;height:42%;">House Interior</div>
        <div class="zone" style="left:18px;top:280px;width:56%;height:34%;">Patio / Backyard</div>
        <div class="zone pool" style="left:63%;top:120px;width:33%;height:44%;">Pool Zone</div>
        <div class="zone" style="left:63%;top:300px;width:33%;height:20%;">Driveway / Front</div>

        <!-- Pins go here -->
        <div id="pins"></div>
      </div>

      <div class="sub" style="margin-top:10px">
        Pool logic: If a guest‚Äôs room contains ‚Äúpool‚Äù, the pool alarm <b>latches</b> until cleared (when enabled).
      </div>
    </div>

    <!-- RIGHT: Controls + Activity -->
    <div class="card">

      <div class="grid2">
        <div>
          <div style="font-weight:900;margin-bottom:6px;">Live monitoring request</div>
          <label>
            <input type="checkbox" id="liveMonitorChk" />
            <span>Request live monitoring</span>
          </label>
          <div style="margin-top:10px;">
            <span class="statusPill" id="livePill">
              <span class="sdot"></span>
              <span id="liveText">LIVE MONITORING: OFF</span>
            </span>
            <div class="sub">Demo-only: turns green a few seconds after checking.</div>
          </div>
        </div>

        <div>
          <div style="font-weight:900;margin-bottom:6px;">Pool alarm</div>
          <label>
            <input type="checkbox" id="poolEnabledChk" checked />
            <span>Enable pool alarm</span>
          </label>
          <div class="sub">Pool alarms latch ON when ‚Äúpool‚Äù is detected in the room string.</div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.10); margin:12px 0;">

      <div>
        <div style="font-weight:900;margin-bottom:6px;">Emergency contact number(s)</div>
        <div class="grid2" style="grid-template-columns: 1fr auto auto; align-items:center;">
          <input type="tel" id="phoneInput" placeholder="Enter phone number (e.g., 407-555-0123)" />
          <button class="btn" id="addPhoneBtn">Add</button>
          <button class="btnDanger" id="clearPhonesBtn">Clear</button>
        </div>
        <div class="sub">Numbers are stored locally in this browser (demo).</div>

        <div id="registeredBlock" style="margin-top:10px; display:none;">
          <div class="sub">Registered:</div>
          <div class="pillList" id="registeredList"></div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.10); margin:12px 0;">

      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div style="font-weight:900">Activity</div>
          <div class="sub">Recent events for the selected guest</div>
          <div class="sub mono" id="systemLine">System: --</div>
          <div class="sub mono" id="dataAgeLine">Data age: --</div>
          <div class="sub mono" id="modeLine">Mode: --</div>
        </div>
        <div class="row">
          <button class="btn" id="demoMoveBtn">Move (Demo)</button>
          <button class="btnDanger" id="demoSosBtn">SOS (Demo)</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="log" id="log"></div>
    </div>

  </div>

  <footer>
    <div>UltraWatch ¬© 2025</div>
    <div>Demo Version</div>
  </footer>

</div>

<!-- Firebase compat (optional) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
(function(){
  const errBox = document.getElementById("errBox");
  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = "JS ERROR: " + msg;
  }

  // ====== CONFIG ======
  const firebaseConfig = { databaseURL: "https://ultrawatch-home-default-rtdb.firebaseio.com/" };

  // People to monitor (REAL Firebase keys)
  // You can add more guests here anytime.
  const PEOPLE = [
    { label: "Jack", firebaseKey: "GRANDPA" },
    { label: "Axel", firebaseKey: "Axel" }
  ];

  // ====== STATE ======
  let selectedKey = PEOPLE[0].firebaseKey;

  // live data shape: live[key] = { room, entered_at, last_seen, alerts }
  const live = {};
  let lastSystemRx = 0;

  // pool latch (per person)
  const poolLatched = {}; // key -> bool

  // Activity feed (per person)
  const activity = {};
  PEOPLE.forEach(p => activity[p.firebaseKey] = [{ msg:"System online", t:timeNow() }]);

  // ‚úÖ NEW: Transition trackers to prevent log spam
  const prevRoom = {};     // key -> last room string
  const prevSOS  = {};     // key -> last sos boolean

  // Demo fallback if Firebase isn't reachable
  let firebaseOk = false;
  let demoMode = false;

  // Demo-only alarm test timer
  let testAlarmUntil = 0;

  // ====== AUDIO (Sound Gate) ======
  // Using alarm.mp3 like your property.html
  let soundEnabled = false;
  const alarmAudio = new Audio("alarm.mp3");
  alarmAudio.loop = true;

  const soundStatus = document.getElementById("soundStatus");
  const enableSoundBtn = document.getElementById("enableSoundBtn");
  const soundGate = document.getElementById("soundGate");
  const soundGateBtn = document.getElementById("soundGateBtn");

  function startAlarm(){
    if(!soundEnabled) return;
    if(alarmAudio.paused){
      alarmAudio.currentTime = 0;
      alarmAudio.play().catch(()=>console.log("Alarm blocked until user interaction"));
    }
  }
  function stopAlarm(){
    if(!alarmAudio.paused){
      alarmAudio.pause();
      alarmAudio.currentTime = 0;
    }
  }

  async function armSound(){
    try{
      soundEnabled = true;
      alarmAudio.currentTime = 0;
      await alarmAudio.play();
      alarmAudio.pause();
      alarmAudio.currentTime = 0;

      soundStatus.textContent = "Sound: on";
      soundGate.style.display = "none";
      return true;
    }catch(e){
      soundEnabled = false;
      soundStatus.textContent = "Sound: blocked (tap again)";
      soundGate.style.display = "flex";
      return false;
    }
  }

  soundGateBtn.addEventListener("click", armSound);
  enableSoundBtn.addEventListener("click", armSound);

  document.addEventListener("click", (e)=>{
    if(soundEnabled) return;
    if(e.target.closest("input, textarea")) return;
    if(e.target.closest("#soundGateBtn")) return;
    armSound();
  }, { passive:true });

  // ====== LIVE MONITOR PILL (demo-only) ======
  const liveMonitorChk = document.getElementById("liveMonitorChk");
  const livePill = document.getElementById("livePill");
  const liveText = document.getElementById("liveText");
  let livePendingTimer = null;

  function setLivePill(state){
    livePill.classList.remove("liveOn","livePending");
    if(state==="ON"){
      livePill.classList.add("liveOn");
      liveText.textContent = "LIVE MONITORING: ON";
    }else if(state==="PENDING"){
      livePill.classList.add("livePending");
      liveText.textContent = "LIVE MONITORING: PENDING‚Ä¶";
    }else{
      liveText.textContent = "LIVE MONITORING: OFF";
    }
  }
  setLivePill("OFF");

  liveMonitorChk.addEventListener("change", ()=>{
    if(livePendingTimer){ clearTimeout(livePendingTimer); livePendingTimer=null; }
    if(liveMonitorChk.checked){
      setLivePill("PENDING");
      livePendingTimer = setTimeout(()=>setLivePill("ON"), 2500);
    }else{
      setLivePill("OFF");
    }
  });

  // ====== PHONE REGISTRATION (localStorage) ======
  const phoneInput = document.getElementById("phoneInput");
  const addPhoneBtn = document.getElementById("addPhoneBtn");
  const clearPhonesBtn = document.getElementById("clearPhonesBtn");
  const registeredBlock = document.getElementById("registeredBlock");
  const registeredList = document.getElementById("registeredList");

  const PHONE_STORE_KEY = "ultrawatch_vacation_demo_numbers_v1";
  function loadPhones(){ try{return JSON.parse(localStorage.getItem(PHONE_STORE_KEY) || "[]");}catch{return[];} }
  function savePhones(arr){ localStorage.setItem(PHONE_STORE_KEY, JSON.stringify(arr)); }
  function normalizePhone(s){ return String(s||"").trim(); }
  function renderPhones(){
    const arr = loadPhones();
    registeredList.innerHTML = "";
    if(!arr.length){ registeredBlock.style.display="none"; return; }
    registeredBlock.style.display="block";
    arr.forEach(p=>{
      const el = document.createElement("div");
      el.className = "miniPill mono";
      el.textContent = p;
      registeredList.appendChild(el);
    });
  }
  renderPhones();

  addPhoneBtn.addEventListener("click", ()=>{
    const p = normalizePhone(phoneInput.value);
    if(!p) return;
    const arr = loadPhones();
    if(!arr.includes(p)) arr.push(p);
    savePhones(arr);
    phoneInput.value = "";
    renderPhones();
  });

  clearPhonesBtn.addEventListener("click", ()=>{
    localStorage.removeItem(PHONE_STORE_KEY);
    renderPhones();
  });

  // ====== HELPERS ======
  function timeNow(){ return new Date().toLocaleTimeString(); }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }
  function isPoolRoom(room){
    const r = String(room||"").toLowerCase();
    return r.includes("pool");
  }
  function formatDuration(seconds){
    const s = Math.max(0, Math.floor(seconds||0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if(h>0) return `${h}:${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
    return `${m}:${String(sec).padStart(2,"0")}`;
  }
  function nowSec(){ return Math.floor(Date.now()/1000); }

  // Map a room string to a property zone + default position
  function mapRoomToZoneAndPos(room){
    const r = String(room||"").toLowerCase();

    // Pool
    if(r.includes("pool")) return { zone:"Pool Zone", pos:{x:80,y:40} };

    // Backyard / patio
    if(r.includes("backyard") || r.includes("patio") || r.includes("lanai")) return { zone:"Patio / Backyard", pos:{x:40,y:74} };

    // Front / driveway / door
    if(r.includes("front") || r.includes("drive") || r.includes("garage") || r.includes("door")) return { zone:"Driveway / Front", pos:{x:80,y:82} };

    // Interior rooms
    if(r.includes("kitchen")) return { zone:"House Interior", pos:{x:45,y:30} };
    if(r.includes("living")) return { zone:"House Interior", pos:{x:35,y:34} };
    if(r.includes("bed"))    return { zone:"House Interior", pos:{x:32,y:26} };
    if(r.includes("bath"))   return { zone:"House Interior", pos:{x:50,y:26} };

    // Default interior
    return { zone: room ? "House Interior" : "‚Äî", pos:{x:42,y:34} };
  }

  function addEvent(key, msg){
    activity[key] = activity[key] || [];
    activity[key].push({ msg, t: timeNow() });

    // ‚úÖ NEW: Keep last 200 events per person (prevents slowdowns)
    if(activity[key].length > 200){
      activity[key].splice(0, activity[key].length - 200);
    }
  }

  // ====== COMPUTE STATUS ======
  function computeStatus(key){
    const v = live[key] || {};
    const room = v.room || "";
    const enteredAt = v.entered_at || 0;
    const lastSeen = v.last_seen || 0;
    const alerts = v.alerts || {};

    // latch pool if pool room detected
    if(isPoolRoom(room)) poolLatched[key] = true;

    const sosActive = (alerts.sos === true);
    const poolActive = (poolLatched[key] === true);

    const now = nowSec();
    const age = lastSeen ? (now - lastSeen) : null;
    const offline = (age === null) || (age > 12);

    const dwell = enteredAt ? (now - enteredAt) : 0;
    const dwellStr = enteredAt ? formatDuration(dwell) : "--:--";

    const mapped = mapRoomToZoneAndPos(room);

    // Severity
    let state = "ok";
    if(sosActive) state = "bad";
    else if(poolActive && document.getElementById("poolEnabledChk").checked) state = "bad";
    else if(offline) state = "warn";

    return {
      room,
      zone: mapped.zone,
      pos: mapped.pos,
      dwellStr,
      age,
      offline,
      sosActive,
      poolActive,
      state
    };
  }

  // ====== ALARM + BANNER ======
  const alertBanner = document.getElementById("alertBanner");
  const alertBannerText = document.getElementById("alertBannerText");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const testAlarmBtn = document.getElementById("testAlarmBtn");
  const poolEnabledChk = document.getElementById("poolEnabledChk");

  function anyEmergencyTriggersAlarm(){
    const now = nowSec();
    if(testAlarmUntil && now <= testAlarmUntil) return true;

    const poolEnabled = poolEnabledChk.checked;

    return PEOPLE.some(p=>{
      const key = p.firebaseKey;
      const v = live[key] || {};
      const a = v.alerts || {};
      const sos = (a.sos === true);
      const pool = (poolLatched[key] === true);
      if(sos) return true;
      if(pool && poolEnabled) return true;
      return false;
    });
  }

  function evaluateAlarmNow(){
    if(anyEmergencyTriggersAlarm()) startAlarm();
    else stopAlarm();
  }

  function refreshBanner(){
    const now = nowSec();
    const testActive = (testAlarmUntil && now <= testAlarmUntil);

    const sosNames = [];
    const poolNames = [];

    PEOPLE.forEach(p=>{
      const key = p.firebaseKey;
      const v = live[key] || {};
      const a = v.alerts || {};
      if(a.sos === true) sosNames.push(p.label);
      if(poolLatched[key] === true) poolNames.push(p.label);
    });

    if(!testActive && !sosNames.length && !poolNames.length){
      alertBanner.style.display = "none";
      alertBannerText.textContent = "--";
      return;
    }

    alertBanner.style.display = "block";
    const parts = [];
    if(testActive) parts.push("TEST ALARM");
    if(sosNames.length) parts.push("SOS: " + sosNames.join(", "));
    if(poolNames.length) parts.push("POOL: " + poolNames.join(", "));
    alertBannerText.textContent = parts.join("  |  ");
  }

  function triggerTestAlarm(){
    testAlarmUntil = nowSec() + 8;
    startAlarm();
    refreshBanner();
    setTimeout(()=>{ evaluateAlarmNow(); refreshBanner(); }, 8200);
  }
  testAlarmBtn.addEventListener("click", triggerTestAlarm);

  function clearPool(key){
    poolLatched[key] = false;
    evaluateAlarmNow();
    refreshBanner();
    renderAll();
  }

  // Clears SOS in Firebase (if Firebase ok). In demo mode, just flips local.
  let db = null;
  function clearSOS(key){
    if(!key) return;
    if(firebaseOk && db){
      db.ref("/alerts/" + key).update({ sos:false, timestamp: nowSec() });
    }else{
      live[key] = live[key] || {};
      live[key].alerts = live[key].alerts || {};
      live[key].alerts.sos = false;
    }
  }

  clearAllBtn.addEventListener("click", ()=>{
    PEOPLE.forEach(p => poolLatched[p.firebaseKey] = false);
    PEOPLE.forEach(p => clearSOS(p.firebaseKey));
    evaluateAlarmNow();
    refreshBanner();
    renderAll();
  });

  poolEnabledChk.addEventListener("change", ()=>{
    evaluateAlarmNow();
    refreshBanner();
  });

  // ====== RENDERING ======
  const peopleList = document.getElementById("peopleList");
  const pinsDiv = document.getElementById("pins");
  const logDiv = document.getElementById("log");

  function renderPeopleList(){
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    peopleList.innerHTML = "";

    PEOPLE
      .filter(p => !q || p.label.toLowerCase().includes(q))
      .forEach(p=>{
        const key = p.firebaseKey;
        const s = computeStatus(key);

        const dotClass = (s.state==="bad") ? "bad" : (s.state==="warn") ? "warn" : "";
        const badgeText =
          (s.state==="bad") ? (s.sosActive ? "SOS" : "POOL") :
          (s.offline) ? "OFFLINE" :
          (s.room || s.zone || "OK");

        const el = document.createElement("div");
        el.className = "person" + (key === selectedKey ? " active" : "");
        el.innerHTML = `
          <div>
            <div class="pname">${escapeHtml(p.label)}</div>
            <div class="pmeta mono">Key: ${escapeHtml(key)} ‚Ä¢ ${escapeHtml(s.room || "‚Äî")} ‚Ä¢ Dwell ${escapeHtml(s.dwellStr)}</div>
          </div>
          <span class="badge"><span class="dot ${dotClass}"></span>${escapeHtml(badgeText)}</span>
        `;
        el.onclick = ()=>{ selectedKey = key; renderAll(); };
        peopleList.appendChild(el);
      });
  }

  function renderPins(){
    pinsDiv.innerHTML = "";
    PEOPLE.forEach(p=>{
      const key = p.firebaseKey;
      const s = computeStatus(key);

      // If no info yet, still show pin in default interior
      const pos = s.pos || {x:42,y:34};

      const pin = document.createElement("div");
      pin.className = "pin" +
        (s.state==="warn" ? " warn" : s.state==="bad" ? " bad" : "") +
        (key===selectedKey ? " selected" : "");
      pin.style.left = pos.x + "%";
      pin.style.top  = pos.y + "%";
      pin.title = p.label + (s.room ? " ‚Äî " + s.room : "");

      pin.onclick = ()=>{ selectedKey = key; renderAll(); };

      const tag = document.createElement("div");
      tag.className = "pinTag";
      tag.textContent = p.label;

      // tag must be positioned relative to same point
      const tagWrap = document.createElement("div");
      tagWrap.style.position = "absolute";
      tagWrap.style.left = pos.x + "%";
      tagWrap.style.top  = pos.y + "%";
      tagWrap.appendChild(tag);

      pinsDiv.appendChild(pin);
      pinsDiv.appendChild(tagWrap);
    });
  }

  function renderSelected(){
    const person = PEOPLE.find(p=>p.firebaseKey===selectedKey) || PEOPLE[0];
    const key = person.firebaseKey;
    const s = computeStatus(key);
    const v = live[key] || {};

    document.getElementById("selName").textContent = person.label;
    document.getElementById("selKey").textContent = key;
    document.getElementById("selRoom").textContent = s.room || "‚Äî";
    document.getElementById("selZone").textContent = s.zone || "‚Äî";
    document.getElementById("selDwell").textContent = s.dwellStr || "‚Äî";

    const ageStr = (s.age===null) ? "‚Äî" : (s.age + "s");
    document.getElementById("selAge").textContent = ageStr;

    const lastSeenStr = v.last_seen ? new Date(v.last_seen*1000).toLocaleTimeString() : "‚Äî";
    document.getElementById("selLastSeen").textContent = lastSeenStr;

    const poolText = (s.poolActive && poolEnabledChk.checked) ? "ACTIVE" : (s.poolActive ? "latched (disabled)" : "off");
    document.getElementById("selPool").textContent = poolText;

    const sd = document.getElementById("selStateDot");
    sd.className = "dot" + (s.state==="warn" ? " warn" : s.state==="bad" ? " bad" : "");
    document.getElementById("selStateText").textContent =
      (s.state==="bad") ? "ALERT" : (s.state==="warn") ? "CHECK" : "OK";
  }

  function renderActivity(){
    const key = selectedKey;
    logDiv.innerHTML = "";
    (activity[key] || []).slice().reverse().forEach(e=>{
      const row = document.createElement("div");
      row.className = "evt";
      row.innerHTML = `<div><b>${escapeHtml(e.msg)}</b></div><div class="t">${escapeHtml(e.t)}</div>`;
      logDiv.appendChild(row);
    });
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function renderAll(){
    renderPeopleList();
    renderPins();
    renderSelected();
    renderActivity();
  }

  // ====== SYSTEM LINES + CLOCK ======
  const systemLine = document.getElementById("systemLine");
  const dataAgeLine = document.getElementById("dataAgeLine");
  const modeLine = document.getElementById("modeLine");

  function tick(){
    document.getElementById("clock").textContent = new Date().toLocaleString();

    const now = nowSec();
    if(!firebaseOk || !lastSystemRx){
      systemLine.textContent = "System: " + (demoMode ? "DEMO" : "‚Äî");
      dataAgeLine.textContent = "Data age: ‚Äî";
    }else{
      const age = now - lastSystemRx;
      systemLine.textContent = "System: " + (age <= 8 ? "ONLINE" : "OFFLINE");
      dataAgeLine.textContent = "Data age: " + age + "s";
    }

    modeLine.textContent = "Mode: " + (firebaseOk ? "LIVE (Firebase)" : "DEMO (Local)");
    evaluateAlarmNow();
    refreshBanner();
    renderAll();
  }

  // ====== DEMO SIMULATION (fallback + buttons) ======
  function ensureDemoSeed(){
    PEOPLE.forEach((p,i)=>{
      const key = p.firebaseKey;
      live[key] = live[key] || {};
      live[key].room = live[key].room || (i%2===0 ? "Kitchen" : "Living Room");
      live[key].entered_at = live[key].entered_at || (nowSec() - (120 + i*25));
      live[key].last_seen = live[key].last_seen || nowSec();
      live[key].alerts = live[key].alerts || { sos:false };
    });
  }

  function demoMove(){
    ensureDemoSeed();
    const key = selectedKey;
    const v = live[key];

    const rooms = ["Kitchen","Living Room","Backyard","Front Door","Pool Area"];
    const idx = Math.max(0, rooms.map(r=>r.toLowerCase()).indexOf(String(v.room||"").toLowerCase()));
    const next = rooms[(idx+1)%rooms.length];

    v.room = next;
    v.entered_at = nowSec();
    v.last_seen = nowSec();
    addEvent(key, "Room update ‚Äî " + next);

    // Keep transition tracker aligned in demo mode too
    prevRoom[key] = next;

    // latch pool if needed
    if(isPoolRoom(next)) poolLatched[key] = true;

    renderAll();
    refreshBanner();
    evaluateAlarmNow();
  }

  function demoSOS(){
    ensureDemoSeed();
    const key = selectedKey;
    live[key].alerts = live[key].alerts || {};
    live[key].alerts.sos = true;
    live[key].last_seen = nowSec();
    addEvent(key, "Emergency alert ‚Äî SOS triggered");

    // Keep transition tracker aligned in demo mode too
    prevSOS[key] = true;

    refreshBanner();
    evaluateAlarmNow();
    renderAll();
  }

  document.getElementById("demoMoveBtn").addEventListener("click", ()=>{
    demoMode = true;
    firebaseOk = false;
    demoMove();
  });
  document.getElementById("demoSosBtn").addEventListener("click", ()=>{
    demoMode = true;
    firebaseOk = false;
    demoSOS();
  });

  // ====== FIREBASE WIRING (if available) ======
  try{
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();

    // heartbeat (optional)
    db.ref("/system/lastDataRx").on("value", (snap)=>{
      lastSystemRx = snap.val() || 0;
    });

    // subscribe each person
    PEOPLE.forEach(p=>{
      const key = p.firebaseKey;

      db.ref("/beacons/" + key).on("value", (snap)=>{
        const val = snap.val() || {};
        live[key] = live[key] || {};

        const newRoom = (val.room || "").trim();
        const oldRoom = (prevRoom[key] || "").trim();

        live[key].room = newRoom;
        live[key].entered_at = val.entered_at || 0;
        live[key].last_seen = val.last_seen || 0;

        // ‚úÖ Log ONLY when room actually changes (or first time we get a room)
        if(newRoom && newRoom !== oldRoom){
          addEvent(key, "Room update ‚Äî " + newRoom);
          prevRoom[key] = newRoom;
        }else if(!oldRoom && newRoom){
          addEvent(key, "Room update ‚Äî " + newRoom);
          prevRoom[key] = newRoom;
        }

        firebaseOk = true;
        demoMode = false;

        renderAll();
        evaluateAlarmNow();
        refreshBanner();
      });

      db.ref("/alerts/" + key).on("value", (snap)=>{
        const val = snap.val() || {};
        live[key] = live[key] || {};
        live[key].alerts = val || {};

        const newSOS = (live[key].alerts && live[key].alerts.sos === true);
        const oldSOS = (prevSOS[key] === true);

        // ‚úÖ Log ONLY on SOS transitions
        if(newSOS !== oldSOS){
          addEvent(key, newSOS ? "Emergency alert ‚Äî SOS active" : "Emergency cleared ‚Äî SOS off");
          prevSOS[key] = newSOS;
        }

        firebaseOk = true;
        demoMode = false;

        renderAll();
        evaluateAlarmNow();
        refreshBanner();
      });
    });

  }catch(e){
    // Firebase not available -> demo mode
    demoMode = true;
    firebaseOk = false;
    ensureDemoSeed();
  }

  // Initial
  ensureDemoSeed();
  renderAll();
  tick();
  setInterval(tick, 1000);

})();</script>

</body>
</html>
